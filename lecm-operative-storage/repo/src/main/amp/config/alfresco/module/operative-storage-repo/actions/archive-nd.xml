<?xml version='1.0' encoding='UTF-8' ?>
<items>
    <item name="cm:Передача номенклатурного дела в архив" type="lecm-group-actions:script-action">
        <property name="cm:name">
            <![CDATA[Передача номенклатурного дела в архив]]>
        </property>
        <property name="cm:title">
            <![CDATA[Передача номенклатурного дела в архив]]>
        </property>
        <property name="lecm-group-actions:statuses">
            <![CDATA[]]>
        </property>
        <property name="lecm-group-actions:type">
            <![CDATA[lecm-os:nomenclature-case]]>
        </property>
        <property name="lecm-group-actions:order">
            <![CDATA[0]]>
        </property>
        <property name="lecm-group-actions:expression">
            <![CDATA[doc.attr("lecm-os:nomenclature-case-to-archive") == true AND doc.attr("lecm-os:nomenclature-case-status") == "CLOSED"]]>
        </property>
        <property name="lecm-group-actions:isGroup">
            <![CDATA[true]]>
        </property>
        <property name="lecm-group-actions:forCollection">
            <![CDATA[false]]>
        </property>
        <property name="lecm-group-actions:script">
            <![CDATA[if(!document.properties["lecm-os:nomenclature-case-no-permissions-change-on-archivation"]){
	document.properties["lecm-os:shared"] = true;
  	operativeStorage.cleanVisibilityList(document.nodeRef);
	operativeStorage.grantAll(document.nodeRef);
}

document.properties["lecm-os:nomenclature-case-status"] = "ARCHIVE";

var caseDocuments = document.childrenByXPath("*//.[subtypeOf('lecm-document:base')]");

for(var i = 0; i < caseDocuments.length; i++) {
  var doc = caseDocuments[i];
  doc.properties["lecm-statemachine:status"] = "В архиве";
  doc.save();
}

operativeStorage.grantAccessToAllArchivhists(document.nodeRef);
document.save();]]>
        </property>
    </item>
</items>
