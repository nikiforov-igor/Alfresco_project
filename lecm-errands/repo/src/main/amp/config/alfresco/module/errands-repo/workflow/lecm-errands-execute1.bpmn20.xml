<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:activiti="http://activiti.org/bpmn"
             typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://www.it.ru/logicECM/errands/workflow/execute_1/1.0">
    <process id="errandsExecute_1" name="Исполнить поручение(1)">
        <startEvent id="startExecute" name="Start" activiti:formKey="lecmErrandWf:execute_1"></startEvent>
        <endEvent id="endExecute" name="End"></endEvent>
        <scriptTask id="executeErrand" name="Errand execute" scriptFormat="javascript">
            <extensionElements>
                <activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
                    <activiti:field name="script">
                        <activiti:string><![CDATA[
                        <import resource="classpath:/alfresco/module/errands-repo/workflow/scripts/errands-execute-errand-script.js">
                            var document = bpm_package.children[0];
                            if (document) {
                                var reportStatus = document.properties["lecm-errands-ts:execution-report-status"];
                                var reportText = execution.getVariable("lecmErrandWf_execute_1ReportText");
                                var isExecute = lecmErrandWf_execute_1Execute;
                                var closeChild = lecmErrandWf_execute_1CloseChild;

                                document.properties["lecm-errands:execution-report"] = reportText;
                                document.save();

                                var attachments = [];
                                var attachmentsList = execution.getVariable("lecmErrandWf_execute_1Attachment")
                                if (attachmentsList && attachmentsList.size()) {
                                    for (var i = 0; i < attachmentsList.size(); i++){
                                        attachments.push(attachmentsList.get(i));
                                    }
                                }
                                var reportAttachments = document.assocs["lecm-errands:execution-report-attachment-assoc"];
                                var totalNewAttachments = [];
                                var totalRemovedAttachments = [];

                                if (attachments) {
                                    if (reportAttachments && reportAttachments.length) {
                                        totalNewAttachments = attachments.filter(function(attachment) {
                                            for (var i = 0; i < reportAttachments.length; i++) {
                                                if (attachment.nodeRef.equals(reportAttachments[i].nodeRef)) {
                                                    return false;
                                                }
                                            }
                                            return true;
                                        });
                                        totalRemovedAttachments = reportAttachments.filter(function(attachment) {
                                            for (var i = 0; i < attachments.length; i++) {
                                                if (attachment.nodeRef.equals(attachments[i].nodeRef)) {
                                                    return false;
                                                }
                                            }
                                            return true;
                                        });
                                    } else {
                                        totalNewAttachments = attachments;
                                    }
                                } else {
                                    if (reportAttachments && reportAttachments.length) {
                                        totalRemovedAttachments = reportAttachments;
                                    }
                                }
                                totalNewAttachments.forEach(function(attachment) {
                                    document.createAssociation(attachment, "lecm-errands:execution-report-attachment-assoc");
                                });
                                totalRemovedAttachments.forEach(function(attachment) {
                                    document.removeAssociation(attachment, "lecm-errands:execution-report-attachment-assoc");
                                });

                                var connectedDocuments = [];
                                var connectedDocumentsList = execution.getVariable("lecmErrandWf_execute_1ConnectedDocument")
                                if (connectedDocumentsList && connectedDocumentsList.size()) {
                                    for (var i = 0; i < connectedDocumentsList.size(); i++) {
                                        connectedDocuments.push(connectedDocumentsList.get(i));
                                    }
                                }
                                var reportConnectedDocs = document.assocs["lecm-errands:execution-connected-document-assoc"];
                                var totalNewConnectedDocs = [];
                                var totalRemovedConnectedDocs = [];
                                if (connectedDocuments) {
                                    if (reportConnectedDocs && reportConnectedDocs.length) {
                                        totalNewConnectedDocs = connectedDocuments.filter(function(doc) {
                                            for (var i = 0; i < reportConnectedDocs.length; i++) {
                                                if (doc.nodeRef.equals(reportConnectedDocs[i].nodeRef)) {
                                                    return false;
                                                }
                                            }
                                            return true;
                                        });
                                        totalRemovedConnectedDocs = reportConnectedDocs.filter(function(doc) {
                                            for (var i = 0; i < connectedDocuments.length; i++) {
                                                if (doc.nodeRef.equals(connectedDocuments[i].nodeRef)) {
                                                    return false;
                                                }
                                            }
                                            return true;
                                        });
                                    } else {
                                        totalNewConnectedDocs = connectedDocuments;
                                    }
                                } else {
                                    if (reportConnectedDocs && reportConnectedDocs.length) {
                                        totalRemovedConnectedDocs = reportConnectedDocs;
                                    }
                                }
                                totalNewConnectedDocs.forEach(function(doc) {
                                    document.createAssociation(doc, "lecm-errands:execution-connected-document-assoc");
                                });
                                totalRemovedConnectedDocs.forEach(function(doc) {
                                    document.removeAssociation(doc, "lecm-errands:execution-connected-document-assoc");
                                });

                                if (!isExecute) {
                                    document.properties["lecm-errands:execution-report-status"] = "PROJECT";
                                } else {
      	                            document.properties["lecm-errands:execution-report-is-execute"] = true;
                                }
                                document.save();
                            }
                        ]]></activiti:string>
                    </activiti:field>
                </activiti:executionListener>
            </extensionElements>
            <script>var test=1;</script>
        </scriptTask>
        <receiveTask id="errandReceiveTask" name="Receive Task"></receiveTask>
        <sequenceFlow id="flow1" name="" sourceRef="startExecute" targetRef="executeErrand"></sequenceFlow>
        <sequenceFlow id="flow2" name="" sourceRef="executeErrand" targetRef="errandReceiveTask"></sequenceFlow>
        <sequenceFlow id="flow3" name="" sourceRef="errandReceiveTask" targetRef="endExecute"></sequenceFlow>
    </process>
</definitions>
