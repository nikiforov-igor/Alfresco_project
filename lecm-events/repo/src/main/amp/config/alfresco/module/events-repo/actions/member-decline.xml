<?xml version='1.0' encoding='UTF-8'?>
<items updateMode="CreateOrUpdate">
    <item name="cm:Мероприятия. Отклонить приглашение" type="lecm-group-actions:script-action">
        <property name="lecm-group-actions:expression">
            <![CDATA[(user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "EVENTS_MEMBER_DYN")) AND ("EMPTY".equals(@eventsService.getCurrentEmployeeMemberStatus(doc.getNodeRef())) OR "CONFIRMED".equals(@eventsService.getCurrentEmployeeMemberStatus(doc.getNodeRef()))) AND doc.attr("lecm-events:removed") == false AND doc.attr("lecm-events:not-send-invitation") != true]]></property>
        <property name="cm:name"><![CDATA[Мероприятия. Отклонить приглашение]]></property>
        <property name="lecm-group-actions:statuses"><![CDATA[]]></property>
        <property name="lecm-group-actions:isGroup"><![CDATA[false]]></property>
        <property name="lecm-group-actions:forCollection"><![CDATA[false]]></property>
        <property name="lecm-group-actions:script"><![CDATA[ if (document) {
   var currentEmployee = orgstructure.getCurrentEmployee();
   var memberRow = events.getEmployeeEventMemberRow(document.nodeRef.toString(), currentEmployee.nodeRef.toString());
   lecmPermission.pushAuthentication();
   lecmPermission.setRunAsUserSystem();
   if (memberRow) {
     memberRow.properties["lecm-events-ts:members-status"] = "DECLINED";
     memberRow.properties["lecm-events-ts:members-decline-reason"] = memberDeclineReason;
     memberRow.save();
   }

   var repeatableEvents = events.getRepetableEvents(document, "ALL");
   if (repeatableEvents) {
     for (var i = 0; i < repeatableEvents.length; i++) {
       memberRow = events.getEmployeeEventMemberRow(repeatableEvents[i].nodeRef.toString(), currentEmployee.nodeRef.toString());
       if (memberRow) {
         memberRow.properties["lecm-events-ts:members-status"] = "DECLINED";
         memberRow.properties["lecm-events-ts:members-decline-reason"] = memberDeclineReason;
         memberRow.save();
       }
     }
   }
    lecmPermission.popAuthentication();

   var initiator = document.assocs["lecm-events:initiator-assoc"][0];

   if (currentEmployee && initiator) {
     notifications.sendNotificationFromCurrentUser({
       recipients: [initiator],
       templateCode: 'EVENTS.INVITATION_DECLINE',
       templateConfig: {
         mainObject: document,
         eventExecutor: currentEmployee
       }
     });
   }
}]]></property>
        <property name="lecm-group-actions:order"><![CDATA[0]]></property>
        <property name="cm:title"><![CDATA[Отклонить приглашение]]></property>
        <property name="lecm-group-actions:type"><![CDATA[[lecm-events:document]]]></property>
        <property name="lecm-group-actions:availableForReader"><![CDATA[true]]></property>
        <items>
            <item name="cm:Причина отказа" type="lecm-group-actions:form-field">
                <property name="lecm-group-actions:field-control">
                    <![CDATA[{
                        "template":"/ru/it/lecm/base-share/components/controls/textarea.ftl",
                        "id":"d:text-textarea",
                        "params":[
                            {"name":"rows","value":"7"}
                        ]
                    }]]></property>
                <property name="lecm-group-actions:field-is-mandatory"><![CDATA[true]]></property>
                <property name="lecm-group-actions:field-type"><![CDATA[d:text]]></property>
                <property name="cm:name"><![CDATA[Причина отказа]]></property>
                <property name="lecm-group-actions:field-id"><![CDATA[memberDeclineReason]]></property>
                <property name="lecm-group-actions:field-priority"><![CDATA[0]]></property>
                <property name="lecm-group-actions:field-default-value"><![CDATA[]]></property>
            </item>
        </items>
    </item>
</items>