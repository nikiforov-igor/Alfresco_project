(function(){var m=$.fullCalendar,l=m.formatDate,r=m.parseISO8601,f=m.addDays,b=m.applyAll,g=Alfresco.util.fromISO8601,i=Alfresco.util.toISO8601,o=Alfresco.thirdparty.dateFormat,c=YAHOO.util.History,h="";YAHOO.lang.augmentObject(Alfresco.CalendarView.prototype,{getFullCalendarViewType:function n(s){switch(s){case Alfresco.CalendarView.VIEWTYPE_DAY:return this.options.fcOpts.dayView;case Alfresco.CalendarView.VIEWTYPE_WEEK:return this.options.fcOpts.weekView;case Alfresco.CalendarView.VIEWTYPE_MONTH:return this.options.fcOpts.monthView}},renderEvents:function p(){var B=c.getBookmarkedState("view")||this.options.view,x=c.getBookmarkedState("date")||o(this.options.startDate,"yyyy-mm-dd");c.register("view",B,function y(E){this.onViewNav(E)},{},this);c.register("date",x,function w(E){this.onDateNav(E)},{},this);try{c.initialize("yui-history-field","yui-history-iframe")}catch(z){Alfresco.logger.error("Alfresco.CalendarView: Couldn't initialize HistoryManager.",z)}h=$("#"+this.options.id);this.initFullCalendar();YAHOO.Bubbling.on("eventEdited",this.onEventEdited,this);YAHOO.Bubbling.on("eventSaved",this.onEventSaved,this);YAHOO.Bubbling.on("eventDeleted",this.onEventDeleted,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);YAHOO.Bubbling.on("todayNav",function t(){h.fullCalendar("today")},this);YAHOO.Bubbling.on("nextNav",function A(){h.fullCalendar("next")},this);YAHOO.Bubbling.on("prevNav",function D(){h.fullCalendar("prev")},this);YAHOO.Bubbling.on("toggleWorkHours",this.onToggleWorkHours,this);YAHOO.Bubbling.on("viewChanged",function v(G,F){var E=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarToolbar").enabledViews[F[1].activeView];if(E===Alfresco.CalendarView.VIEWTYPE_AGENDA){this.onViewChanged.apply(this,arguments)}else{c.navigate("view",E)}},this);YAHOO.Bubbling.on("dateChanged",function u(F,E){c.navigate("date",o(E[1].date,"yyyy-mm-dd"))},this);var C=Alfresco.widget.Resizer.prototype.onResizeNotification;Alfresco.widget.Resizer.prototype.onResizeNotification=function s(){C();h.fullCalendar("render")}},initFullCalendar:function d(){var t=g(c.getBookmarkedState("date"))||this.options.startDate,s=c.getBookmarkedState("view")||this.options.view;var u=this;$(document).ready(function(){if(u.options.permitToCreateEvents){h.addClass("calendar-editable")}h.fullCalendar({defaultView:u.getFullCalendarViewType(s),date:t.getDate(),month:t.getMonth(),year:t.getFullYear(),weekMode:u.options.fcOpts.weekMode,weekends:u.options.fcOpts.weekends,allDaySlot:u.options.fcOpts.allDaySlot,firstDay:u.options.fcOpts.firstDay,firstHour:u.options.fcOpts.firstHour,minTime:(u.options.fcOpts.showWorkHours)?u.options.fcOpts.minTimeWorkHours:u.options.fcOpts.minTimeToggle,maxTime:(u.options.fcOpts.showWorkHours)?u.options.fcOpts.maxTimeWorkHours:u.options.fcOpts.maxTimeToggle,aspectRatio:u.options.fcOpts.aspectRatio,slotMinutes:u.options.fcOpts.slotMinutes,disableDragging:u.options.fcOpts.disableDragging,disableResizing:u.options.fcOpts.disableResizing,height:2000,ignoreTimezone:false,monthNames:u.msg("months.long").split(","),monthNamesShort:u.msg("months.short").split(","),dayNames:u.msg("days.long").split(","),dayNamesShort:u.msg("days.medium").split(","),buttonText:{month:u.msg("label.month"),week:u.msg("label.week"),day:u.msg("label.day")},allDayText:u.msg("label.all-day"),timeFormat:{month:u.msg("fullCalendar.timeFormat.month"),week:u.msg("fullCalendar.timeFormat.week"),day:u.msg("fullCalendar.timeFormat.day")},columnFormat:{month:u.msg("fullCalendar.columnFormat.month"),week:u.msg("fullCalendar.columnFormat.week"),day:u.msg("fullCalendar.columnFormat.day")},titleFormat:{month:u.msg("fullCalendar.titleFormat.month"),week:u.msg("fullCalendar.titleFormat.week"),day:u.msg("fullCalendar.titleFormat.day")},axisFormat:u.msg("fullCalendar.axisFormat"),header:{left:"title",center:"",right:""},editable:u.options.permitToCreateEvents,eventSources:[{url:Alfresco.constants.PROXY_URI+"calendar/events/"+u.options.siteId+"/user?repeating=all",startParam:"from",startParamFn:function(B){return i(B).split("T")[0]},endParam:"to",endParamFn:function(B){return i(B).split("T")[0]},success:function(D){var B=[];if(D.events){var C=u.tagFilter(D.events);YAHOO.Bubbling.fire("eventDataLoad",C);$.each(C,function(E,F){B.push(YAHOO.lang.augmentObject({id:F.name,start:r(F.startAt.iso8601),end:r(F.endAt.iso8601),allDay:(F.allday==="true")?true:false,location:F.where,uri:"/calendar/event/"+u.options.siteId+"/"+F.name+"?date="+F.startAt.iso8601.split("T")[0]},F))})}return B}}],eventClick:function w(D,C,B){u.showDialog(C,D);return false},eventDrop:function z(G,E,D,F,C,H,B){u.updateEvent(G,E,D,F,C,H,B)},eventResize:function v(G,E,D,F,C,H,B){u.updateEvent(G,E,D,F,C,H,B)},viewDisplay:function y(B){if(B.name===u.options.fcOpts.monthView){h.fullCalendar("option","height",null)}},dayClick:function A(D,E,C,B){if(u.options.permitToCreateEvents){u.showAddDialog(D)}},afterEventChange:function x(E){var D=h.fullCalendar("clientEvents",E);for(var C=0;C<D.length;C++){var F=D[C],B=i(F.start),G=i(F.end)||B;F.startAt={iso8601:B};F.endAt={iso8601:G}}}})})},getEvents:function j(){h.fullCalendar("refetchEvents")},updateEvent:function k(s,u,x,w,y,z,A){var v=s.end||s.start,t={desc:s.description,docfolder:s.docfolder||"",startAt:{iso8601:s.start},endAt:{iso8601:v},page:Alfresco.constants.PAGEID,site:Alfresco.constants.SITE,tags:(s.tags)?s.tags.join():"",what:s.title,where:s.where};if(s.allDay){t.allday="true"}Alfresco.util.Ajax.jsonPut({url:Alfresco.constants.PROXY_URI+"calendar/event/"+Alfresco.constants.SITE+"/"+s.name,dataObj:t,failureCallback:{fn:w}})},onDateNav:function q(s){if(typeof(s)==="string"){s=g(s)}h.fullCalendar("gotoDate",s)},onViewNav:function e(s){h.fullCalendar("changeView",this.getFullCalendarViewType(s))},onToggleWorkHours:function a(){h.fullCalendar("destroy");this.options.fcOpts.showWorkHours=(this.options.fcOpts.showWorkHours)?false:true;this.initFullCalendar()}},true)})();