<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.it.ru/logicECM/workflow/approval">
	<process id="lecmApprovalWorkflow" name="Согласование устаревшее" isExecutable="true">
		<extensionElements>
			<activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var finalDecision = execution.getVariable("finalDecision");
						var isApproved = execution.getVariable("isApproved");
						var isApprovedValue = Packages.java.lang.Boolean.TRUE.equals(isApproved);
						if (!finalDecision && isApproved != null) {
							finalDecision = isApprovedValue ? "APPROVED_FORCE" : "REJECTED_FORCE";
							var resultListRef = execution.getVariable("resultListRef");
							approvalWorkflow.logFinalDecision(resultListRef, finalDecision);
						}
						approvalWorkflow.deleteTempAssigneesList(execution);
						approvalWorkflow.saveRouteApprovalResult(bpm_package, isApprovedValue);
					]]></activiti:string>
				</activiti:field>
			</activiti:executionListener>
		</extensionElements>
		<startEvent id="start-approvement" name="Start approvement" activiti:formKey="lecmApprove2:approval"></startEvent>
		<serviceTask id="empty-service-task" name="Service task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
					var emptyServiceTask="Service task";
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="flow1" sourceRef="start-approvement" targetRef="empty-service-task"></sequenceFlow>
		<receiveTask id="receivetask" name="Receive Task"></receiveTask>
		<sequenceFlow id="flow2" sourceRef="empty-service-task" targetRef="receivetask"></sequenceFlow>
		<serviceTask id="create-approval-list" name="Create approval list" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var assignees = execution.getVariable("lecm-workflow_assigneesListAssoc");
						var assigneesList = approvalWorkflow.createAssigneesList(assignees, execution);
						execution.setVariableLocal("assigneesList", assigneesList);
						var resultListRef = approvalWorkflow.createApprovalList(bpm_package, documentAttachmentCategoryName, execution.getVariable("lecm-workflow_workflowConcurrency"), assigneesList);
						execution.setVariable("resultListRef", resultListRef);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="flow3" sourceRef="receivetask" targetRef="create-approval-list"></sequenceFlow>
		<sequenceFlow id="flow4" sourceRef="create-approval-list" targetRef="sequential-or-parallel-approval-gate"></sequenceFlow>
		<exclusiveGateway id="sequential-or-parallel-approval-gate" name="Exclusive Gateway"></exclusiveGateway>
		<sequenceFlow id="from-gate-to-sequential" sourceRef="sequential-or-parallel-approval-gate" targetRef="sequential-approvement-task">
			<conditionExpression xsi:type="tFormalExpression">${execution.getVariable("lecm-workflow_workflowConcurrency") == "SEQUENTIAL"}</conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="from-gate-to-parallel" sourceRef="sequential-or-parallel-approval-gate" targetRef="parallel-approvement-task">
			<conditionExpression xsi:type="tFormalExpression">${execution.getVariable("lecm-workflow_workflowConcurrency") == "PARALLEL"}</conditionExpression>
		</sequenceFlow>
		<userTask id="sequential-approvement-task" name="Согласовать документ" activiti:assignee='${assignee.properties["{http://www.it.ru/logicECM/model/workflow/1.0}userName"]}' activiti:formKey="lecmApprove2:approveTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							approvalWorkflow.assignTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							approvalWorkflow.reassignTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							approvalWorkflow.completeTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
			<multiInstanceLoopCharacteristics isSequential="true" activiti:collection="${assigneesList}" activiti:elementVariable="assignee">
				<completionCondition>${"REJECTED" == taskDecision}</completionCondition>
			</multiInstanceLoopCharacteristics>
		</userTask>
		<userTask id="parallel-approvement-task" name="Согласовать документ" activiti:assignee='${assignee.properties["{http://www.it.ru/logicECM/model/workflow/1.0}userName"]}' activiti:formKey="lecmApprove2:approveTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var dueDate = bpm_workflowDueDate;
							task.setDueDate(dueDate);
							approvalWorkflow.assignTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							approvalWorkflow.completeTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
			<multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${assigneesList}" activiti:elementVariable="assignee"></multiInstanceLoopCharacteristics>
		</userTask>
		<boundaryEvent id="sequential-timer" name="Sequential Timer" attachedToRef="sequential-approvement-task" cancelActivity="false">
			<timerEventDefinition>
				<timeCycle>0 0 0/4 * * ?</timeCycle>
			</timerEventDefinition>
		</boundaryEvent>
		<boundaryEvent id="parallel-timer" name="Parallel Timer" attachedToRef="parallel-approvement-task" cancelActivity="false">
			<timerEventDefinition>
				<timeCycle>0 0 0/4 * * ?</timeCycle>
			</timerEventDefinition>
		</boundaryEvent>
		<serviceTask id="sheduled-notification" name="Notify task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var workflowId = "activiti$" + execution.getProcessInstanceId();
						approvalWorkflow.notifyDeadlineTasks(workflowId, bpm_package, execution);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="from-sequential-timer-to-notify" sourceRef="sequential-timer" targetRef="sheduled-notification"></sequenceFlow>
		<sequenceFlow id="from-parallel-timer-to-notify" sourceRef="parallel-timer" targetRef="sheduled-notification"></sequenceFlow>
		<serviceTask id="log-final-decision" name="Log final decision" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var decisionsMap = execution.getVariable("decisionsMap");
						var resultListRef = execution.getVariable("resultListRef");
						if (!decisionsMap) {
							logger.log("Attention: decisionsMap is null!");
						}
						var finalDecision = approvalWorkflow.getFinalDecision(decisionsMap);
						execution.setVariable("finalDecision", finalDecision);
						approvalWorkflow.logFinalDecision(resultListRef, finalDecision);
						approvalWorkflow.notifyFinalDecision(finalDecision, bpm_package)
						execution.setVariable("isApproved", approvalWorkflow.isApproved(finalDecision));
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="from-sequential-to-final" sourceRef="sequential-approvement-task" targetRef="log-final-decision"></sequenceFlow>
		<sequenceFlow id="from-parallel-to-final" sourceRef="parallel-approvement-task" targetRef="log-final-decision"></sequenceFlow>
		<sequenceFlow id="flow5" sourceRef="log-final-decision" targetRef="endevent1"></sequenceFlow>
		<endEvent id="endevent1" name="End"></endEvent>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_lecmApprovalWorkflow">
		<bpmndi:BPMNPlane bpmnElement="lecmApprovalWorkflow" id="BPMNPlane_lecmApprovalWorkflow">
			<bpmndi:BPMNShape bpmnElement="sheduled-notification" id="BPMNShape_sheduled-notification">
				<omgdc:Bounds height="60.0" width="100.0" x="615.0" y="113.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="start-approvement" id="BPMNShape_start-approvement">
				<omgdc:Bounds height="35.0" width="35.0" x="20.0" y="124.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="create-approval-list" id="BPMNShape_create-approval-list">
				<omgdc:Bounds height="60.0" width="100.0" x="380.0" y="113.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="endevent1" id="BPMNShape_endevent1">
				<omgdc:Bounds height="35.0" width="35.0" x="920.0" y="124.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-approvement-task" id="BPMNShape_sequential-approvement-task">
				<omgdc:Bounds height="60.0" width="100.0" x="620.0" y="0.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-or-parallel-approval-gate" id="BPMNShape_sequential-or-parallel-approval-gate">
				<omgdc:Bounds height="40.0" width="40.0" x="530.0" y="122.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="parallel-timer" id="BPMNShape_parallel-timer">
				<omgdc:Bounds height="30.0" width="30.0" x="650.0" y="210.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="parallel-approvement-task" id="BPMNShape_parallel-approvement-task">
				<omgdc:Bounds height="60.0" width="100.0" x="615.0" y="227.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-timer" id="BPMNShape_sequential-timer">
				<omgdc:Bounds height="30.0" width="30.0" x="650.0" y="40.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="log-final-decision" id="BPMNShape_log-final-decision">
				<omgdc:Bounds height="60.0" width="100.0" x="770.0" y="112.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="receivetask" id="BPMNShape_receivetask">
				<omgdc:Bounds height="60.0" width="100.0" x="240.0" y="112.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="empty-service-task" id="BPMNShape_empty-service-task">
				<omgdc:Bounds height="60.0" width="100.0" x="100.0" y="112.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
				<omgdi:waypoint x="340.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="380.0" y="143.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-sequential-to-final" id="BPMNEdge_from-sequential-to-final">
				<omgdi:waypoint x="720.0" y="30.0"></omgdi:waypoint>
				<omgdi:waypoint x="732.0" y="30.0"></omgdi:waypoint>
				<omgdi:waypoint x="732.0" y="141.0"></omgdi:waypoint>
				<omgdi:waypoint x="770.0" y="142.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
				<omgdi:waypoint x="200.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="240.0" y="142.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5">
				<omgdi:waypoint x="870.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="920.0" y="141.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
				<omgdi:waypoint x="480.0" y="143.0"></omgdi:waypoint>
				<omgdi:waypoint x="530.0" y="142.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
				<omgdi:waypoint x="55.0" y="141.0"></omgdi:waypoint>
				<omgdi:waypoint x="100.0" y="142.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-gate-to-sequential" id="BPMNEdge_from-gate-to-sequential">
				<omgdi:waypoint x="570.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="588.0" y="141.0"></omgdi:waypoint>
				<omgdi:waypoint x="588.0" y="37.0"></omgdi:waypoint>
				<omgdi:waypoint x="620.0" y="30.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-sequential-timer-to-notify" id="BPMNEdge_from-sequential-timer-to-notify">
				<omgdi:waypoint x="665.0" y="70.0"></omgdi:waypoint>
				<omgdi:waypoint x="665.0" y="113.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-parallel-to-final" id="BPMNEdge_from-parallel-to-final">
				<omgdi:waypoint x="715.0" y="257.0"></omgdi:waypoint>
				<omgdi:waypoint x="732.0" y="256.0"></omgdi:waypoint>
				<omgdi:waypoint x="732.0" y="141.0"></omgdi:waypoint>
				<omgdi:waypoint x="770.0" y="142.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-parallel-timer-to-notify" id="BPMNEdge_from-parallel-timer-to-notify">
				<omgdi:waypoint x="665.0" y="210.0"></omgdi:waypoint>
				<omgdi:waypoint x="665.0" y="173.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-gate-to-parallel" id="BPMNEdge_from-gate-to-parallel">
				<omgdi:waypoint x="570.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="590.0" y="142.0"></omgdi:waypoint>
				<omgdi:waypoint x="590.0" y="210.0"></omgdi:waypoint>
				<omgdi:waypoint x="590.0" y="253.0"></omgdi:waypoint>
				<omgdi:waypoint x="615.0" y="257.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>
