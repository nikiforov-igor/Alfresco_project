<?xml version='1.0' encoding='UTF-8'?>
<items updateMode="CreateOrUpdate">
    <item name="cm:Мероприятие. Удалить" type="lecm-group-actions:script-action">
        <property name="cm:name"><![CDATA[Мероприятие. Удалить]]></property>
        <property name="lecm-group-actions:statuses"><![CDATA[]]></property>
        <property name="lecm-group-actions:type"><![CDATA[[lecm-events:document]]]></property>
        <property name="lecm-group-actions:order"><![CDATA[0]]></property>
        <property name="lecm-group-actions:expression">
            <![CDATA[(user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "BR_INITIATOR") OR user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "EVENTS_INITIATOR_DYN")) AND doc.attr("lecm-events:repeatable") == false AND doc.attr("lecm-events:removed") == false]]></property>
        <property name="lecm-group-actions:isGroup"><![CDATA[false]]></property>
        <property name="lecm-group-actions:forCollection"><![CDATA[false]]></property>
        <property name="cm:title"><![CDATA[Удалить]]></property>
        <property name="lecm-group-actions:script"><![CDATA[var toDate = document.properties["lecm-events:to-date"];
document.properties["lecm-events:removed"] = true;
document.save();

if (toDate.getTime() >= new Date().getTime()) {
			events.sendCancelNotifications(document);
/*	var currentUser = orgstructure.getCurrentEmployee();
    var members = events.getEventMembers(document);
	var type = document.getTypeShort();
	var objectType="";		
	if (type == "lecm-events:document") {
		objectType +=  "мероприятия ";
	} else if (type == "lecm-meetings:document") {
		objectType +=  "совещания ";
	}
	var notificationText = documentScript.wrapperLink(currentUser, currentUser.properties["lecm-orgstr:employee-short-name"]);
		notificationText +=  " отменил проведение ";
		notificationText +=  objectType;
		notificationText += documentScript.wrapperDocumentLink(document, "{lecm-document:present-string}");
	notifications.sendNotificationFromCurrentUser(members, notificationText, document, true);

  	var invitedMembers = events.getEventInvitedMembers(document);
    var from = currentUser.properties["lecm-orgstr:employee-email"];
    if (from != null && from != "") {
      for each (var member in invitedMembers) {
        var email = member.properties["lecm-representative:email"];
        if (email != null && email != "") {
          var mail = actions.create("mail");
          mail.parameters.to = email;
          var subjectText = "Отмена проведения "
			subjectText += objectType;
		  mail.parameters.subject = subjectText;
          mail.parameters.from = from;
		  var text = "<html><body>Уважаемые коллеги!<br/>" + documentScript.wrapperLink(currentUser, currentUser.properties["lecm-orgstr:employee-short-name"]);
	      text +=  " отменил проведение ";
		  text += objectType;
		  text += documentScript.wrapperDocumentLink(document, document.properties["lecm-document:present-string"]);
		  text += "</body></html>";
          mail.parameters.html = text;
          mail.parameters.send_after_commit = true;
          try {
          	mail.execute(document);
          } catch(e) {}
        }
      }
    }*/
	
}]]></property>
    </item>
</items>