<?xml version='1.0' encoding='UTF-8'?>
<items updateMode="CreateOrUpdate">
    <item name="cm:Отозвать с ознакомления" type="lecm-group-actions:script-action">
        <property name="lecm-group-actions:expression"><![CDATA[doc.hasAspect('lecm-review-ts:review-aspect')  AND @reviewService.canCancelReview(doc.nodeRef)]]></property>
        <property name="cm:name"><![CDATA[Отозвать с ознакомления]]></property>
        <property name="lecm-group-actions:statuses"><![CDATA[]]></property>
        <property name="lecm-group-actions:isGroup"><![CDATA[false]]></property>
        <property name="lecm-group-actions:forCollection"><![CDATA[false]]></property>
        <property name="lecm-group-actions:script"><![CDATA[(function() {
  var initiator = orgstructure.getCurrentEmployee();

  var notificationText = 'Ознакомление по документу '; 
  notificationText += documentScript.wrapperDocumentLink(document, documentScript.getPresentString(document));
  notificationText += ' отозвано!';

  var recipients = [];
  var reviewTable = document.associations['lecm-review-ts:review-table-assoc'];
  if (null != reviewTable) {
    var reviewTableData = documentTables.getTableDataRows((reviewTable[0]).nodeRef.toString());
    for each (var row in reviewTableData) {
      	var reviewer = row.associations['lecm-review-ts:reviewer-assoc'][0];
        var itemInitiator = row.assocs["lecm-review-ts:initiator-assoc"];
        if (itemInitiator!=null && itemInitiator.length>0 && initiator.nodeRef.toString().equals(itemInitiator[0].nodeRef.toString())) {
            if (row.properties['lecm-review-ts:review-state'] == 'NOT_REVIEWED') {
                recipients.push(reviewer);
              	row.properties['lecm-review-ts:review-state'] = 'CANCELLED';
              	row.properties['lecm-review-ts:review-finish-date'] = new Date();
              	row.save();
            }
        }
    }
  }
  notifications.sendNotificationFromCurrentUser(recipients, notificationText, document);
  
  
})();]]></property>
        <property name="lecm-group-actions:order"><![CDATA[0]]></property>
        <property name="cm:title"><![CDATA[Отозвать с ознакомления]]></property>
        <property name="lecm-group-actions:availableForReader"><![CDATA[false]]></property>
    </item>
</items>