<?xml version="1.0" encoding="UTF-8"?>
<ds.config>
    <report.descriptor mnem="exec-doc-tree">
        <l18>
            <item key="RU_RU" value="Дерево поручений документа"/>
        </l18>
        <provider javaClass="ru.it.lecm.reports.generators.GenericDSProviderBase" mnem="PROV_GENERIC_PROVIDER">
            <l18>
                <item key="RU_RU"><![CDATA[genericProvider]]></item>
            </l18>
        </provider>
        <templates>
            <template type="JASPER" filename="exec-doc-tree_tmpl.jrxml" mnem="tmpl">
                <l18>
                    <item key="RU_RU" value="exec-doc-tree"/>
                </l18>
            </template>
        </templates>
        <roles>ERRANDS_INITIATOR,ERRANDS_EXECUTOR,ERRANDS_CONTROLLER,ERRANDS_COEXECUTOR,ERRANDS_READER,ERRANDS_CURATOR,ERRANDS_CHOOSING_INITIATOR</roles>
    </report.descriptor>

	<query.descriptor>
		<offset>0</offset>
		<limit>-1</limit>
		<pgsize>-1</pgsize>
		<queryText><![CDATA[+TYPE:"lecm-document:base"]]></queryText>
		<allVersions>true</allVersions>
		<preferedType>lecm-errands:document</preferedType>
		<isMultiRow>true</isMultiRow>
		<isCustom>false</isCustom>
	</query.descriptor>

	<!--
		formats: Формат для вывода информации по поручению.

		Пример форматной строки:

		[CDATA[{lecm-additional-document:additionalDocumentType/cm:name} <i>№{lecm-additional-document:number}</i> от {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:dateConclusionContracts} с {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:partner-assoc/lecm-contractor:shortname}
		]]
		детально:
		[CDATA[
				{lecm-additional-document:additionalDocumentType/cm:name}
				<i>№{lecm-additional-document:number}</i>
				от {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:dateConclusionContracts}
				с {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:partner-assoc/lecm-contractor:shortname}
		]]
		будет формировать для каждой выходной строки:
			<Название_документа> №<Номер> от <ДатаСоглОсновногоДокумента> с <НазваниеОгранизацииПартнёра>
			
		+ макросы в виде @Макрос. Доступные макросы:
			@levelTab  отступ данного уровня (каждый уровень по-умолчанию вносит одну табуляцию)
						(см также формат уровня levelShift)
		
	  -->
	<!--<tree.formats>
		<map>
			&lt;!&ndash; На каждом уровне вложенности поручения добавляется этот отступ &ndash;&gt;
			<item key="levelShift" value="\t" />
			<item key="cycleMarker" value="*" />

			&lt;!&ndash; Сейчас выводимые данные форматируются по типу Альфреско - как положено в SubstitudeBean.getObjectDescription &ndash;&gt;
			&lt;!&ndash; формат выводимой строки для Поручения (отсносительно Поручения)
			<item key="fmtErrandReport">
				<![CDATA[@levelTab {"lecm-errands:title"} {"lecm-errands:is-important"} от {cm:created}, Инициатор {lecm-errands:initiator-assoc/cm:name}]]>
			</item>
			&ndash;&gt;

		</map>
	</tree.formats>-->

	<!-- ассоциации для получения следующего уровня вложенности Поручений:
		level.1: относительно документа "cm:document" (нулевой уровень)
		level.2: относительно Поручения первого уровня
		и т.д. 
		Если уровень явно не указан, то используется последний родительский (ближайший сверху).
	
	  -->
	<!--<tree.levelAssoc>
		<map>
			&lt;!&ndash; Ссылка из Поручения на Основание (документ или поручение), если есть (M1 от поручения к родителю)
				target: lecm-document:base
			  &ndash;&gt;
			<item key="level.1">
				<![CDATA[lecm-errands:additional-document-assoc]]>
			</item>
		</map>
	</tree.levelAssoc>-->

	<fields>
        <!-- Параметры -->
        <field alfrescoType="lecm-document:base" order="0" displayName="Выбранные документы"
				javaValueClass="java.lang.String" jrFldName="ID">
            <l18>
                <item key="RU_RU" value="Выбранные документы"/>
            </l18>
            <parameter mnem="PARAM_TYPE_LIST" paramType="PARAM_TYPE_LIST">
                <l18> <item key="RU_RU" value="Список"/> </l18>
            </parameter>
        </field>

        <!-- Подменяем тип документов - ищем любые документы -->
        <field queryFldName="lecm-document:base" jrFldName="TYPE" displayName="Тип" javaValueClass="java.lang.String"/>

        <!-- Поля -->
		<field alfrescoType="d:text" displayName="Название"
				jrFldName="Col_DisplayName" queryFldName="{lecm-document:present-string}">
			<l18>
				<item key="RU_RU" value="Название"/>
			</l18>
		</field>

        <field alfrescoType="d:text" displayName="Дочерние поручения"
               javaValueClass="java.util.List" jrFldName="Doc_Errands" queryFldName="{{subreport::Doc_Errands}}">
            <l18>
                <item key="RU_RU"><![CDATA[Этапы]]></item>
            </l18>
        </field>
	</fields>

    <subreports>
        <subreport destColumnName="Doc_Errands" name="Doc_Errands">
            <sublist.source><![CDATA[{..lecm-errands:additional-document-assoc/}]]></sublist.source>
            <sublist.type><![CDATA[lecm-errands:document]]></sublist.type>
            <sublist.item>
                <map>
                    <item key="col_Name"><![CDATA[{lecm-document:present-string}]]></item>
                    <item key="*col_SubErrands"><![CDATA[{..lecm-errands:additional-document-assoc/}]]></item>
                </map>
            </sublist.item>
        </subreport>
    </subreports>
</ds.config>
