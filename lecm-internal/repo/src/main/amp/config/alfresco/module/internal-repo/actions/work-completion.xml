<?xml version='1.0' encoding='UTF-8'?>
<items updateMode="CreateOrUpdate">
    <item name="cm:Внутренние. Завершить работу" type="lecm-group-actions:script-action">
        <property name="lecm-group-actions:expression">
            <![CDATA[user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "BR_INITIATOR") OR user.currentUser().hasBusinessRole("DA_REGISTRAR_DYN") OR user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "DA_RECIPIENT_DYN")]]></property>
        <property name="cm:name"><![CDATA[Внутренние. Завершить работу]]></property>
        <property name="lecm-group-actions:statuses"><![CDATA[Направлен]]></property>
        <property name="lecm-group-actions:isGroup"><![CDATA[false]]></property>
        <property name="lecm-group-actions:forCollection"><![CDATA[false]]></property>
        <property name="lecm-group-actions:script"><![CDATA[ (function(){

    var units = [];

    var author = stm_document.assocs["lecm-document:author-assoc"][0];
    var primaryUnit = orgstructure.getPrimaryOrgUnit(author);
	if(primaryUnit) {
        units.push(primaryUnit)
    }

    var recipients = stm_document.assocs["lecm-eds-document:recipients-assoc"];
    var additionalUnits = [];
    for each (var recipient in recipients) {
        var unit = orgstructure.getPrimaryOrgUnit(recipient);
        units.push(unit);
    }

    operativeStorage.moveToNomenclatureCase(stm_document, units);

    /* Выставляем права на ответы */
    var answersTable = stm_document.assocs["lecm-internal-table-structure:answers-assoc"][0];
    var answers = answersTable.getChildren();
    for each (var answer in answers) {
        var employee = answer.assocs["lecm-internal-table-structure:employee-assoc"][0];
        var unit = orgstructure.getPrimaryOrgUnit(employee);
        if (primaryUnit != null) {
            var initiatorAuthority = orgstructure.getOrgstructureUnitAuthority(primaryUnit, false); 
            answer.setPermission("LECM_BASIC_PG_Reader", initiatorAuthority);
        }
        if (unit != null) {
            var recipientAuthority = orgstructure.getOrgstructureUnitAuthority(unit, false);
            answer.setPermission("LECM_BASIC_PG_Reader", recipientAuthority);
        }
    }
})();]]></property>
        <property name="lecm-group-actions:order"><![CDATA[0]]></property>
        <property name="cm:title"><![CDATA[Завершить работу]]></property>
        <property name="lecm-group-actions:type"><![CDATA[[lecm-events:document]]]></property>
        <property name="lecm-group-actions:availableForReader"><![CDATA[true]]></property>
        <items>
            <item name="cm:Причина" type="lecm-group-actions:form-field">
                <property name="lecm-group-actions:field-control">
                    <![CDATA[{
                        "template":"/ru/it/lecm/base-share/components/controls/textarea.ftl",
                        "id":"d:text-textarea",
                        "params":[
                            {"name":"rows","value":"7"}
                        ]
                    }]]></property>
                <property name="lecm-group-actions:field-is-mandatory"><![CDATA[true]]></property>
                <property name="lecm-group-actions:field-type"><![CDATA[d:text]]></property>
                <property name="cm:name"><![CDATA[Причина]]></property>
                <property name="lecm-group-actions:field-id"><![CDATA[completionReason]]></property>
                <property name="lecm-group-actions:field-priority"><![CDATA[0]]></property>
                <property name="lecm-group-actions:field-default-value"><![CDATA[]]></property>
            </item>
        </items>
    </item>
</items>