<?xml version='1.0' encoding='UTF-8'?>
<items updateMode="CreateOrUpdate">
    <item name="cm:Мероприятия. Предложить другое время" type="lecm-group-actions:script-action">
        <property name="lecm-group-actions:expression">
            <![CDATA[user.currentUser().hasDynamicBusinessRole(doc.getNodeRef(), "EVENTS_MEMBER_DYN") AND "EMPTY".equals(@eventsService.getCurrentEmployeeMemberStatus(doc.getNodeRef())) AND doc.attr("lecm-events:removed") == false AND doc.attr("lecm-events:not-send-invitation") != true]]></property>
        <property name="cm:name"><![CDATA[Мероприятия. Предложить другое время]]></property>
        <property name="lecm-group-actions:statuses"><![CDATA[]]></property>
        <property name="lecm-group-actions:isGroup"><![CDATA[false]]></property>
        <property name="lecm-group-actions:forCollection"><![CDATA[false]]></property>
        <property name="lecm-group-actions:script"><![CDATA[if (document) {
  var memberRow = events.getCurrentEmployeeEventMemberRow(document);
  if (memberRow) {
    memberRow.properties["lecm-events-ts:members-status"] = "REQUEST_NEW_TIME";
    memberRow.properties["lecm-events-ts:members-from-date"] = requestNewTimeFromDate;
    memberRow.save();
  }

  var repeatableEvents = events.getRepetableEvents(document, "ALL");
  if (repeatableEvents) {
    for (var i = 0; i < repeatableEvents.length; i++) {
      memberRow = events.getCurrentEmployeeEventMemberRow(repeatableEvents[i]);
      if (memberRow) {
        memberRow.properties["lecm-events-ts:members-status"] = "REQUEST_NEW_TIME";
        memberRow.properties["lecm-events-ts:members-from-date"] = requestNewTimeFromDate;
        memberRow.save();
      }
    }
  }

  var currentEmployee = orgstructure.getCurrentEmployee();
  var initiator = document.assocs["lecm-events:initiator-assoc"][0];

  if (currentEmployee && initiator) {
    var date = new java.util.Date(utils.fromISO8601(requestNewTimeFromDate).getTime());

    notifications.sendNotificationFromCurrentUser({
      recipients: [initiator],
      templateCode: 'EVENTS.PROPOSE_TO_POSTPONE',
      templateConfig: {
        mainObject: document,
        eventExecutor: currentEmployee,
        newDate: date
      }
    });
  }
}]]></property>
        <property name="lecm-group-actions:order"><![CDATA[0]]></property>
        <property name="cm:title"><![CDATA[Предложить другое время]]></property>
        <property name="lecm-group-actions:type"><![CDATA[[lecm-events:document]]]></property>
        <property name="lecm-group-actions:availableForReader"><![CDATA[true]]></property>
        <items>
            <item name="cm:Дата начала мероприятия" type="lecm-group-actions:form-field">
                <property name="lecm-group-actions:field-control">
                    <![CDATA[{
                        "template":"/ru/it/lecm/base-share/components/controls/date.ftl",
                        "id":"datetime-control",
                        "params":[
                            {"name":"minLimitCurrentDate","value":"true"},
                            {"name":"showTime","value":"true"},
                            {"name":"defaultScriptURL","value":"lecm/node/getDateProperty?property=lecm-events:from-date"}
                        ]
                    }]]></property>
                <property name="lecm-group-actions:field-is-mandatory"><![CDATA[true]]></property>
                <property name="lecm-group-actions:field-type"><![CDATA[d:datetime]]></property>
                <property name="cm:name"><![CDATA[Дата начала мероприятия]]></property>
                <property name="lecm-group-actions:field-id"><![CDATA[requestNewTimeFromDate]]></property>
                <property name="lecm-group-actions:field-priority"><![CDATA[0]]></property>
                <property name="lecm-group-actions:field-default-value"><![CDATA[]]></property>
            </item>
        </items>
    </item>
</items>