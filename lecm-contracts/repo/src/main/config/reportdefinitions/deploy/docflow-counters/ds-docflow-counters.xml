<?xml version="1.0" encoding="UTF-8"?>
<!--
	Отчет «Сводный отчет по договорам»

Выполняет группировку документов по критерию "Измерение" (parameter)
и внутри каждой такой группы ещё выполняет разделение по статусам (hardcode).
"Измерения" конфигурируются здесь как текстовый шаблон.
Названия статусов тоже здесь имеются.
Код поля со статусом вшит в провайдер как "lecm-statemachine:status", но можно 
задать иной в секции "status.flags::doc.statusProperty".

	model of the contract/document:
		.\lecm-contracts\repo\src\main\config\models\lecm-contracts-model.xml
	provider:
		ru.it.lecm.contracts.reports.DSProviderDocflowStatusCounters

Фильтры: 
•	Вид договора
•	Тематика договора
•	Контрагент
•	Дата регистрации проекта (задавать Период)
•	Дата договора (задавать Период)
•	Сумма (интервал)
•	Инициатор


Измерение (выбрать одно):
•	Вид договора
•	Тематика договора
•	Контрагент
•	Инициатор

Выходные данные отчета:
	количество документов в разных статусах в зависимости от Измерения

Заметки: измерение задаёт фактически тип ассоциации для группирования.
Количество документов в статусах соот-но будет простой суммой в каждой группе.
	-->

<ds.config>
    <report.descriptor mnem="docflow-counters">
        <l18>
            <item key="RU_RU" value="Сводный отчет по договорам"/>
        </l18>
        <provider mnem="DSProviderDocflowStatusCounters" javaClass="ru.it.lecm.contracts.reports.DSProviderDocflowStatusCounters" >
           <l18>
               <item key="RU_RU" value="Провайдер Jasper отчётов: Сводный отчет по договорам"/>
           </l18>
        </provider>
        <templates>
            <template mnem="tmpl" type="JASPER" filename="docflow-counters_tmpl.jrxml"/>
        </templates>
        <roles>CONTRACT_READER,CONTRACT_RECORDER,CONTRACT_EXECUTOR,CONTRACT_CURATOR,CONTRACT_SIGNER</roles>
    </report.descriptor>

	<!-- Ограничения основной выборки -->
	<query.descriptor>
		<offset>0</offset>
		<limit>-1</limit>
		<pgsize>-1</pgsize>
		<allVersions>true</allVersions>
		<preferedType>lecm-contract:document</preferedType>
		<isMultiRow>true</isMultiRow>
		<isCustom>false</isCustom>
		<queryText><![CDATA[+TYPE:"lecm-contract:document"]]></queryText>
	</query.descriptor>

	<!--
		groupby.formats: Описания для группирования строк из НД, полученного после сбора всех договоров.
		(!) Ключи "key" - это значения параметра формирования отчёта "reportGroupBy"
		, а соот-щие значения - форматная строка для отчёта в терминах substituteService.
		В одну группу будут отнесены строки с одинаковым значением отформатированной строки.

		Пример форматной строки:

		[CDATA[{lecm-additional-document:additionalDocumentType/cm:name} <i>№{lecm-additional-document:number}</i> от {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:dateConclusionContracts} с {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:partner-assoc/lecm-contractor:shortname}
		]]
		детально:
		[CDATA[
				{lecm-additional-document:additionalDocumentType/cm:name}
				<i>№{lecm-additional-document:number}</i>
				от {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:dateConclusionContracts}
				с {..lecm-connect:primary-document-assoc/lecm-connect:connected-document-assoc/lecm-contract:partner-assoc/lecm-contractor:shortname}
		]]
		будет формировать для каждой выходной строки:
			<Название_документа> №<Номер> от <ДатаСоглОсновногоДокумента> с <НазваниеОгранизацииПартнёра>
	  -->
	<groupby.formats>
		<map>
			<item key="contractKind">
				<![CDATA[{lecm-contract:typeContract-assoc/cm:name}]]>
			</item>
			<item key="contractKindTag" value="Вид договора" />

			<item key="contractTheme">
				<![CDATA[{lecm-document:subject-assoc/cm:name}]]>
			</item>
			<item key="contractThemeTag" value="Тематика договора" />

			<item key="contractor">
				<![CDATA[{lecm-contract:partner-assoc/lecm-contractor:shortname}]]>
			</item>
			<item key="contractorTag" value="Контрагент" />

			<item key="initiator">
				<![CDATA[{~AUTHOR}]]>
			</item>
			<item key="initiatorTag" value="Инициатор" />
		</map>
	</groupby.formats>

	<!-- Список реальных значений атрибута-статуса для группировки 
	     внутри групп после применения groupby.format
	  -->
	<statuses>
		<list>
			<item>Черновик</item>
			<item>Проект зарегистрирован</item>
			<item>На согласовании</item>
			<item>Согласован</item>
			<item>На доработке</item>
			<item>На подписании</item>
			<item>Подписан</item>
			<item>На подписании у контрагента</item>
			<item>Зарегистрирован</item>
			<item>Действует</item>
		</list>
	</statuses>
	
	<!-- Доп флажки для провайдера НД -->
	<status.flags>
		<map>
			<!--
			   rowSum.show: надо ли вычислять сумму по строкам (по всем статусам) 
			     и включать соот-щую колонку для dataSource отчёта

			   rowSum.colName: (имеет значение только при rowSum.show=true)
			   название колонки в секции fields.jasper с суммой данных по строке
			   (!) это название должно быть одинаковым тут и в секции fields.
			 -->
			<item key="rowSum.show">true</item>
			<item key="rowSum.colName">col_RowSum</item>
		</map>
	</status.flags>

	<!-- Описания полей  данных в наборе -->
	<fields>
        <field alfrescoType="d:text" order="0" displayName="Измерение"
               javaValueClass="java.lang.String" jrFldName="groupBy"
               queryFldName="contractor|Контрагент,contractKind|Вид,contractTheme|Тематика,initiator|Инициатор">
            <l18>
                <item key="RU_RU" value="Измерение"/>
            </l18>
            <parameter mnem="PARAM_TYPE_VALUE" paramType="PARAM_TYPE_VALUE">
                <l18> <item key="RU_RU" value="Значение"/> </l18>
            </parameter>
        </field>

        <field jrFldName="dateReg" order="1" queryFldName="{lecm-contract:dateRegProjectContracts}" displayName="Дата регистрации"
               javaValueClass="java.util.Date" alfrescoType="d:date">
            <parameter mnem="PARAM_TYPE_RANGE" paramType="PARAM_TYPE_RANGE">
                <l18>
                    <item key="RU_RU" value="Диапазон"/>
                </l18>
                <label1>
                    <item key="RU_RU" value="С"/>
                </label1>
                <label2>
                    <item key="RU_RU" value="По"/>
                </label2>
            </parameter>
        </field>

        <field jrFldName="dateStart" order="2" queryFldName="{lecm-contract:startDate}" displayName="Дата начала"
               javaValueClass="java.util.Date" alfrescoType="d:date">
            <parameter mnem="PARAM_TYPE_RANGE" paramType="PARAM_TYPE_RANGE">
                <l18>
                    <item key="RU_RU" value="Диапазон"/>
                </l18>
                <label1>
                    <item key="RU_RU" value="С"/>
                </label1>
                <label2>
                    <item key="RU_RU" value="По"/>
                </label2>
            </parameter>
        </field>

        <field jrFldName="contractSum" order="3" queryFldName="{lecm-contract:totalAmount}" displayName="Сумма"
               javaValueClass="java.lang.Float" alfrescoType="d:float" >
            <parameter mnem="PARAM_TYPE_RANGE" paramType="PARAM_TYPE_RANGE">
                <l18>
                    <item key="RU_RU" value="Диапазон"/>
                </l18>
                <label1>
                    <item key="RU_RU" value="От"/>
                </label1>
                <label2>
                    <item key="RU_RU" value="До"/>
                </label2>
            </parameter>
        </field>

        <field jrFldName="contragent" order="4" queryFldName="{lecm-contract:partner-assoc-ref}" displayName="Контрагент(ы)"
               javaValueClass="java.lang.String" alfrescoType="lecm-contractor:contractor-type">
            <l18>
                <item key="RU_RU" value="Контрагент(ы)"/>
            </l18>
            <parameter mnem="PARAM_TYPE_LIST" paramType="PARAM_TYPE_LIST">
                <l18> <item key="RU_RU" value="Список"/> </l18>
            </parameter>
        </field>

        <field alfrescoType="lecm-contract-dic:contract-type" order="5" displayName="Вид договора"
               javaValueClass="java.lang.String" jrFldName="contractType" queryFldName="{lecm-contract:typeContract-assoc-ref}">
            <l18>
                <item key="RU_RU" value="Вид договора"/>
            </l18>
            <parameter mnem="PARAM_TYPE_VALUE" paramType="PARAM_TYPE_VALUE">
                <l18> <item key="RU_RU" value="Значение"/> </l18>
            </parameter>
        </field>

        <field alfrescoType="lecm-doc-dic:subjects" order="6" displayName="Тематика договора"
               javaValueClass="java.lang.String" jrFldName="contractSubject" queryFldName="{lecm-document:subject-assoc-ref}">
            <l18>
                <item key="RU_RU" value="Тематика договора"/>
            </l18>
            <parameter mnem="PARAM_TYPE_VALUE" paramType="PARAM_TYPE_VALUE">
                <l18> <item key="RU_RU" value="Значение"/> </l18>
            </parameter>
        </field>

        <field alfrescoType="lecm-orgstr:employee" order="7" displayName="Инициатор"
               javaValueClass="java.lang.String" jrFldName="contractType" queryFldName="{lecm-document:creator-ref}">
            <l18>
                <item key="RU_RU" value="Инициатор"/>
            </l18>
            <parameter mnem="PARAM_TYPE_VALUE" paramType="PARAM_TYPE_VALUE">
                <l18> <item key="RU_RU" value="Значение"/> </l18>
            </parameter>
        </field>

		<!-- Первый столбец это значение выбранного Измерения, т.е. название вида договоров,
		тематика, котрагент или инициатор.
		  -->
		<field jrFldName="col_RowTag" queryFldName="customTag" displayName="Данные.Название" />
		<field jrFldName="col_MeasureTag" queryFldName="col_MeasureTag" displayName="Измерение.Название" />

		<!-- Далее столбцы это кол-во в соот-щих Статусах (см узлы "statuses")-->
		<field jrFldName="col_Count1" queryFldName="status1.counter" displayName="Статус1.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count2" queryFldName="status2.counter" displayName="Статус2.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count3" queryFldName="status3.counter" displayName="Статус3.Кол-во" javaValueClass="java.lang.Integer" />

		<field jrFldName="col_Count4" queryFldName="status4.counter" displayName="Статус4.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count5" queryFldName="status5.counter" displayName="Статус5.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count6" queryFldName="status6.counter" displayName="Статус6.Кол-во" javaValueClass="java.lang.Integer" />

		<field jrFldName="col_Count7" queryFldName="status7.counter" displayName="Статус7.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count8" queryFldName="status8.counter" displayName="Статус8.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count9" queryFldName="status9.counter" displayName="Статус9.Кол-во" javaValueClass="java.lang.Integer" />

		<field jrFldName="col_Count10" queryFldName="status10.counter" displayName="Статус10.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_Count11" queryFldName="statusOther.counter" displayName="СтатусДругие.Кол-во" javaValueClass="java.lang.Integer" />
		<field jrFldName="col_RowSum" queryFldName="statusTotal.counter" displayName="Общее.Кол-во" javaValueClass="java.lang.Integer" />
	</fields>

</ds.config>
