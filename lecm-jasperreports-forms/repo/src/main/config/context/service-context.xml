<?xml version='1.0' encoding='UTF-8'?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:util="http://www.springframework.org/schema/util"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
						   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

	<!-- Registration of pentaho forms models -->
	<bean id="${groupId}.${artifactId}.modelBootstrap" parent="dictionaryModelBootstrap"
		depends-on="dictionaryBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/jasperreports-forms-model.xml</value>
			</list>
		</property>
	</bean>

	<!-- Бин "часто используемых служб" -->
	<bean id="wksKeeper" class="ru.it.lecm.reports.beans.WKServiceKeeperBean">
		<property name="serviceRegistry" ref="ServiceRegistry" />
		<property name="substitudeService" ref="substitudeService" />
		<property name="orgstructureService" ref="serviceOrgstructure" />
		<property name="documentService" ref="documentService"/>
		<property name="documentConnectionService" ref="documentConnectionService"/>
	</bean>

	<!-- Генератор Jasper отчётов (версия v2.x lecm-сервиса) -->
	<bean id="jasperReportGenerator" class="ru.it.lecm.reports.generators.JasperReportGeneratorImpl">
		<property name="services" ref="wksKeeper"/>
		<property name="reportsManagerBeanName" value="reportsManager"/>
	</bean>

	<bean id="reportDAOBean" class="ru.it.lecm.reports.model.DAO.ReportDAOImpl" init-method="init">
		<property name="services" ref="wksKeeper"/>
		<property name="namespaceService" ref="namespaceService"/>
	</bean>

	<!--  RSF == Report Service Folder -->
	<util:constant id="RSF_ROOT_ID" static-field="ru.it.lecm.reports.model.DAO.RepositoryReportContentDAOBean.REPORT_SERVICE_FOLDER_ROOT_ID"/>
	<util:constant id="RSF_ROOT_NAME" static-field="ru.it.lecm.reports.model.DAO.RepositoryReportContentDAOBean.REPORT_SERVICE_FOLDER_ROOT_NAME"/>

	<util:constant id="RSF_REPORT_TYPES_ID" static-field="ru.it.lecm.reports.model.DAO.RepositoryReportContentDAOBean.RS_FOLDER_REPORT_TYPES_ID"/>
	<util:constant id="RSF_REPORT_TYPES_NAME" static-field="ru.it.lecm.reports.model.DAO.RepositoryReportContentDAOBean.RS_FOLDER_REPORT_TYPES_NAME"/>

	<util:constant id="RSF_RTYPE_JASPER_ID" static-field="ru.it.lecm.reports.api.model.ReportType.RTYPE_MNEMO_JASPER"/>
	<util:constant id="RSF_RTYPE_OOFFICE_ID" static-field="ru.it.lecm.reports.api.model.ReportType.RTYPE_MNEMO_OOFFICE"/>


	<!-- Хранение в репозитории файлов для отчётов (xml-шаблоны, jasper и пр) -->
	<bean id="repositoryReportContentBean"
			class="ru.it.lecm.reports.model.DAO.RepositoryReportContentDAOBean"
			init-method="init"
			parent="baseBean" >
		<property name="nodeService" ref="nodeService"/>
		<property name="transactionService" ref="transactionService"/>
		<property name="serviceRegistry" ref="ServiceRegistry"/>
		<!-- Автоматическое создание каталогов. -->
		<property name="folders">
			<map>
				<entry key="#{RSF_ROOT_ID}" value="#{RSF_ROOT_NAME}"/>
				<entry key="#{RSF_REPORT_TYPES_ID}" value="#{RSF_ROOT_NAME}/#{RSF_REPORT_TYPES_NAME}"/>
				<entry key="#{RSF_RTYPE_JASPER_ID}" value="#{RSF_ROOT_NAME}/#{RSF_REPORT_TYPES_NAME}/#{RSF_RTYPE_JASPER_ID}"/>
				<entry key="#{RSF_RTYPE_OOFFICE_ID}" value="#{RSF_ROOT_NAME}/#{RSF_REPORT_TYPES_NAME}/#{RSF_RTYPE_OOFFICE_ID}"/>
			</map>
		</property>
	</bean>


	<!--
		Хранилище файлов отчётов:
		FRC_DAO_DIR == File Report Content DAO Directories
	  -->
	<!-- Хранение файлов для отчётов в файловой системе (xml-шаблоны, jasper и прнепосредлственно из поставки) -->
	<bean id="fileReportContentBean"
			class="ru.it.lecm.reports.model.DAO.FileReportContentDAOBean"
			init-method="init">

		<!-- для надёжности - запрещаем запись в предустановленные отчёты -->
		<property name="readonly" value="true"/>

		<!-- Расположение каталогов на серваке относительно ./classes -->
		<property name="rootDir" value="/reportdefinitions/deploy" />

		<!--
			Форматная строка относительно rootDir для получения полного пути к файлу
			(положение программно задаётся как id : IdContent, фактически используются его одноимённые атрибуты)
			Именованные параметры обозначаются как "@{abc}". 
			В качестве имени "abc" могут подставляться:
					@reportType		тип отчёта
						@reportTypeLo		тип отчёта в нижнем регистре
						@reportTypeUp		тип отчёта в верхнем регистре
					@reportMnemo	название отчёта 
						(@reportMnemoLo/@reportMnemoUp аналогично типу)
					@fileName		название файла (только имя с расширением)
						(@fileNameLo/@fileNameUp аналогично)
					// @root		(!) корневой каталог использовать не разрешается
		
		  -->
		<property name="storeStructurePathFmt" value="/@reporTypeLo/@reportMnemo/@fileName" />
	</bean>

	<!-- Хранилище шаблонов файлов отчётов в файловой системе
		(xml-шаблоны, jasper и пр непосредственно в поставке Lecm)
	  -->
	<bean id="fileReportTemplatesBean"
			class="ru.it.lecm.reports.model.DAO.FileReportContentDAOBean"
			init-method="init">
		<!-- для надёжности - запрещаем запись -->
		<property name="readonly" value="true"/>

		<!-- Расположение каталогов на серваке относительно ./classes -->
		<property name="rootDir" value="/reportdefinitions/templates" />

		<!--
			Форматная строка относительно rootDir для получения полного пути к файлу
			Именованные параметры обозначаются как "@{abc}":
					@reportType		тип отчёта
					@reportMnemo	название отчёта (тут не используется)
					@fileName		название файла (только имя с расширением)
					// @{root}		корневой каталог не разрешается

			(!) Здесь зависимости от "кода отчёта" в форматной строке нет, т.к. это шаблоны
		  -->
		<property name="storeStructurePathFmt" value="/@reporTypeLo/@fileName" />
	</bean>

	<!-- 
			Менеджер шаблонов отчёта
	  -->
	<bean id="reportsManager"
			class="ru.it.lecm.reports.beans.ReportsManagerImpl"
	 		depends-on="repositoryReportContentBean, fileReportContentBean, reportDAOBean, jasperTemplate_DocFlowCounters, jasperReportGenerator"
	 		init-method="init">
		<!-- <property name="services" ref="wksKeeper"/> -->
		<property name="namespaceService" ref="namespaceService"/>

		<property name="reportDAO" ref="reportDAOBean"/>

		<property name="contentRepositoryDAO" ref="repositoryReportContentBean" />
		<property name="contentFileDAO" ref="fileReportContentBean" />
		<property name="templateFileDAO" ref="fileReportTemplatesBean" />

		<property name="reportGenerators[JASPER]" ref="jasperReportGenerator"/>
		<property name="beanDescriptors[0]" ref="jasperTemplate_DocFlowCounters" />

		<property name="reportDefaults[JASPER]">
			<bean class="ru.it.lecm.reports.model.impl.ReportDefaultsDescImpl">
				<property name="fileExtension" value=".jrxml" />
				<property name="generationTemplate" value="jreportCommonTemplate.jrxml.gen" />
			</bean>
		</property>
		<!-- 
		<property name="defaultGenTemplate" value="jreportCommonTemplate.jrxml.gen"/>
		<property name="defaultGenReportType" value="JASPER"/>
		  -->
	</bean>

	<bean id="webscript.ru.it.lecm.forms.jasper.form.get" class="ru.it.lecm.forms.jasperforms.JasperFormProducer"
		parent="webscript">
		<property name="reportsManager" ref="reportsManager"/>
		<!--
		<property name="oofficeGenerator" ref="oofficeReportGenerator"/>
		<property name="cubeGenerator" ref="cubeReportGenerator"/>
		  -->
	</bean>

	<bean id="reportsMgrJavaScriptExtension" class="ru.it.lecm.reports.extensions.ReportManagerJavascriptExtension"
		parent="baseScript">
		<property name="extensionName" value="rptmanager"/>
		<property name="reportsManager" ref="reportsManager"/>
	</bean>

	<!-- описатель шаблона jasper-отчёта "Сводный отчёт по договорам" -->
	<bean id="jasperTemplate_DocFlowCounters" class="ru.it.lecm.reports.model.impl.ReportDescriptorImpl">
		<property name="mnem" value="docflow-counters-test" />
		<property name="l18Name">
			<bean class="ru.it.lecm.reports.model.impl.L18Value">
				<property name="l18items[ru]" value="Сводный отчёт по договорам" />
				<property name="l18items[en]" value="Resume report on contracts" />
			</bean>
		</property>

		<!-- ReportFlags flags -->
		<property name="flags.multiRow" value="true"/>
		<property name="flags.text" value="test query stub text" />
		<property name="flags.offset" value="0" />
		<property name="flags.limit" value="-1" />
		<property name="flags.pgSize" value="1278" />
		<property name="flags.allVersions" value="false" />

		<!-- ReportType -->
		<property name="reportType.mnem" value="JASPER" />
		<property name="reportType.l18items[ru]" value="Отчёт Jasper" />
		<property name="reportType.l18items[en]" value="Jasper report type" />

		<!-- ReportTemplate -->
		<property name="reportTemplate.fileName" value="docflow-counters.jrxml" />
		<property name="reportTemplate.l18items[ru]" value="JRXML отчёта по кол-ву договоров в статусах" />
		<property name="reportTemplate.l18items[en]" value="JRXML Report on number of contracts by doc-status" />

		<!-- ReportProviderDescriptor -->
		<property name="providerDescriptor">
			<bean class="ru.it.lecm.reports.model.impl.ReportProviderDescriptorImpl">
				<constructor-arg index="0" type="java.lang.String" value="ru.it.lecm.reports.jasper.DSProviderDocflowStatusCounters"/>
				<constructor-arg index="1" type="java.lang.String" value="DocflowStatusCounters"/>
				<property name="l18items[ru]" value="Провайдер отчёта по кол-ву договоров в статусах" />
				<property name="l18items[en]" value="Report Provider on number of contracts by doc-status" />
			</bean>
		</property>

		<!-- DataSourceDescriptor -->
		<property name="dsDescriptor.mnem"  value="DSDocflowStatusCounters" />
		<property name="dsDescriptor.l18items[ru]" value="Источник данных для отчёта по кол-ву договоров в статусах" />
		<property name="dsDescriptor.l18items[en]" value="Report data-source for report on number of contracts by doc-status" />

		<property name="dsDescriptor.columns[0]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_RowTag"/>
				<constructor-arg type="java.lang.String" value="STRING"/>
				<property name="l18items[ru]" value="Измерение.Название" />
				<property name="l18items[en]" value="GroupBy.Name" />
				<property name="expression" value="customTag" />
				<property name="parameterValue">
					<bean class="ru.it.lecm.reports.model.impl.ParameterTypedValueImpl">
						<property name="prompt1.l18items[ru]" value="Измерение" /> 
						<property name="prompt1.l18items[en]" value="Group by" />
						<property name="l18items[ru]" value="Измерение для группировки" />
						<property name="l18items[en]" value="Group by" />
						<property name="required" value="true"/>
						<property name="type">
							<value type="ru.it.lecm.reports.api.model.ParameterType$Type">LIST</value>
						</property>
					</bean>
				</property>
			</bean>
		</property>

		<property name="dsDescriptor.columns[1]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_Count1"/>
				<constructor-arg type="java.lang.String" value="INTEGER"/>
				<property name="l18items[ru]" value="Статус1.Кол-во" />
				<property name="l18items[en]" value="Status1.Count" />
				<property name="expression" value="status1.counter" />
			</bean>
		</property>

		<property name="dsDescriptor.columns[2]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_Count2"/>
				<constructor-arg type="java.lang.String" value="INTEGER"/>
				<property name="l18items[ru]" value="Статус2.Кол-во" />
				<property name="l18items[en]" value="Status2.Count" />
				<property name="expression" value="status2.counter" />
			</bean>
		</property>

		<property name="dsDescriptor.columns[3]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_RowSum"/>
				<constructor-arg type="java.lang.String" value="FLOAT"/>
				<property name="l18items[ru]" value="Общее.Кол-во" />
				<property name="l18items[en]" value="Total.Counter" />
				<property name="expression" value="statusTotal.counter" />
			</bean>
		</property>

		<!-- 
		<property name="dsDescriptor.columns[nnn]">
			<bean class="ru.it.lecm.reports.model.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="XXX" />
				<constructor-arg type="java.lang.String" value="FLOAT"/>
				<property name="l18items[ru]" value="Колонка XXX" />
				<property name="l18items[en]" value="Column XXX" />
				<property name="expression" value="XXX" />
			</bean>
		</property>
		  -->
	</bean>

	<!-- описатель шаблона jasper-отчёта "Досье договора" -->
	<bean id="jasperTemplate_ContractDossier" class="ru.it.lecm.reports.model.impl.ReportDescriptorImpl">
		<property name="mnem" value="contract-dossier-test" />
		<property name="l18Name">
			<bean class="ru.it.lecm.reports.model.impl.L18Value">
				<property name="l18items[ru]" value="Досье договора" />
				<property name="l18items[en]" value="Resume of the contract" />
			</bean>
		</property>

		<!-- ReportFlags flags -->
		<property name="flags.multiRow" value="false"/>
		<property name="flags.text" value="test query stub text" />
		<property name="flags.offset" value="0" />
		<property name="flags.limit" value="-1" />
		<property name="flags.pgSize" value="1278" />
		<property name="flags.allVersions" value="false" />

		<!-- ReportType -->
		<property name="reportType.mnem" value="JASPER" />
		<property name="reportType.l18items[ru]" value="Отчёт Jasper" />
		<property name="reportType.l18items[en]" value="Jasper report type" />

		<!-- ReportTemplate -->
		<property name="reportTemplate.fileName" value="contract-dossier.jrxml" />
		<property name="reportTemplate.l18items[ru]" value="JRXML отчёта по кол-ву договоров в статусах" />
		<property name="reportTemplate.l18items[en]" value="JRXML Report on number of contracts by doc-status" />

		<!-- ReportProviderDescriptor -->
		<property name="providerDescriptor">
			<bean class="ru.it.lecm.reports.model.impl.ReportProviderDescriptorImpl">
				<constructor-arg index="0" type="java.lang.String" value="ru.it.lecm.reports.jasper.DSProviderDocflowStatusCounters"/>
				<constructor-arg index="1" type="java.lang.String" value="DocflowStatusCounters"/>
				<property name="l18items[ru]" value="Провайдер отчёта по кол-ву договоров в статусах" />
				<property name="l18items[en]" value="Report Provider on number of contracts by doc-status" />
			</bean>
		</property>

		<!-- DataSourceDescriptor -->
		<property name="dsDescriptor.mnem"  value="DSDocflowStatusCounters" />
		<property name="dsDescriptor.l18items[ru]" value="Источник данных для отчёта по кол-ву договоров в статусах" />
		<property name="dsDescriptor.l18items[en]" value="Report data-source for report on number of contracts by doc-status" />

		<property name="dsDescriptor.columns[0]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_RowTag"/>
				<constructor-arg type="java.lang.String" value="STRING"/>
				<property name="l18items[ru]" value="Измерение.Название" />
				<property name="l18items[en]" value="GroupBy.Name" />
				<property name="expression" value="customTag" />
			</bean>
		</property>

		<property name="dsDescriptor.columns[1]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_Count1"/>
				<constructor-arg type="java.lang.String" value="INTEGER"/>
				<property name="l18items[ru]" value="Статус1.Кол-во" />
				<property name="l18items[en]" value="Status1.Count" />
				<property name="expression" value="status1.counter" />
			</bean>
		</property>

		<property name="dsDescriptor.columns[2]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_Count2"/>
				<constructor-arg type="java.lang.String" value="INTEGER"/>
				<property name="l18items[ru]" value="Статус2.Кол-во" />
				<property name="l18items[en]" value="Status2.Count" />
				<property name="expression" value="status2.counter" />
			</bean>
		</property>

		<property name="dsDescriptor.columns[3]">
			<bean class="ru.it.lecm.reports.model.impl.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="col_RowSum"/>
				<constructor-arg type="java.lang.String" value="FLOAT"/>
				<property name="l18items[ru]" value="Общее.Кол-во" />
				<property name="l18items[en]" value="Total.Counter" />
				<property name="expression" value="statusTotal.counter" />
			</bean>
		</property>

		<!-- 
		<property name="dsDescriptor.columns[nnn]">
			<bean class="ru.it.lecm.reports.model.ColumnDescriptorImpl">
				<constructor-arg type="java.lang.String" value="XXX" />
				<constructor-arg type="java.lang.String" value="FLOAT"/>
				<property name="l18items[ru]" value="Колонка XXX" />
				<property name="l18items[en]" value="Column XXX" />
				<property name="expression" value="XXX" />
			</bean>
		</property>
		  -->
	</bean>

	<bean id="webscript.ru.it.lecm.reports.rptmanager.dsxmlBytes.get"
			class="ru.it.lecm.reports.xml.GetXmlConfig"
			parent="webscript">
		<property name="reportsManager" ref="reportsManager"/>
	</bean>
</beans>
