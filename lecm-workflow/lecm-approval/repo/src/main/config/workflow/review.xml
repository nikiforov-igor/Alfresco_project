<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.it.ru/logicECM/workflow/review">
  <process id="lecmReview" name="Ознакомление" isExecutable="true">
    <extensionElements>
      <activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
        <activiti:field name="script">
          <activiti:string>review.deleteAssigneesListWorkingCopy(execution);</activiti:string>
        </activiti:field>
      </activiti:executionListener>
    </extensionElements>
    <startEvent id="start-review" name="Start review" activiti:formKey="lecmReview:review"></startEvent>
    <serviceTask id="empty-service-task" name="Service task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate"></serviceTask>
    <sequenceFlow id="from-start-to-empty-service-task" sourceRef="start-review" targetRef="empty-service-task"></sequenceFlow>
    <receiveTask id="receivetask" name="Receive Task"></receiveTask>
    <sequenceFlow id="from-empty-service-task-to-receivetask" sourceRef="empty-service-task" targetRef="receivetask"></sequenceFlow>
    <serviceTask id="create-result-list" name="Create result list" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
      <extensionElements>
        <activiti:field name="script">
          <activiti:string>var assigneesList = review.createAssigneesList(lecmReview_assigneesListAssoc, execution);
						execution.setVariableLocal("assigneesList", assigneesList);
						var resultListRef = review.createResultList(bpm_package, documentAttachmentCategoryName, assigneesList);
						execution.setVariable("resultListRef", resultListRef);</activiti:string>
        </activiti:field>
      </extensionElements>
    </serviceTask>
    <sequenceFlow id="from-receivetask-to-create-result-list" sourceRef="receivetask" targetRef="create-result-list"></sequenceFlow>
    <sequenceFlow id="from-create-result-list-to-parallel-review-tsk" sourceRef="create-result-list" targetRef="parallel-review-task"></sequenceFlow>
    <userTask id="parallel-review-task" name="Ознакомиться с документом" activiti:assignee="${assignee.properties[&quot;{http://www.it.ru/logicECM/model/workflow/1.0}userName&quot;]}" activiti:formKey="lecmReview:reviewTask">
      <extensionElements>
        <activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>var dueDate = bpm_workflowDueDate;
							task.setDueDate(dueDate);
							review.assignTask(assignee, task);</activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>review.completeTask(assignee, task);</activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
      <multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${assigneesList}" activiti:elementVariable="assignee"></multiInstanceLoopCharacteristics>
    </userTask>
    <boundaryEvent id="parallel-timer" name="Parallel Timer" attachedToRef="parallel-review-task" cancelActivity="false">
      <timerEventDefinition>
        <timeCycle>0 0 0/4 * * ?</timeCycle>
      </timerEventDefinition>
    </boundaryEvent>
    <serviceTask id="sheduled-notification" name="Notify task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
      <extensionElements>
        <activiti:field name="script">
          <activiti:string>var workflowId = "activiti$" + execution.getProcessInstanceId();
						review.notifyDeadlineTasks(workflowId, bpm_package, execution);</activiti:string>
        </activiti:field>
      </extensionElements>
    </serviceTask>
    <serviceTask id="log-final-decision" name="Log final decision" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
      <extensionElements>
        <activiti:field name="script">
          <activiti:string>var decisionsMap = execution.getVariable("decisionsMap");
						var resultListRef = execution.getVariable("resultListRef");
						if (!decisionsMap) {
							logger.log("Attention: decisionsMap is null!");
						}
						var finalDecision = approval.getFinalDecision(decisionsMap);
						execution.setVariable("finalDecision", finalDecision);
						approval.logFinalDecision(resultListRef, finalDecision);
						approval.notifyFinalDecision(finalDecision, bpm_package)
						execution.setVariable("isApproved", approval.isApproved(finalDecision));</activiti:string>
        </activiti:field>
      </extensionElements>
    </serviceTask>
    <sequenceFlow id="from-parallel-timer-to-notify" sourceRef="parallel-timer" targetRef="sheduled-notification"></sequenceFlow>
    <sequenceFlow id="from-parallel-to-log-final-decision" sourceRef="parallel-review-task" targetRef="log-final-decision"></sequenceFlow>
    <sequenceFlow id="from-log-final-decision-to-workflowEnd" sourceRef="log-final-decision" targetRef="workflowEnd"></sequenceFlow>
    <endEvent id="workflowEnd" name="End"></endEvent>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_lecmReview">
    <bpmndi:BPMNPlane bpmnElement="lecmReview" id="BPMNPlane_lecmReview">
      <bpmndi:BPMNShape bpmnElement="sheduled-notification" id="BPMNShape_sheduled-notification">
        <omgdc:Bounds height="60.0" width="100.0" x="530.0" y="100.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="parallel-review-task" id="BPMNShape_parallel-review-task">
        <omgdc:Bounds height="60.0" width="100.0" x="530.0" y="0.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="workflowEnd" id="BPMNShape_workflowEnd">
        <omgdc:Bounds height="35.0" width="35.0" x="815.0" y="12.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="create-result-list" id="BPMNShape_create-result-list">
        <omgdc:Bounds height="60.0" width="100.0" x="380.0" y="0.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="parallel-timer" id="BPMNShape_parallel-timer">
        <omgdc:Bounds height="30.0" width="30.0" x="570.0" y="40.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="log-final-decision" id="BPMNShape_log-final-decision">
        <omgdc:Bounds height="60.0" width="100.0" x="680.0" y="0.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="start-review" id="BPMNShape_start-review">
        <omgdc:Bounds height="35.0" width="35.0" x="0.0" y="13.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="receivetask" id="BPMNShape_receivetask">
        <omgdc:Bounds height="60.0" width="100.0" x="230.0" y="0.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="empty-service-task" id="BPMNShape_empty-service-task">
        <omgdc:Bounds height="60.0" width="100.0" x="80.0" y="0.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="from-start-to-empty-service-task" id="BPMNEdge_from-start-to-empty-service-task">
        <omgdi:waypoint x="35.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="42.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="42.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="80.0" y="30.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-create-result-list-to-parallel-review-tsk" id="BPMNEdge_from-create-result-list-to-parallel-review-tsk">
        <omgdi:waypoint x="480.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="492.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="492.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="530.0" y="30.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-parallel-to-log-final-decision" id="BPMNEdge_from-parallel-to-log-final-decision">
        <omgdi:waypoint x="630.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="642.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="642.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="680.0" y="30.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-empty-service-task-to-receivetask" id="BPMNEdge_from-empty-service-task-to-receivetask">
        <omgdi:waypoint x="180.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="192.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="192.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="230.0" y="30.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-parallel-timer-to-notify" id="BPMNEdge_from-parallel-timer-to-notify">
        <omgdi:waypoint x="585.0" y="70.0"></omgdi:waypoint>
        <omgdi:waypoint x="580.0" y="100.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-log-final-decision-to-workflowEnd" id="BPMNEdge_from-log-final-decision-to-workflowEnd">
        <omgdi:waypoint x="780.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="792.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="792.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="815.0" y="29.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="from-receivetask-to-create-result-list" id="BPMNEdge_from-receivetask-to-create-result-list">
        <omgdi:waypoint x="330.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="342.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="342.0" y="30.0"></omgdi:waypoint>
        <omgdi:waypoint x="380.0" y="30.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>