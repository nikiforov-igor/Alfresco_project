<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.it.ru/logicECM/workflow/approval/sequential">
	<process id="lecmSequentialApproval" name="Согласование (последовательное)" isExecutable="true">
		<extensionElements>
			<activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var finalDecision = execution.getVariable("finalDecision");
						var isApproved = execution.getVariable("isApproved");
						if (!finalDecision && isApproved != null) {
							var isApprovedValue = Packages.java.lang.Boolean.TRUE.equals(isApproved);
							finalDecision = isApprovedValue ? "APPROVED_FORCE" : "REJECTED_FORCE";
							var approvalListRef = execution.getVariable("approvalListRef");
							approvalSequential.logFinalDecision(approvalListRef, finalDecision);
						}
					]]></activiti:string>
				</activiti:field>
			</activiti:executionListener>
		</extensionElements>
		<startEvent id="start-sequential-approvement" name="Start sequential approvement" activiti:formKey="lecmSeq:sequentialApproval"/>
		<userTask id="sequential-approvement-task" name="Согласовать документ" activiti:assignee='${assignee.properties["{http://www.it.ru/logicECM/model/approval-list/1.0}userName"]}' activiti:formKey="lecmSeq:approveTask">
			<extensionElements>
				<activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var dueDate = assignee.properties["{http://www.it.ru/logicECM/model/approval-list/1.0}assignees-item-due-date"];
							task.setDueDate(dueDate);
							approvalSequential.grantReviewerPermissions(assignee, bpm_package);
							approvalSequential.notifyApprovalStarted(assignee, dueDate, bpm_package);
							var userName = assignee.properties["{http://www.it.ru/logicECM/model/approval-list/1.0}userName"];
							logger.log(userName	+ " must complete his task before workflow dueDate expired " + dueDate);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var jsonUtils = new Packages.org.springframework.extensions.webscripts.json.JSONUtils();

							var userName = assignee.properties["{http://www.it.ru/logicECM/model/approval-list/1.0}userName"];
							var decision = task.getVariableLocal("lecmSeq_approveTaskResult");
							var startDate = task.getCreateTime().getTime();
							var dueDate = task.getDueDate().getTime();
							var comment = task.getVariableLocal("bpm_comment");
							var taskCommentAssoc = task.getVariableLocal("lecmSeq_approveTaskCommentAssoc");
							var commentRef = taskCommentAssoc ? taskCommentAssoc.nodeRef : null;
							var documentRef = bpm_package.children[0].nodeRef;
							logger.log("userName = " + userName);
							logger.log("decision = " + decision);
							logger.log("startDate = " + startDate);
							logger.log("dueDate = " + dueDate);
							logger.log("comment = " + comment);
							logger.log("commentRef = " + commentRef);
							logger.log("documentRef = " + documentRef);
							logger.log("commentFileAttachmentCategoryName = " + commentFileAttachmentCategoryName);
							logger.log("documentProjectNumber = " + documentProjectNumber);
							var taskDecision = {
								"userName": userName,
								"decision": decision,
								"startDate": startDate,
								"dueDate": dueDate,
								"comment": comment,
								"commentRef": commentRef,
								"documentRef": documentRef,
								"commentFileAttachmentCategoryName": commentFileAttachmentCategoryName,
								"documentProjectNumber": documentProjectNumber
							};
							var decisionsMap = execution.getVariable("decisionsMap");
							if (!decisionsMap) {
								logger.log("Attention: decisionsMap is null, it will be created in approvalSequential.addDecision method");
							}
							decisionsMap = approvalSequential.addDecision(decisionsMap, jsonUtils.toJSONString(taskDecision));
							execution.setVariable("decisionsMap", decisionsMap);
							var approvalListRef = execution.getVariable("approvalListRef");
							approvalSequential.logDecision(approvalListRef, jsonUtils.toJSONString(taskDecision));
							execution.setVariable("taskDecision", decision);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
			<multiInstanceLoopCharacteristics isSequential="true" activiti:collection="${assigneesList}" activiti:elementVariable="assignee">
				<completionCondition>${"REJECTED" == taskDecision}</completionCondition>
			</multiInstanceLoopCharacteristics>
		</userTask>
		<sequenceFlow id="from-start-to-sequential-approvement-task" sourceRef="start-sequential-approvement" targetRef="scripttask1"/>
		<endEvent id="end-sequential-approvement" name="End sequential approvement"/>
		<sequenceFlow id="from-sequential-approvement-task-to-end" sourceRef="sequential-approvement-task" targetRef="end-sequential-approvement">
			<extensionElements>
				<activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var decisionsMap = execution.getVariable("decisionsMap");
							var approvalListRef = execution.getVariable("approvalListRef");
							if (!decisionsMap) {
								logger.log("Attention: decisionsMap is null!");
							}
							var finalDecision = approvalSequential.getFinalDecision(decisionsMap);
							execution.setVariable("finalDecision", finalDecision);
							approvalSequential.logFinalDecision(approvalListRef, finalDecision);
							approvalSequential.notifyFinalDecision(finalDecision, bpm_package)
							execution.setVariable("isApproved", approvalSequential.isApproved(finalDecision));
						]]></activiti:string>
					</activiti:field>
				</activiti:executionListener>
			</extensionElements>
		</sequenceFlow>
		<boundaryEvent id="boundarytimer1" name="Timer" attachedToRef="sequential-approvement-task" cancelActivity="false">
			<timerEventDefinition>
				<timeCycle>0 0 0/4 * * ?</timeCycle>
			</timerEventDefinition>
		</boundaryEvent>
		<serviceTask id="alfrescoScripttask1" name="Alfresco Script Task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var workflowId = "activiti$" + execution.getProcessInstanceId();
						approvalSequential.notifyDeadlineTasks(workflowId, bpm_package, execution);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="flow1" sourceRef="boundarytimer1" targetRef="alfrescoScripttask1"/>
		<serviceTask id="alfrescoScripttask2" name="Alfresco Script Task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						execution.setVariableLocal("assigneesList", lecmSeq_assigneeAssoc);
						var approvalListRef = approvalSequential.createApprovalList(bpm_package, documentAttachmentCategoryName);
						execution.setVariable("approvalListRef", approvalListRef);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="flow2" sourceRef="alfrescoScripttask2" targetRef="sequential-approvement-task"/>
		<serviceTask id="scripttask1" name="Service Task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<receiveTask id="receivetask1" name="Receive Task"/>
		<sequenceFlow id="flow3" sourceRef="scripttask1" targetRef="receivetask1"/>
		<sequenceFlow id="flow4" sourceRef="receivetask1" targetRef="alfrescoScripttask2"/>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_lecmSequentialApproval">
		<bpmndi:BPMNPlane bpmnElement="lecmSequentialApproval" id="BPMNPlane_lecmSequentialApproval">
			<bpmndi:BPMNShape bpmnElement="start-sequential-approvement" id="BPMNShape_start-sequential-approvement">
				<omgdc:Bounds height="35.0" width="35.0" x="80.0" y="360.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-approvement-task" id="BPMNShape_sequential-approvement-task">
				<omgdc:Bounds height="60.0" width="100.0" x="700.0" y="348.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="end-sequential-approvement" id="BPMNShape_end-sequential-approvement">
				<omgdc:Bounds height="35.0" width="35.0" x="860.0" y="360.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="boundarytimer1" id="BPMNShape_boundarytimer1">
				<omgdc:Bounds height="30.0" width="30.0" x="735.0" y="400.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="alfrescoScripttask1" id="BPMNShape_alfrescoScripttask1">
				<omgdc:Bounds height="55.0" width="105.0" x="697.0" y="490.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="alfrescoScripttask2" id="BPMNShape_alfrescoScripttask2">
				<omgdc:Bounds height="55.0" width="105.0" x="520.0" y="350.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="scripttask1" id="BPMNShape_scripttask1">
				<omgdc:Bounds height="55.0" width="105.0" x="200.0" y="350.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="receivetask1" id="BPMNShape_receivetask1">
				<omgdc:Bounds height="55.0" width="105.0" x="340.0" y="350.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="from-sequential-approvement-task-to-end" id="BPMNEdge_from-sequential-approvement-task-to-end">
				<omgdi:waypoint x="800.0" y="378.0"></omgdi:waypoint>
				<omgdi:waypoint x="860.0" y="377.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-start-to-sequential-approvement-task" id="BPMNEdge_from-start-to-sequential-approvement-task">
				<omgdi:waypoint x="115.0" y="377.0"></omgdi:waypoint>
				<omgdi:waypoint x="200.0" y="377.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
				<omgdi:waypoint x="750.0" y="430.0"></omgdi:waypoint>
				<omgdi:waypoint x="749.0" y="490.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
				<omgdi:waypoint x="625.0" y="377.0"></omgdi:waypoint>
				<omgdi:waypoint x="700.0" y="378.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
				<omgdi:waypoint x="305.0" y="377.0"></omgdi:waypoint>
				<omgdi:waypoint x="340.0" y="377.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
				<omgdi:waypoint x="445.0" y="377.0"></omgdi:waypoint>
				<omgdi:waypoint x="520.0" y="377.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>