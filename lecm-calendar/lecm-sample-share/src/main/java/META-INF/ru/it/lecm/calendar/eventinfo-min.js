(function(){var b=YAHOO.util.Dom,u=YAHOO.util.Selector,y=YAHOO.util.Event,n=YAHOO.util.KeyListener,l=Alfresco.util.combinePaths,f=Alfresco.util.fromISO8601,i=Alfresco.util.toISO8601,q=Alfresco.util.formatDate,t,o,d;Alfresco.EventInfo=function(z){this.name="Alfresco.EventInfo";this.id=z;this.panel=null;Alfresco.util.YUILoaderHelper.require(["button","container","connection"],this.onComponentsLoaded,this);return this};Alfresco.EventInfo.prototype={panel:null,event:null,options:{siteId:"",onClose:null,eventUri:null,displayDate:null},setOptions:function e(z){this.options=YAHOO.lang.merge(this.options,z);return this},onComponentsLoaded:function j(){if(this.id===null){return}},show:function r(z){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/info",dataObj:{htmlid:this.id,uri:z.uri},successCallback:{fn:this.templateLoaded,scope:this},failureMessage:"Could not load event info panel",execScripts:true});this.event=z},templateLoaded:function s(A){var G=b.get("eventInfoPanel");G.innerHTML=A.serverResponse.responseText;this.panel=Alfresco.util.createYUIPanel(G,{width:"35em"});this.widgets=this.widgets||{};this.widgets.deleteButton=Alfresco.util.createYUIButton(this,"delete-button",this.onDeleteClick);this.widgets.editButton=Alfresco.util.createYUIButton(this,"edit-button",this.onEditClick);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelClick);this.widgets.escapeListener=new n(document,{keys:n.KEY.ESCAPE},{fn:function(I,H){this.onCancelClick()},scope:this,correctScope:true});this.widgets.escapeListener.enable();if(b.get(this.id+"-edit-available")==null&&this.widgets.deleteButton!=null){this.widgets.deleteButton.set("disabled",true)}var D=[this.id+"-startdate",this.id+"-enddate"];for(var C=0,z=D.length;C<z;C++){var E=b.get(D[C]);var B=f(E.innerHTML);if(b.hasClass(E,"allDayEvent")){E.innerHTML=q(B,Alfresco.util.message("date-format.fullDate"))}else{E.innerHTML=q(B,Alfresco.util.message("date-format.fullDateTime"))}}var F=u.query(".yui-gd .yui-u",G);for(var C=1;C<6;C+=2){F[C].innerHTML=Alfresco.util.decodeHTML(F[C].innerHTML)}this.panel.show()},onCancelClick:function w(z){this._hide()},onEditClick:function(z){if(this.isShowing){this._hide()}this.eventDialog=this.initEditDialog();this.eventDialog.show()},onEdited:function(z){if(!z.json.error){YAHOO.Bubbling.fire("eventEdited",{id:this.options.event,data:z.json.data})}else{this.onEditFailed(z)}if(this.panel){this.panel.hide();this.panel.destroy()}this.eventDialog.dialog.destroy()},onEditFailed:function(z){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.edited.failure","Alfresco.CalendarView")})},onDeleteClick:function m(C){var B=this,z=q(f(this.event.from),this._msg("date-format.mediumDate"));Alfresco.util.PopupManager.displayPrompt({noEscape:true,title:this._msg("message.confirm.delete.title"),text:this._msg("message.confirm.delete",this.event.title,z),buttons:[{text:this._msg("button.delete"),handler:function A(){this.destroy();B._onDeleteConfirm.call(B)}},{text:this._msg("button.cancel"),handler:function D(){this.destroy()},isDefault:true}]})},_onDeleteConfirm:function x(){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+this.event.uri+"&page=calendar",successCallback:{fn:this.onDeleted,scope:this},failureMessage:this._msg("message.delete.failure",this.event.title)})},onDeleted:function p(z){this._hide();Alfresco.util.PopupManager.displayMessage({text:this._msg("message.delete.success",this.event.title)});YAHOO.Bubbling.fire("eventDeleted",{id:this.options.event});if(this.panel){this.panel.destroy()}},initEditDialog:function h(D){t=this;o=new Alfresco.module.SimpleDialog();d=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarView");o.setOptions({site:t.options.siteId,displayDate:t.options.displayDate,width:"42em",actionUrl:Alfresco.constants.PROXY_URI+t.options.eventUri+"&page=calendar",ajaxSubmitMethod:Alfresco.util.Ajax.PUT,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/add-event",templateRequestParams:{site:t.options.siteId,uri:"/"+t.options.eventUri||""},doBeforeFormSubmit:{fn:function E(G,J){o.tagLibrary.updateForm(o.id+"-form","tags");var R=b.get(o.id+"-tag-input-field");if(R){R.disabled=true}var Q=b.getElementsByClassName("error",null,b.get(o.id+"-form"));for(var K=0;K<Q.length;K++){b.removeClass(Q[K],"error")}b.get(o.id+"-title").disabled=false;b.get(o.id+"-location").disabled=false;var O=document.getElementsByName("start")[0],I=O.value.split(":"),P=document.getElementsByName("end")[0],N=P.value.split(":"),F=document.getElementsByName("startAt")[0],L=document.getElementsByName("endAt")[0],H=f(F.value),M=f(L.value);H.setHours(I[0]);H.setMinutes(I[1]);M.setHours(N[0]);M.setMinutes(N[1]);b.setAttribute(F,"value",i(H));b.setAttribute(L,"value",i(M));o.form.setAjaxSubmitMethod(o.options.ajaxSubmitMethod)},scope:o},doBeforeAjaxRequest:{fn:function C(I,J){var G=document.getElementsByName("allday").checked===true;var H=document.getElementsByName("start")[0];var F=document.getElementsByName("end")[0];if(I.dataObj.tags){I.dataObj.tags=I.dataObj.tags.join(" ")}if(YAHOO.lang.isUndefined(I.dataObj.start)){I.dataObj.start=H.value;I.dataObj.end=F.value}if(!G&&(I.dataObj.start=="00:00"&&I.dataObj.end=="00:00")){I.dataObj.end="01:00"}return true},scope:o},doBeforeDialogShow:{fn:function A(){var H=t.event,G=(H)?f(H.startAt.iso8601):this.options.displayDate,J=(H)?f(H.endAt.iso8601):this.options.displayDate;Alfresco.CalendarHelper.writeDateToField(G,b.get("fd"));Alfresco.CalendarHelper.writeDateToField(J,b.get("td"));b.get(o.id+"-startAt").value=i(G);b.get(o.id+"-endAt").value=i(J);var N=b.get(o.id+"-tag-input-field");N.disabled=false;N.tabIndex=9;b.get(o.id+"-add-tag-button").tabIndex=10;var O=N.value;N.value="";o.tagLibrary.setTags(O.split(" "));o.form.errorContainer=null;var K=document.getElementsByName("start")[0],L=document.getElementsByName("end")[0];if(document.getElementsByName("allday")[0].checked===true){b.addClass(K.parentNode,"hidden");b.addClass(L.parentNode,"hidden")}else{b.removeClass(K.parentNode,"hidden");b.removeClass(L.parentNode,"hidden")}if(H){b.setAttribute(K,"value",q(G,"HH:MM"));b.setAttribute(L,"value",q(J,"HH:MM"))}o.dialog.hideEvent.subscribe(function(){if(d&&d.oCalendar){d.oCalendar.hide()}},o,true);var M=["what","where","desc"];for(var I=0;I<M.length;I++){var F=document.getElementsByName(M[I])[0];F.value=Alfresco.util.decodeHTML(F.value)}},scope:o},doSetupFormsValidation:{fn:function B(F){var M={pattern:/({|})/,match:false};var H={pattern:/^\d{1,2}:\d{2}/,match:true};var L=[o.id+"-title",o.id+"-location",o.id+"-description"];F.addValidation(L[0],Alfresco.forms.validation.mandatory,null,"blur");F.addValidation(L[0],Alfresco.forms.validation.mandatory,null,"keyup");for(var I=0;I<L.length;I++){F.addValidation(L[I],Alfresco.forms.validation.regexMatch,M,"blur");F.addValidation(L[I],Alfresco.forms.validation.regexMatch,M,"keyup")}var N=[o.id+"-start",o.id+"-end"];for(var I=0;I<N.length;I++){F.addValidation(N[I],Alfresco.forms.validation.regexMatch,H,"blur",d.msg("message.invalid-time"))}F.addValidation(o.id+"-tag-input-field",function K(T,Q,S,R,P){if(!Q){Q={}}Q.pattern=/([\"\*\\\>\<\?\/\:\|]+)|([\.]?[\.]+$)/;Q.match=false;return Alfresco.forms.validation.regexMatch(T,Q,S,R,P)},null,"keyup");o.tagLibrary.initialize(F);var J=["td","fd",o.id+"-start",o.id+"-end"];for(var I=0;I<J.length;I++){F.addValidation(J[I],t._onDateValidation,{obj:o},"blur")}F.addValidation("td",t._onDateValidation,{obj:o},"focus");F.addValidation("fd",t._onDateValidation,{obj:o},"focus");F.setShowSubmitStateDynamically(true,false);F.setSubmitElements(o.widgets.okButton);var G=function(){return function(P){if(P.keyCode===n.KEY.ENTER){t.onDateSelectButton.apply(o,arguments);return false}}}();var O=Alfresco.util.createYUIButton(o,"browse-button",function(){if(o.browsePanel){delete o.browsePanel}o.hide();var P=Alfresco.util.ComponentManager.findFirst("Alfresco.CollaborationTitle"),Q=(P&&P.options)?P.options.siteTitle:o.options.site;Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/browse-docfolder",dataObj:{site:Q},successCallback:{fn:function(S){var Y=document.createElement("div");Y.innerHTML=S.serverResponse.responseText;var U=b.getFirstChild(Y);o.browsePanel=Alfresco.util.createYUIPanel(U);var V=b.get(o.id+"-docfolder").value;Alfresco.util.createYUIButton(o.browsePanel,"ok",function(){if(V.charAt(V.length-1)=="/"){V=V.substring(0,V.length-1)}b.get(o.id+"-docfolder").value=V;o.browsePanel.hide();o.dialog.show()});Alfresco.util.createYUIButton(o.browsePanel,"cancel",function(){o.browsePanel.hide();o.dialog.show()});Alfresco.util.createTwister("twister");var R=new YAHOO.widget.TreeView("treeview");R.setDynamicLoad(function(ac,Z){var aa=ac.data.path;var ab=Alfresco.constants.PROXY_URI+"slingshot/doclib/treenode/site/"+l(encodeURIComponent(d.options.siteId),encodeURIComponent("documentLibrary"),Alfresco.util.encodeURIPath(aa));var ad={success:function(ah){var ag=YAHOO.lang.JSON.parse(ah.responseText),ai,aj;if(ag.items){for(var af=0,ae=ag.items.length;af<ae;af++){ai=ag.items[af];ai.path=l(aa,ai.name);aj=t._buildTreeNode(ai,ac,false);if(!ai.hasChildren){aj.isLeaf=true}}}ah.argument.fnLoadComplete()},failure:function(ae){Alfresco.logger.error("",ae)},argument:{node:ac,fnLoadComplete:Z},scope:o};YAHOO.util.Connect.asyncRequest("GET",ab,ad)});var T=function X(Z){V="documentLibrary"+Z};R.subscribe("expand",function(Z){T(Z.data.path)});R.subscribe("clickEvent",function(Z){T(Z.node.data.path)});R.subscribe("collapseComplete",function(Z){T(Z.data.path)});var W=t._buildTreeNode({name:"documentLibrary",path:"/",nodeRef:""},R.getRoot(),false);R.render();o.browsePanel.setFirstLastFocusable();o.browsePanel.show()},scope:o}})});if(!o.startButton){o.startButton=new YAHOO.widget.Button({type:"link",id:"calendarpicker",label:"",href:"",tabindex:6,container:o.id+"-startdate"});o.startButton.on("click",t.onDateSelectButton,{},o);y.on(b.get("fd"),"click",t.onDateSelectButton,{},o);o.startButton.on("keypress",G)}if(!o.endButton){o.endButton=new YAHOO.widget.Button({type:"link",id:"calendarendpicker",label:"",href:"",tabindex:8,container:o.id+"-enddate"});o.endButton.on("click",t.onDateSelectButton,{},o);y.on(b.get("td"),"click",t.onDateSelectButton,{},o);o.endButton.on("keypress",G)}y.addListener(document.getElementsByName("allday")[0],"click",function(P){if(y.getTarget(P).checked===true){b.addClass(document.getElementsByName("start")[0].parentNode,"hidden");b.addClass(document.getElementsByName("end")[0].parentNode,"hidden")}else{b.removeClass(document.getElementsByName("start")[0].parentNode,"hidden");b.removeClass(document.getElementsByName("end")[0].parentNode,"hidden")}});YAHOO.Bubbling.on("formValidationError",d.onFormValidationError,o)},scope:o},onSuccess:{fn:t.onEdited,scope:t},onFailure:{fn:t.onEditFailed,scope:t}});if(D){o.setOptions(D)}o.id="eventEditPanel";o.event=t.event;if(o.tagLibrary==undefined){var z=Alfresco.util.ComponentManager.find({name:"Alfresco.module.TagLibrary"});if(z.length>0){o.tagLibrary=z[0]}else{o.tagLibrary=new Alfresco.module.TagLibrary(o.id);o.tagLibrary.setOptions({siteId:o.options.siteId})}}o.tags=[];YAHOO.Bubbling.on("onTagLibraryTagsChanged",function(F,G){o.tags=G[1].tags},o);return o},onDateSelectButton:function a(D){y.stopEvent(D);var A=d,H=y.getTarget(D),z=(H.id==="calendarpicker-button"||H.id==="fd")?true:false;A.oCalendarMenu=new YAHOO.widget.Overlay("calendarmenu",{context:[H,"tr","br"]});A.oCalendarMenu.setBody("&#32;");A.oCalendarMenu.body.id="calendarcontainer";A.oCalendarMenu.render(b.getAncestorByTagName(H.id,"div"));var B=(z)?b.get("fd"):b.get("td");var F=Alfresco.CalendarHelper.getDateFromField(B);var E=Alfresco.CalendarHelper.padZeros(F.getMonth()+1)+"/"+F.getFullYear();var C={pagedate:E,close:true},G={pagedate:E,close:true,mindate:f(b.get("fd").title)};var I=(z)?C:G;A.oCalendar=new YAHOO.widget.Calendar("buttoncalendar",A.oCalendarMenu.body.id,I);Alfresco.util.calI18nParams(A.oCalendar);A.oCalendar.render();A.oCalendar.selectEvent.subscribe(function(N,L){var K;if(L){K=L[0][0];var M=new Date(K[0],(K[1]-1),K[2]);Alfresco.CalendarHelper.writeDateToField(M,B);var J;if(z){J=Alfresco.CalendarHelper.getDateFromField(b.get("td"));if(YAHOO.widget.DateMath.before(J,M)){var O=b.get("td");Alfresco.CalendarHelper.writeDateToField(M,O);document.getElementsByName("endAt")[0].value=i(M)}document.getElementsByName("startAt")[0].value=i(M)}else{J=Alfresco.CalendarHelper.getDateFromField(B);document.getElementsByName("to")[0].value=i(J)}}A.oCalendarMenu.hide();(z)?b.get("calendarpicker-button").focus():b.get("calendarendpicker-button").focus()},A,true);A.oCalendarMenu.body.tabIndex=-1;A.oCalendar.oDomContainer.tabIndex=-1;A.oCalendarMenu.show();A.oCalendar.show();A.oCalendarMenu.body.focus();return false},_onDateValidation:function v(H,G,A,B,F){var I=b.get(G.obj.id+"-start").value.split(":");var E=b.get(G.obj.id+"-end").value.split(":");var C=Alfresco.CalendarHelper.getDateFromField(b.get("fd"));C.setHours(I[0]);C.setMinutes(I[1]);var D=Alfresco.CalendarHelper.getDateFromField(b.get("td"));D.setHours(E[0]);D.setMinutes(E[1]);if(C.getTime()===D.getTime()){return true}var z=YAHOO.widget.DateMath.after(D,C);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Current start date: "+C+" "+b.get(G.obj.id+"-start").value);Alfresco.logger.debug("Current end date: "+D+" "+b.get(G.obj.id+"-end").value);Alfresco.logger.debug("End date is after start date: "+z)}if(!z&&!F){B.addError(Alfresco.util.message("message.invalid-date","Alfresco.CalendarView"),H)}return z},_msg:function c(z){return Alfresco.util.message.call(this,z,"Alfresco.EventInfo",Array.prototype.slice.call(arguments).slice(1))},_hide:function k(){if(this.widgets&&this.widgets.escapeListener){this.widgets.escapeListener.disable()}if(this.panel){this.panel.hide()}var z=this.options.onClose;if(z&&typeof z.fn=="function"){z.fn.call((typeof z.scope=="object"?z.scope:this),z.obj)}},_buildTreeNode:function g(z,B,A){return new YAHOO.widget.TextNode({label:Alfresco.util.encodeHTML(z.name),path:z.path,nodeRef:z.nodeRef,description:z.description},B,A)}}})();