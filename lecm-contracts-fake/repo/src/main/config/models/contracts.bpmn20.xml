<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
			 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			 xmlns:activiti="http://activiti.org/bpmn"
			 xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
			 xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
			 xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
			 xmlns:lecm="http://www.it.ru/LogicECM/bpmn/1.0"
			 typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
			 targetNamespace="http://www.activiti.org/test">
	<process id="contractWorkflow" name="Contract Workflow">
		<startEvent id="start" name="Alfresco start" activiti:formKey="cwf:startTask"></startEvent>
		<userTask id="new" name="Черновик" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<activiti:taskListener event="create"
									   class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string>execution.setVariable('inputVariable', 'test');</activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="DRAFT"/>
						</lecm:action>
					</lecm:event>
					<lecm:event on="take">
                        <lecm:action type="UserWorkflow" >
                            <lecm:attribute label="На подпись" workflowId="activitiReview" assignee="admin" />
                        </lecm:action>
						<lecm:action type="FinishStateWithTransition" variable="trans">
							<lecm:attribute name="agreement">
								<lecm:parameter name="labelId" value="На согласование"/>
								<lecm:parameter name="workflowId" value="activitiReview"/>
								<lecm:parameter name="variableValue" value="agreement"/>
								<lecm:workflowVariables>
									<lecm:input from="inputVariable" to="workflowInputVariable"/>
									<lecm:input to="workflowInputVariableValue" value="fromDescriptor"/>
									<lecm:output from="wf_reviewOutcome" to="agree"/>
									<lecm:output to="stateProcessInputVariableValue" value="fromDescriptor"/>
								</lecm:workflowVariables>
							</lecm:attribute>
							<lecm:attribute name="signing">
								<lecm:parameter name="labelId" value="На подписание"/>
								<lecm:parameter name="variableValue" value="signing"/>
							</lecm:attribute>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<userTask id="onAgreement" name="На согласовании" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="ON_AGREEMENT"/>
						</lecm:action>
					</lecm:event>
					<lecm:event on="end">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="AGREED"/>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<exclusiveGateway id="parallelgateway1" name="Parallel Gateway"></exclusiveGateway>
		<userTask id="onRefining" name="На доработке" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="ON_REFINING"/>
						</lecm:action>
					</lecm:event>
					<lecm:event on="take">
						<lecm:action type="FinishStateWithTransition" variable="Type">
							<lecm:attribute name="agreement">
								<lecm:parameter name="labelId" value="На согласование"/>
								<lecm:parameter name="workflowId" value="activitiReview"/>
								<lecm:parameter name="variableValue" value="agreement"/>
								<lecm:workflowVariables>
									<lecm:input from="inputVariable" to="workflowInputVariable"/>
									<lecm:input to="workflowInputVariableValue" value="fromDescriptor"/>
									<lecm:output from="wf_reviewOutcome" to="agree"/>
									<lecm:output to="stateProcessInputVariableValue" value="fromDescriptor"/>
								</lecm:workflowVariables>
							</lecm:attribute>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<userTask id="onSigning" name="На подписании" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="ON_SIGNING"/>
						</lecm:action>
						<lecm:action type="StartWorkflow">
							<lecm:attribute name="workflowId" value="activitiReview"/>
							<lecm:attribute name="assignee" value="admin"/>
						</lecm:action>
						<lecm:action type="WaitForDocumentChange">
							<lecm:expressions outputVariable="signed">
								<lecm:expression expression="#lecm_document_regnum.equals('3')" outputValue="true"/>
								<lecm:expression expression="#lecm_document_regnum.equals('5')" outputValue="false"/>
							</lecm:expressions>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<exclusiveGateway id="exclusivegateway1" name="Exclusive Gateway"></exclusiveGateway>
		<userTask id="canceled" name="Отменен" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="CANCELED"/>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<userTask id="signed" name="Подписан" activiti:assignee="${bpm_assignee.properties.userName}">
			<extensionElements>
				<lecm:extension>
					<lecm:event on="start">
						<lecm:action type="StatusChange">
							<lecm:attribute name="status" value="SIGNED"/>
						</lecm:action>
					</lecm:event>
				</lecm:extension>
			</extensionElements>
		</userTask>
		<endEvent id="endevent1" name="End"></endEvent>
		<sequenceFlow id="flow1" name="" sourceRef="start" targetRef="new"></sequenceFlow>
		<sequenceFlow id="flow3" name="" sourceRef="onAgreement" targetRef="parallelgateway1"></sequenceFlow>
		<sequenceFlow id="flow4" name="${!agreed}" sourceRef="parallelgateway1" targetRef="onRefining">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${agree != 'Approve'}]]></conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="flow6" name="${agreed}" sourceRef="parallelgateway1" targetRef="onSigning">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${agree == 'Approve'}]]></conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="flow7" name="" sourceRef="onSigning" targetRef="exclusivegateway1"></sequenceFlow>
		<sequenceFlow id="flow8" name="${signed}" sourceRef="exclusivegateway1" targetRef="signed">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${signed == 'true'}]]></conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="flow9" name="${!signed}" sourceRef="exclusivegateway1" targetRef="canceled">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${signed != 'true'}]]></conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="flow10" name="" sourceRef="canceled" targetRef="endevent1"></sequenceFlow>
		<sequenceFlow id="flow11" name="" sourceRef="signed" targetRef="endevent1"></sequenceFlow>
		<sequenceFlow id="flow15" name="" sourceRef="onRefining" targetRef="onAgreement"></sequenceFlow>
		<sequenceFlow id="flow16" name="" sourceRef="exclusivegateway2" targetRef="onAgreement">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${trans == 'agreement'}]]></conditionExpression>
		</sequenceFlow>
		<exclusiveGateway id="exclusivegateway2" name="Exclusive Gateway"></exclusiveGateway>
		<sequenceFlow id="flow17" name="" sourceRef="new" targetRef="exclusivegateway2"></sequenceFlow>
		<sequenceFlow id="flow18" name="" sourceRef="exclusivegateway2" targetRef="onSigning">
			<conditionExpression xsi:type="tFormalExpression"><![CDATA[${trans != 'agreement'}]]></conditionExpression>
		</sequenceFlow>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_contractWorkflow">
		<bpmndi:BPMNPlane bpmnElement="contractWorkflow" id="BPMNPlane_contractWorkflow">
			<bpmndi:BPMNShape bpmnElement="start" id="BPMNShape_start">
				<omgdc:Bounds height="35" width="35" x="10" y="230"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="new" id="BPMNShape_new">
				<omgdc:Bounds height="55" width="105" x="80" y="221"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="onAgreement" id="BPMNShape_onAgreement">
				<omgdc:Bounds height="55" width="105" x="286" y="221"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="parallelgateway1" id="BPMNShape_parallelgateway1">
				<omgdc:Bounds height="40" width="40" x="420" y="227"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="onRefining" id="BPMNShape_onRefining">
				<omgdc:Bounds height="55" width="105" x="286" y="132"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="onSigning" id="BPMNShape_onSigning">
				<omgdc:Bounds height="55" width="105" x="490" y="220"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="exclusivegateway1" id="BPMNShape_exclusivegateway1">
				<omgdc:Bounds height="40" width="40" x="620" y="227"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="canceled" id="BPMNShape_canceled">
				<omgdc:Bounds height="55" width="105" x="588" y="120"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="signed" id="BPMNShape_signed">
				<omgdc:Bounds height="55" width="105" x="685" y="220"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="endevent1" id="BPMNShape_endevent1">
				<omgdc:Bounds height="35" width="35" x="820" y="230"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="exclusivegateway2" id="BPMNShape_exclusivegateway2">
				<omgdc:Bounds height="40" width="40" x="212" y="228"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
				<omgdi:waypoint x="45" y="247"></omgdi:waypoint>
				<omgdi:waypoint x="80" y="248"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
				<omgdi:waypoint x="391" y="248"></omgdi:waypoint>
				<omgdi:waypoint x="420" y="247"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
				<omgdi:waypoint x="440" y="227"></omgdi:waypoint>
				<omgdi:waypoint x="439" y="158"></omgdi:waypoint>
				<omgdi:waypoint x="391" y="159"></omgdi:waypoint>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14" width="100" x="10" y="0"></omgdc:Bounds>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6">
				<omgdi:waypoint x="460" y="247"></omgdi:waypoint>
				<omgdi:waypoint x="490" y="247"></omgdi:waypoint>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14" width="100" x="-15" y="27"></omgdc:Bounds>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7">
				<omgdi:waypoint x="595" y="247"></omgdi:waypoint>
				<omgdi:waypoint x="620" y="247"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow8" id="BPMNEdge_flow8">
				<omgdi:waypoint x="660" y="247"></omgdi:waypoint>
				<omgdi:waypoint x="685" y="247"></omgdi:waypoint>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14" width="100" x="-23" y="27"></omgdc:Bounds>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow9" id="BPMNEdge_flow9">
				<omgdi:waypoint x="640" y="227"></omgdi:waypoint>
				<omgdi:waypoint x="640" y="175"></omgdi:waypoint>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14" width="100" x="10" y="0"></omgdc:Bounds>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow10" id="BPMNEdge_flow10">
				<omgdi:waypoint x="693" y="147"></omgdi:waypoint>
				<omgdi:waypoint x="837" y="147"></omgdi:waypoint>
				<omgdi:waypoint x="837" y="230"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow11" id="BPMNEdge_flow11">
				<omgdi:waypoint x="790" y="247"></omgdi:waypoint>
				<omgdi:waypoint x="820" y="247"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow15" id="BPMNEdge_flow15">
				<omgdi:waypoint x="338" y="187"></omgdi:waypoint>
				<omgdi:waypoint x="338" y="221"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow16" id="BPMNEdge_flow16">
				<omgdi:waypoint x="252" y="248"></omgdi:waypoint>
				<omgdi:waypoint x="286" y="248"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow17" id="BPMNEdge_flow17">
				<omgdi:waypoint x="185" y="248"></omgdi:waypoint>
				<omgdi:waypoint x="212" y="248"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow18" id="BPMNEdge_flow18">
				<omgdi:waypoint x="232" y="268"></omgdi:waypoint>
				<omgdi:waypoint x="232" y="329"></omgdi:waypoint>
				<omgdi:waypoint x="361" y="329"></omgdi:waypoint>
				<omgdi:waypoint x="542" y="329"></omgdi:waypoint>
				<omgdi:waypoint x="542" y="275"></omgdi:waypoint>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14" width="100" x="10" y="0"></omgdc:Bounds>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>
