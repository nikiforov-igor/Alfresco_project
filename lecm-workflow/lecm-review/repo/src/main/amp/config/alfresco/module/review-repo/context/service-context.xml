<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:util="http://www.springframework.org/schema/util"
	   xmlns:p="http://www.springframework.org/schema/p"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
						   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

	<util:constant id="ENGINE_ID" static-field="org.alfresco.repo.workflow.WorkflowDeployer.ENGINE_ID"/>
	<util:constant id="LOCATION" static-field="org.alfresco.repo.workflow.WorkflowDeployer.LOCATION"/>
	<util:constant id="MIMETYPE" static-field="org.alfresco.repo.workflow.WorkflowDeployer.MIMETYPE"/>
	<util:constant id="REDEPLOY" static-field="org.alfresco.repo.workflow.WorkflowDeployer.REDEPLOY"/>

	<util:list id="review.actions">
		<value>alfresco/module/${artifactId}/actions/confirm-review-action.xml</value>
		<value>alfresco/module/${artifactId}/actions/send-to-review-action.xml</value>
	</util:list>

	<util:list id="review.dics">
		<value>alfresco/module/${artifactId}/dictionaries/lecm-review-list-dictionary.xml</value>
		<value>alfresco/module/${artifactId}/dictionaries/lecm-review-nt-items.xml</value>
		<value>alfresco/module/${artifactId}/dictionaries/lecm-business-journal-objectType-items.xml</value>
		<value>alfresco/module/${artifactId}/dictionaries/lecm-business-journal-eventCategory-items.xml</value>
	</util:list>

	<util:list id="review.workflows">
		<props>
			<prop key="#{ENGINE_ID}">activiti</prop>
			<prop key="#{LOCATION}">alfresco/module/${artifactId}/workflow/review-workflow.bpmn20.xml</prop>
			<prop key="#{MIMETYPE}">text/xml</prop>
			<prop key="#{REDEPLOY}">${redeploy.process.definitions}</prop>
		</props>
	</util:list>

	<util:list id="review.models">
		<value>alfresco/module/${artifactId}/models/lecm-review-workflow-model.xml</value>
		<value>alfresco/module/${artifactId}/models/lecm-review-result-model.xml</value>
		<value>alfresco/module/${artifactId}/models/lecm-review-ts-model.xml</value>
		<value>alfresco/module/${artifactId}/models/lecm-review-list-model.xml</value>
		<value>alfresco/module/${artifactId}/models/lecm-review-global-settings-model.xml</value>
	</util:list>

	<util:list id="review.labels">
		<value>alfresco/module/${artifactId}/messages/lecm-review-workflow</value>
		<value>alfresco/module/${artifactId}/messages/lecm-review-result</value>
		<value>alfresco/module/${artifactId}/messages/lecm-review-ts</value>
		<value>alfresco/module/${artifactId}/messages/lecm-review-global-settings</value>
	</util:list>

	<bean id="review.workflow.bootstrap" parent="workflowDeployer"
		  depends-on="review.model.bootstrap"
		  p:workflowDefinitions-ref="review.workflows"/>

	<bean id="review.model.bootstrap" parent="dictionaryModelBootstrap"
			  depends-on="dictionaryBootstrap, workflow.model.bootstrap, ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap"
			  p:models-ref="review.models" p:labels-ref="review.labels"/>

	<bean parent="lecmDictionaryBootstrap" depends-on="groupActionsService"
			  p:rootPath="/Business platform/LECM/Сервис Групповые операции"
			  p:dictionaries-ref="review.actions"/>

	<bean id="review.dictionary.bootstrap" parent="lecmDictionaryBootstrap"
		  depends-on="review.model.bootstrap, ru.it.lecm.notifications.notifications-repo.notificationsTemplatesBootstrap"
		  p:dictionaries-ref="review.dics"
          />

	<bean id="reviewWorkflowService" class="ru.it.lecm.workflow.review.ReviewWorkflowServiceImpl"
		  parent="lecmWorkflowService" depends-on="review.model.bootstrap"
		  p:workCalendarService-ref="WorkCalendarService"
		  p:assigneesListService-ref="workflowAssigneesListService"
		  p:resultListService-ref="workflowResultListService"
		  p:documentService-ref="documentService" />

	<util:constant id="reviewFolder" static-field="ru.it.lecm.workflow.review.ReviewServiceImpl.REVIEW_FOLDER"/>
	<util:map id="review.folders">
		<entry key="#{reviewFolder}" value="Сервис Ознакомление документов"/>
	</util:map>
	<bean id="reviewService" class="ru.it.lecm.workflow.review.ReviewServiceImpl"
		  parent="baseBean" depends-on="review.model.bootstrap" init-method="init"
		  p:documentTableService-ref="documentTableService"
		  p:orgstructureBean-ref="serviceOrgstructure"
		  p:searchService-ref="searchService"
		  p:namespaceService-ref="namespaceService"
		  p:dictionaryBean-ref="serviceDictionary"
		  p:folders-ref="review.folders"
		  p:defaultReviewTerm="#{T(org.apache.commons.lang.math.NumberUtils).isNumber('${lecm.review.defaultTerm}') ? T(java.lang.Integer).parseInt('${lecm.review.defaultTerm}') : null}"
		  p:defaultTermToNotify="#{T(org.apache.commons.lang.math.NumberUtils).isNumber('${lecm.review.defaultTermToNotify}') ? T(java.lang.Integer).parseInt('${lecm.review.defaultTermToNotify}') : null}"
	/>

	<bean id="reviewListAssociationPolicy" class="ru.it.lecm.workflow.review.policy.ReviewListAssociationPolicy"
			parent="logicEcmAssociationPolicy" init-method="init"
	/>

	<bean id="reviewItemChangePolicy" class="ru.it.lecm.workflow.review.policy.ItemChangedPolicy"
		  depends-on="review.model.bootstrap" init-method="init"
		  p:authenticationService-ref="authenticationService"
		  p:nodeService-ref="nodeService"
		  p:orgstructureService-ref="serviceOrgstructure"
		  p:reviewService-ref="reviewService"
		  p:tableService-ref="documentTableService"
		  p:policyComponent-ref="policyComponent"
	/>

	<util:list id="review.admin.arm.dictionaries">
		<value>alfresco/module/${artifactId}/arm/review-settings-arm.xml</value>
	</util:list>
	<bean id="review.admin.arm.bootstrap" parent="lecmDictionaryBootstrap"
		  depends-on="eds.documents.arm.settings.LogicEcmBootstrap"
		  p:rootPath="/Business platform/LECM/Сервис АРМ/Настройки АРМ/Администрирование/Другие настройки/Настройки СЭД"
		  p:dictionaries-ref="review.admin.arm.dictionaries"/>

	<util:list id="review.my-profile.arm.dictionaries">
		<value>alfresco/module/${artifactId}/arm/review-list-my-profile-arm.xml</value>
	</util:list>
	<bean id="review.my-profile.arm.bootstrap" parent="lecmDictionaryBootstrap"
		  depends-on="arm.LogicEcmBootstrap, armService, arm.filters.LogicEcmBootstrap"
		  p:rootPath="/Business platform/LECM/Сервис АРМ/Настройки АРМ/Логика ECM. Мой профиль/Настройки"
		  p:dictionaries-ref="review.my-profile.arm.dictionaries"/>

	<bean id="reviewNotificationExecutor" class="ru.it.lecm.workflow.review.schedule.ReviewNotificationExecutor" parent="action-executer"
		  p:ignoreLock="false"
		  p:publicAction="false"
		  p:nodeService-ref="nodeService"
		  p:notificationsService-ref="notificationsService"
		  p:calendarBean-ref="WorkCalendarService"
		  p:reviewService-ref="reviewService"
	/>

	<bean id="reviewNotificationSchedule" class="ru.it.lecm.workflow.review.schedule.ReviewNotificationSchedule"
		  p:transactionMode="ISOLATED_TRANSACTIONS"
		  p:compensatingActionMode="IGNORE"
          p:cronExpression="0 0 5 */1 * ?"
          p:firstStartExpression="0 */15 * * * ?"
          p:onServerStart="false"
          p:jobName="review-notification"
		  p:jobGroup="review"
		  p:triggerName="review-notification-trigger"
		  p:triggerGroup="review-trigger"
		  p:runAsUser="System"
		  p:scheduler-ref="schedulerFactory"
		  p:documentService-ref="documentService"
		  p:reviewService-ref="reviewService"
		  p:calendarBean-ref="WorkCalendarService"
		  p:actionService-ref="ActionService"
		  p:transactionService-ref="TransactionService"
	/>

	<bean parent="ServiceFolderPermissionHelper">
		<property name="serviceBean" ref="serviceDictionary"/>
		<property name="permissionsList">
			<list>
				<value>alfresco/module/${artifactId}/permissions/dictionaries-permissions.xml</value>
			</list>
		</property>
	</bean>

</beans>
