<?xml version='1.0' encoding='UTF-8'?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:util="http://www.springframework.org/schema/util"
	   xmlns:amq="http://activemq.apache.org/schema/core"
	   xmlns:jms="http://www.springframework.org/schema/jms"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
						   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
						   http://activemq.apache.org/schema/core
						   http://activemq.apache.org/schema/core/activemq-core.xsd
						   http://www.springframework.org/schema/jms
						   http://www.springframework.org/schema/jms/spring-jms.xsd">
	<!-- Registration of orgStructure models -->
	<bean id="${groupId}.${artifactId}.subscriptionsBootstrap" parent="dictionaryModelBootstrap"
		  depends-on="ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap, ru.it.lecm.notifications.notifications-repo.notificationsDictionaryBootstrap, ru.it.lecm.business-journal.business-journal-repo.businessJournalBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-subscriptions-model.xml</value>
			</list>
		</property>
		<property name="labels">
			<list>
				<value>alfresco/module/${artifactId}/messages/subscriptions</value>
			</list>
		</property>
	</bean>

	<bean id="${groupId}.${artifactId}.subscriptionsDictionaryBootstrap" parent="lecmDictionaryBootstrap"
		  depends-on="ru.it.lecm.orgstructure.orgstructure-repo.orgBootstrap">
		<property name="dictionaries">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-subscriptions-roles-items.xml</value>
			</list>
		</property>
	</bean>

	<!-- Registration of subscriptions aspects models -->
	<bean id="${groupId}.${artifactId}.subscriptionsAspectBootstrap" parent="dictionaryModelBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-subscriptions-aspects-model.xml</value>
			</list>
		</property>
	</bean>

	<bean id="subscriptionScript" parent="baseScript"
		  class="ru.it.lecm.subscriptions.scripts.SubscriptionsWebScriptBean"
		  depends-on="subscriptionsService">
		<property name="extensionName">
			<value>subscription</value>
		</property>
		<property name="repositoryHelper">
			<ref bean="repositoryHelper"/>
		</property>
		<property name="subscriptionsService">
			<ref bean="subscriptionsService"/>
		</property>
	</bean>

	<util:constant id="SUBSCRIPTIONS_ROOT_ID" static-field="ru.it.lecm.subscriptions.beans.SubscriptionsService.SUBSCRIPTIONS_ROOT_ID"/>
	<util:constant id="SUBSCRIPTIONS_ROOT_NAME" static-field="ru.it.lecm.subscriptions.beans.SubscriptionsService.SUBSCRIPTIONS_ROOT_NAME"/>

	<bean id="subscriptionsService" class="ru.it.lecm.subscriptions.beans.SubscriptionsServiceImpl" parent="baseBean"
		  depends-on="nodeService, serviceOrgstructure, businessJournalService">
		<property name="orgstructureService" ref="serviceOrgstructure"/>
		<property name="businessJournalService" ref="businessJournalService"/>
		<property name="folders">
			<map>
				<entry key="#{SUBSCRIPTIONS_ROOT_ID}" value="#{SUBSCRIPTIONS_ROOT_NAME}"/>
			</map>
		</property>
	</bean>

	 <amq:queue id="bjQueueInternal" physicalName="bjQueueInternal" />

	<bean id="jmsFactorySub" class="org.apache.activemq.ActiveMQConnectionFactory" depends-on="broker">
		<property name="brokerURL" value="vm://localhost"/>
	</bean>

	<jms:listener-container container-type="default"
							connection-factory="jmsFactorySub"
							acknowledge="auto"
							concurrency="10-50">
		<jms:listener destination="bjQueueInternal" ref="listener"/>
	</jms:listener-container>

	<bean id="listener" class="ru.it.lecm.subscriptions.RecordsListener">
		<property name="nodeService">
			<ref bean="NodeService" />
		</property>
		<property name="subscriptionsService">
			<ref bean="subscriptionsService"/>
		</property>
		<property name="namespaceService" ref="namespaceService"/>
		<property name="notificationsService">
			<ref bean="notificationsService"/>
		</property>
		<property name="searchService">
			<ref bean="SearchService"/>
		</property>
		<property name="orgstructureService">
			<ref bean="serviceOrgstructure"/>
		</property>
		<property name="transactionService">
			<ref bean="transactionService"/>
		</property>
	</bean>

	<bean id="subscriptionToTypeOnCreateAssocsPolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsOnCreateAssocsPolicy"
		  init-method="init" parent="logicEcmAssociationPolicy"/>

	<bean id="subscriptionsToObjectLogEventsPolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToObjectLogEventsPolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
		<property name="orgstructureService">
			<ref bean="serviceOrgstructure"/>
		</property>
	</bean>

	<bean id="subscriptionsToTypeLogEventsEmployeePolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToTypeLogEventEmployeePolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
	</bean>

	<bean id="subscriptionsToTypeLogEventsWorkGroupPolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToTypeLogEventWorkGroupPolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
	</bean>

	<bean id="subscriptionsToTypeLogEventBusinessRolePolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToTypeLogEventBusinessRolePolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
	</bean>

	<bean id="subscriptionsToTypeLogEventsOrganizationUnitPolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToTypeLogEventOrganizationUnitPolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
	</bean>

	<bean id="subscriptionsToTypeLogEventsPolicy" class="ru.it.lecm.subscriptions.policy.SubscriptionsToTypeLogEventPolicy"
		  init-method="init">
		<property name="policyComponent">
			<ref bean="policyComponent"/>
		</property>
		<property name="businessJournalService">
			<ref bean="businessJournalService"/>
		</property>
		<property name="nodeService">
			<ref bean="nodeService"/>
		</property>
	</bean>

	<!-- Настройки прав доступа на каталоги в рамках сервиса -->
	<bean id="${groupId}.${artifactId}.subscriptionsServicePermissions" parent="ServiceFolderPermissionHelper"
		  depends-on="ru.it.lecm.subscriptions.subscriptions-repo.subscriptionsBootstrap, subscriptionsService" >
		<property name="serviceBean" ref="subscriptionsService"/>
		<property name="permissionsList">
			<list>
				<value>alfresco/module/${artifactId}/permissions/directories-permissions.xml</value>
			</list>
		</property>
	</bean>

    <bean id="subscriptions.arm.settings.LogicEcmBootstrap" parent="lecmDictionaryBootstrap"
          depends-on="arm.settings.LogicEcmBootstrap">
        <property name="rootPath" value="/Business platform/LECM/Сервис АРМ"/>
        <property name="dictionaries">
            <list>
                <value>alfresco/module/${artifactId}/arm/subscriptions-settings-arm.xml</value>
            </list>
        </property>
    </bean>

</beans>
