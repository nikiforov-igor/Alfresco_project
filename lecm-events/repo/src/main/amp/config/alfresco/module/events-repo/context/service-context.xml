<?xml version='1.0' encoding='UTF-8'?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
						   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

	<bean id="events.dictionaries.LogicEcmModelsBootstrap" parent="dictionaryModelBootstrap"
	      depends-on="dictionaryBootstrap,ru.it.lecm.dictionary.dictionary-repo.dictionary,
	        ru.it.lecm.contractors.lecm-contractors-repo.contractors-dictionary-bootstrap,
	        ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-events-dictionaries-model.xml</value>
			</list>
		</property>
		<property name="labels">
			<list>
				<value>alfresco/module/${artifactId}/messages/lecm-events-dictionaries-model</value>
			</list>
		</property>
	</bean>

	<bean id="events.LogicEcmContractsTableStructureBootstrap" parent="modelsToRepositoryLoader"
	      depends-on="documents.LogicEcmModelsBootstrap,
		      events.dictionaries.LogicEcmModelsBootstrap,
		      ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-events-table-structure-model.xml</value>
			</list>
		</property>
		<property name="labels">
			<list>
				<value>alfresco/module/${artifactId}/messages/lecm-events-table-structure-model</value>
			</list>
		</property>
	</bean>

	<bean id="events.LogicEcmInternalBootstrap" parent="modelsToRepositoryLoader"
	      depends-on="dictionaryBootstrap,
					 ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap,
					 documents.LogicEcmModelsConnectionsBootstrap,
					 documents.dictionaries.LogicEcmModelsBootstrap,
					 events.dictionaries.LogicEcmModelsBootstrap,
					 events.LogicEcmContractsTableStructureBootstrap">
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-events-model.xml</value>
			</list>
		</property>
		<property name="labels">
			<list>
				<value>alfresco/module/${artifactId}/messages/lecm-events-model</value>
			</list>
		</property>
	</bean>

	<bean id="events.LogicEcmConnectionTypesBootstrap" parent="lecmDictionaryBootstrap"
	      depends-on="events.dictionaries.LogicEcmModelsBootstrap">
		<property name="dictionaries">
			<list>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-locations.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-resources.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-locations-pl.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-resources-pl.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-br-items.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-connection-types-items.xml</value>
				<value>alfresco/module/${artifactId}/dictionaries/lecm-events-business-journal-objectType-items.xml</value>
			</list>
		</property>
	</bean>

	<bean id="lecm.events.thread.pool" class="org.alfresco.util.ThreadPoolExecutorFactoryBean">
		  <property name="poolName">
			  <value>barcodeServiceThreadPool</value>
		  </property>
		  <property name="corePoolSize">
			  <value>3</value>
		  </property>
		  <property name="maximumPoolSize">
			  <value>30</value>
		  </property>
	</bean>

	<util:constant id="EVENTS_ROOT_ID" static-field="ru.it.lecm.events.beans.EventsService.EVENTS_ROOT_ID"/>

	<bean id="eventsNotificationsService" class="ru.it.lecm.events.beans.EventsNotificationsService" parent="baseBean"
	      depends-on="events.LogicEcmInternalBootstrap, ServiceRegistry, nodeService, transactionService"> 
		  
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
		<property name="notificationsService" ref="notificationsService"/>
		<property name="mailService" ref="mailService"/>
		<property name="templateService" ref="templateService"/>
		<property name="contentService" ref="ContentService"/>
		<property name="defaultFromEmail" value="${mail.from.default}"/>
		<property name="threadPoolExecutor" ref="lecm.events.thread.pool"/>
		<property name="namespaceService" ref="namespaceService" />
		<property name="sendIcalToMembers" value="${lecm.events.sendIcalToMembers}" />		<!--default=false-->
		<property name="sendIcalToInvitedMembers" value="${lecm.events.sendIcalToInvitedMembers}" />	<!--default=true-->
		<property name="eventsService" ref="eventsService"/>
	</bean>
	
	<bean id="eventsService" class="ru.it.lecm.events.beans.EventsServiceImpl" parent="baseBean"
	      depends-on="events.LogicEcmInternalBootstrap, ServiceRegistry, nodeService, transactionService"
			init-method="init">
		<!-- Автоматическое создание каталогов. -->
		<property name="folders">
			<map>
				<entry key="#{EVENTS_ROOT_ID}" value="Сервис Мероприятия"/>
			</map>
		</property>
		<property name="dictionaryBean" ref="serviceDictionary"/>
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
		<property name="searchService" ref="searchService"/>
		<property name="workCalendarService" ref="WorkCalendarService"/>
		<property name="documentTableService" ref="documentTableService"/>
		<property name="notificationsService" ref="notificationsService"/>
		<property name="mailService" ref="mailService"/>
		<property name="templateService" ref="templateService"/>
		<property name="contentService" ref="ContentService"/>
		<property name="defaultFromEmail" value="${mail.from.default}"/>
		<property name="organizationQueryProcessor" ref="inUserOrganizationProcessor"/>
		<property name="threadPoolExecutor" ref="lecm.events.thread.pool"/>
		<property name="lecmPermissionService" ref="lecmPermissionServiceBean" />
		<property name="namespaceService" ref="namespaceService" />
		<property name="eventsNotificationsService" ref="eventsNotificationsService" />
		<property name="propsForFilterShowIncalendar">
			<list>
				<value>lecm-events:initiator-assoc-ref</value>
				<value>lecm-events:temp-members-assoc-ref</value>
				<value>lecm-meetings:chairman-assoc-ref</value>
				<value>lecm-meetings:secretary-assoc-ref</value>
			</list>
		</property>
	</bean>

	<bean id="eventsScript" parent="baseScript" class="ru.it.lecm.events.scripts.EventsWebScriptBean"
	      depends-on="nodeService, eventsService">
		<property name="extensionName">
			<value>events</value>
		</property>
		<property name="nodeService" ref="nodeService"/>
		<property name="eventService" ref="eventsService"/>
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
		<property name="dictionaryService" ref="dictionaryService"/>
        <property name="actionsService" ref="groupActionsService"/>
		<property name="lecmPermissionService" ref="lecmPermissionServiceBean"/>
	</bean>

	<bean id="eventsPolicy" class="ru.it.lecm.events.policy.EventsPolicy" parent="baseBean"
	       init-method="init" depends-on="documents.LogicEcmModelsBootstrap">
		<property name="policyComponent" ref="policyComponent"/>
		<property name="documentTableService" ref="documentTableService"/>
		<property name="lecmPermissionService" ref="lecmPermissionServiceBean" />
		<property name="eventService" ref="eventsService"/>
		<property name="notificationsService" ref="notificationsService"/>
		<property name="documentConnectionService" ref="documentConnectionService"/>
		<property name="mailService" ref="mailService"/>
		<property name="templateService" ref="templateService"/>
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
		<property name="contentService" ref="ContentService"/>
		<property name="defaultFromEmail" value="${mail.from.default}"/>
	</bean>

	<bean parent="lecmDictionaryBootstrap" depends-on="groupActionsService">
		<property name="rootPath" value="/Business platform/LECM/Сервис Групповые операции"/>
		<property name="dictionaries">
			<list>
				<value>alfresco/module/${artifactId}/actions/member-accept.xml</value>
				<value>alfresco/module/${artifactId}/actions/member-decline.xml</value>
				<value>alfresco/module/${artifactId}/actions/member-request-new-time.xml</value>
				<value>alfresco/module/${artifactId}/actions/create-copy.xml</value>
				<value>alfresco/module/${artifactId}/actions/ga-remove-event.xml</value>
				<value>alfresco/module/${artifactId}/actions/ga-remove-repeatable-event.xml</value>
				<value>alfresco/module/${artifactId}/actions/ga-event-send-notifications.xml</value>
				<value>alfresco/module/${artifactId}/actions/create-event-by-document.xml</value>
			</list>
		</property>
	</bean>

	<bean id="eventsWorkflowBootstrap" parent="workflowDeployer"
	      depends-on="statemachine.aspects.LogicEcmModelsBootstrap,
				     ru.it.lecm.orgstructure.orgstructure-repo.orgStructureBootstrap,">
		<property name="workflowDefinitions">
			<list>
				<props>
					<prop key="engineId">activiti</prop>
					<prop key="location">alfresco/module/${artifactId}/workflow/lecm-events-member-decline.bpmn20.xml</prop>
					<prop key="mimetype">text/xml</prop>
					<prop key="redeploy">${redeploy.process.definitions}</prop>
				</props>
				<props>
					<prop key="engineId">activiti</prop>
					<prop key="location">alfresco/module/${artifactId}/workflow/lecm-events-member-request-new-time.bpmn20.xml</prop>
					<prop key="mimetype">text/xml</prop>
					<prop key="redeploy">${redeploy.process.definitions}</prop>
				</props>
				<props>
					<prop key="engineId">activiti</prop>
					<prop key="location">alfresco/module/${artifactId}/workflow/lecm-events-remove-repeatable.bpmn20.xml</prop>
					<prop key="mimetype">text/xml</prop>
					<prop key="redeploy">${redeploy.process.definitions}</prop>
				</props>
			</list>
		</property>
		<property name="models">
			<list>
				<value>alfresco/module/${artifactId}/models/lecm-events-workflow-model.xml</value>
			</list>
		</property>
		<property name="labels">
			<list>
				<value>alfresco/module/${artifactId}/messages/lecm-events-workflow-model</value>
			</list>
		</property>
		<property name="repositoryWorkflowDefsLocations" ref="customWorkflowDefsRepositoryLocation"/>
	</bean>

	<bean id="events.defaultStatemachine" parent="defaultStatemachines">
		<property name="statemachineName" value="lecm-events:document" />
		<property name="path" value="alfresco/module/${artifactId}/models/lecm-events-default-statemacine.xml" />
	</bean>

	<bean id="events.eventsNotificationExecutor" class="ru.it.lecm.events.schedule.EventNotificationExecutor" parent="action-executer">
		<property name="ignoreLock" value="false"/>
		<property name="notificationsService" ref="notificationsService"/>
		<property name="nodeService" ref="nodeService"/>
		<property name="calendarBean" ref="WorkCalendarService"/>
		<property name="eventService" ref="eventsService"/>
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
		<property name="publicAction" value="false" />
		<property name="mailService" ref="mailService"/>
		<property name="defaultFromEmail" value="${mail.from.default}"/>
	</bean>

	<bean id="events.eventsNotificationSchedule" class="ru.it.lecm.events.schedule.EventNotificationSchedule">
		<property name="transactionMode">
			<value>ISOLATED_TRANSACTIONS</value>
		</property>
		<property name="compensatingActionMode">
			<value>IGNORE</value>
		</property>
		<property name="nodeService">
			<ref bean="nodeService"/>
		</property>
		<property name="cronExpression">
			<value>0 0 5 */1 * ?</value>
		</property>
		<property name="firstStartExpression">
			<value>0 */15 * * * ?</value>
		</property>
		<property name="onServerStart">
			<value>false</value>
		</property>
		<property name="jobName">
			<value>events-sys-agent-status</value>
		</property>
		<property name="jobGroup">
			<value>events-status</value>
		</property>
		<property name="triggerName">
			<value>events-sys-agent-status-trigger</value>
		</property>
		<property name="triggerGroup">
			<value>events-status-trigger</value>
		</property>
		<property name="scheduler">
			<ref bean="schedulerFactory"/>
		</property>
		<property name="actionService">
			<ref bean="ActionService"/>
		</property>
		<property name="transactionService">
			<ref bean="TransactionService"/>
		</property>
		<property name="runAsUser">
			<value>System</value>
		</property>
		<property name="documentService" ref="documentService"/>
		<property name="calendarBean" ref="WorkCalendarService"/>
		<property name="notificationsService" ref="notificationsService"/>
	</bean>

	<bean id="currentUserResoucesProcessor" class="ru.it.lecm.events.processor.CurrentResourcesProcessor" parent="searchQueryBaseProccesor">
		<property name="id" value="CURRENT_USER_RESOURCES"/>
		<property name="orgstructureBean" ref="serviceOrgstructure"/>
	</bean>

	<bean id="events.ConfigToRepositoryLoader" parent="configsToRepositoryLoader">
		<property name="configs">
			<list>
				<value>alfresco/module/events-repo/reports/configs/events.properties</value>
			</list>
		</property>
	</bean>

	<bean id="listOfUsedResourceTypes" parent="listOfUsedTypes">
		<property name="types">
			<map>
				<entry key="lecm-events-dic:resources" value="Ресурсы мероприятия"/>
			</map>
		</property>
	</bean>

	<bean id="events.reports.LogicEcmBootstrap" parent="lecmDictionaryBootstrap"
		  depends-on="reportsEditorService,reportsEditor.LogicEcmDictionariesBootstrap,
          reportsEditorOnCreateAssocsPolicy,reportsEditorTemplatePolicy,
          dataSourcePolicy,reportDescriptorPolicy">
		<property name="rootPath" value="/Business platform/LECM/Сервис Редактор Отчетов/Отчеты"/>
		<property name="dictionaries">
			<list>
				<value>alfresco/module/${artifactId}/reports/use-of-resources.xml</value>
				<value>alfresco/module/${artifactId}/reports/use-of-locations.xml</value>
			</list>
		</property>
		<property name="xmlImportListener" ref="events.reportsDeployer"/>
	</bean>

	<bean id="events.reportsDeployer" parent="reportsDeployer">
		<property name="reportsForDeploy">
			<list>
				<value>use-of-resources</value>
				<value>use-of-locations</value>
			</list>
		</property>
	</bean>

</beans>
