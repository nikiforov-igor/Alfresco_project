<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.it.ru/logicECM/workflow/signing">
	<process id="lecmSign" name="Последовательное подписание" isExecutable="true">
		<extensionElements>
			<activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var isSigned = execution.getVariable("isSigned");
						var isSignedValue = Packages.java.lang.Boolean.TRUE.equals(isSigned);
						if (!isSignedValue) {
							signingWorkflow.dropSigningResults(resultListRef);
						}
						signingWorkflow.deleteTempAssigneesList(execution);
						signingWorkflow.saveRouteApprovalResult(bpm_package, isSignedValue);
					]]></activiti:string>
				</activiti:field>
			</activiti:executionListener>
			<activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string><![CDATA[
						execution.setVariable("isSigned", Packages.java.lang.Boolean.FALSE);
					]]></activiti:string>
				</activiti:field>
			</activiti:executionListener>
		</extensionElements>
		<startEvent id="start-signing" name="Start Signing" activiti:formKey="lecmSign:signing"/>
		<endEvent id="end-signing" name="End Signing"/>
		<serviceTask id="empty-task" name="Empty task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<receiveTask id="receive-task" name="Receive Task"/>
		<serviceTask id="create-signing-list" name="Create signing list" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var assignees = execution.getVariable("lecm-workflow_assigneesListAssoc");
						var assigneesList = signingWorkflow.createAssigneesList(assignees, execution);
						execution.setVariableLocal("assigneesList", assigneesList);
						var resultListRef = signingWorkflow.createResultList(bpm_package, documentAttachmentCategoryName, assigneesList);
						execution.setVariable("resultListRef", resultListRef);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<userTask id="sequential-signing-task" name="Подписать документ" activiti:assignee='${assignee.properties["{http://www.it.ru/logicECM/model/workflow/1.0}userName"]}' activiti:formKey="lecmSign:signTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							signingWorkflow.assignTask(assignee, task);
							var employee = assignee.assocs["{http://www.it.ru/logicECM/model/workflow/1.0}assignee-employee-assoc"][0];
							statemachine.grandDynamicRoleForEmployee(bpm_package.children[0], employee, "DA_SIGNER_DYN");
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var taskDecision = signingWorkflow.completeTask(assignee, task);
							var resultListRef = task.getVariable("resultListRef");
							signingWorkflow.logDecision(resultListRef, taskDecision);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
			<multiInstanceLoopCharacteristics isSequential="true" activiti:collection="${assigneesList}" activiti:elementVariable="assignee">
				<completionCondition>${"REJECTED" == taskDecision}</completionCondition>
			</multiInstanceLoopCharacteristics>
		</userTask>
		<serviceTask id="notify-task" name="Notification Task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var workflowId = "activiti$" + execution.getProcessInstanceId();
						signingWorkflow.notifyDeadlineTasks(workflowId, bpm_package, execution);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<serviceTask id="final-task" name="Final Task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var decisionsMap = execution.getVariable("decisionsMap");
						var resultListRef = execution.getVariable("resultListRef");
						var finalDecision = signingWorkflow.getFinalDecision(decisionsMap);
						var isSigned = signingWorkflow.isSigned(finalDecision);
						execution.setVariable("finalDecision", finalDecision);
						execution.setVariable("isSigned", isSigned);
						signingWorkflow.logFinalDecision(resultListRef, finalDecision);
						signingWorkflow.notifySigningFinished(finalDecision, bpm_package);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<boundaryEvent id="sequential-timer" name="Sequential Timer" attachedToRef="sequential-signing-task" cancelActivity="false">
			<timerEventDefinition>
				<timeCycle>0 0 0/4 * * ?</timeCycle>
			</timerEventDefinition>
		</boundaryEvent>
		<sequenceFlow id="start-to-emptyTask" sourceRef="start-signing" targetRef="empty-task"/>
		<sequenceFlow id="emptyTask-to-receiveTask" sourceRef="empty-task" targetRef="receive-task"/>
		<sequenceFlow id="receiveTask-to-createListTask" sourceRef="receive-task" targetRef="create-signing-list"/>
		<sequenceFlow id="createListTask-to-signingTask" sourceRef="create-signing-list" targetRef="sequential-signing-task"/>
		<sequenceFlow id="signingTask-to-FinalTask" sourceRef="sequential-signing-task" targetRef="final-task"/>
		<sequenceFlow id="finalTask-to-End" sourceRef="final-task" targetRef="end-signing"/>
		<sequenceFlow id="timer-to-notifyTask" sourceRef="sequential-timer" targetRef="notify-task"/>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_lecmSign">
		<bpmndi:BPMNPlane bpmnElement="lecmSign" id="BPMNPlane_lecmSign">
			<bpmndi:BPMNShape bpmnElement="start-signing" id="BPMNShape_start-signing">
				<omgdc:Bounds height="35.0" width="35.0" x="40.0" y="250.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="end-signing" id="BPMNShape_end-signing">
				<omgdc:Bounds height="35.0" width="35.0" x="870.0" y="250.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="empty-task" id="BPMNShape_empty-task">
				<omgdc:Bounds height="55.0" width="105.0" x="120.0" y="240.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="receive-task" id="BPMNShape_receive-task">
				<omgdc:Bounds height="55.0" width="105.0" x="260.0" y="240.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="create-signing-list" id="BPMNShape_create-signing-list">
				<omgdc:Bounds height="55.0" width="105.0" x="400.0" y="240.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-signing-task" id="BPMNShape_sequential-signing-task">
				<omgdc:Bounds height="55.0" width="105.0" x="560.0" y="240.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="notify-task" id="BPMNShape_notify-task">
				<omgdc:Bounds height="55.0" width="105.0" x="562.0" y="350.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="final-task" id="BPMNShape_final-task">
				<omgdc:Bounds height="55.0" width="105.0" x="710.0" y="240.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="sequential-timer" id="BPMNShape_sequential-timer">
				<omgdc:Bounds height="30.0" width="30.0" x="600.0" y="280.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="createListTask-to-signingTask" id="BPMNEdge_createListTask-to-signingTask">
				<omgdi:waypoint x="505.0" y="267.0"/>
				<omgdi:waypoint x="560.0" y="267.0"/>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>