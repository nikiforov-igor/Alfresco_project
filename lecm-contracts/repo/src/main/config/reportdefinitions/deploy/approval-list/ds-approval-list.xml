<?xml version="1.0" encoding="UTF-8"?>
<!--
http://127.0.0.1:8080/alfresco/service/lecm/report/approval-list?nodeRef=workspace://SpacesStore/30d84120-f216-4050-9d10-f4ca94755e72&exec=1

"Лист согласования" по указанному Id списка согласования:
Входные параметры:
	•	Id списка Согласования для формирования отчёта (с типом "lecmApprovalResult:approvalResultList")

Выходные данные отчета:
	•	№ проекта договора
	•	№ версии документа
	•	Дата начала согасования

	(!) Вложенная таблица Согласующих подгружается как основная часть

	Сами отдельные согласования:
			<child-association name="lecm-workflow-result:workflow-result-list-workflow-result-item-assoc">
				<target><class>lecmApprovalResult:approvalResultItem</class></target>
			</child-association>

	•	Результат согласования сотрудником
	•	Замечания
	•	Дата согласования

	•	Для Сотрудника-Исполнителя: ФИО, Должность, Подразделение
			через "lecmApprovalResult:approvalResultItem" ассоциацию
			== ссылка на элемент справочника "Сотрудники" ==
			<association name="lecm-workflow-result:workflow-result-item-employee-assoc">
				<target><class>lecm-orgstr:employee</class>
				</target>
			</association>

В конце:
	•	Результат Согласования
	•	Дата согласования по документу

	Обозначение ссылок на поля:

	== лист согласования ==
		col_AproveList.XXX
				<type name="lecmApprovalResult:approvalResultList">
				"текущий объект"

	== Договор-контракт ==
		col_Doc.XXX
				<type name="lecm-contract:document">
				ссылка на документ из "текущего объекта"
				вверх по
				== Ссылка на документ, приложенный согласующим сотрудником ==
						из <Согласующий сотрудник> of <type name="lecmApprovalResult:approvalResultItem">
				by	<association name="lecmApprovalResult:approvalResultItemCommentAssoc">
						<target><class>cm:content</class></target>
					</association>

	== Заполненое Согласование Сотрудника ==
		col_Item.XXX
				<type name="lecmApprovalResult:approvalResultItem">
				ссылка из "текущего объекта"
				вниз по <child-association name="lecm-workflow-result:workflow-result-list-workflow-result-item-assoc">
				на <target>

	== Согласующий сотрудник ==
	== ссылка на элемент справочника "Сотрудники" ==
		col_ItemEmployee.XXX
				<type name="lecm-orgstr:employee">
				ссылка из col_Item
				вниз по <association name=""lecm-workflow-result:workflow-result-item-employee-assoc">
				на <target>
  -->
<ds.config>
	<report.descriptor mnem="approval-list">
		<l18> <item key="RU_RU" value="Лист согласования"/>
		</l18>

		<provider mnem="DSProviderApprovalById" javaClass="ru.it.lecm.contracts.reports.DSProviderApprovalById" >
			<l18> <item key="RU_RU" value="Провайдер Jasper отчётов: Лист согласования"/>
			</l18>
		</provider>
        <templates>
            <template mnem="approval-list" type="JASPER" filename="approval-list.jrxml"/>
        </templates>
        <roles>CONTRACT_READER,CONTRACT_RECORDER,CONTRACT_EXECUTOR,CONTRACT_CURATOR,CONTRACT_SIGNER</roles>
	</report.descriptor>

	<query.descriptor>
		<offset>0</offset>
		<limit>-1</limit>
		<pgsize>-1</pgsize>
		<allVersions>true</allVersions>

		<preferedType>lecmApprovalResult:approvalResultList</preferedType>

		<isMultiRow>false</isMultiRow>
		<isCustom>false</isCustom>

		<queryText><![CDATA[+TYPE:"lecmApprovalResult:approvalResultList"]]></queryText>

		<flags>
				<!-- соответствия входных параметров (values) свойствам бина провайдера (keys) -->
				<property.nodeRef> <![CDATA[ID;id]]> </property.nodeRef>
		</flags>

	</query.descriptor>

	<!-- отображаемые значения для кодов для
		 результат согласования документа = "lecmApprovalResult:approvalResultListDecision"
		 locale="RU_RU"
	  -->
	<statuses.valueDisplay>
		<map>
			<item key="NO_DECISION" value="Нет решения"/>
			<item key="APPROVED" value="Согласовано"/>
			<item key="APPROVED_WITH_REMARK" value="Согласован с замечанием"/>
			<item key="APPROVED_FORCE" value="Согласование принудительно завершено"/>
			<item key="REJECTED" value="Отклонено"/>
			<item key="REJECTED_FORCE" value="Отозван с согласования"/>
			<item key="REASSIGNED" value="Переназначить"/>
		</map>
	</statuses.valueDisplay>

	<fields>
		<field order="1"  alfrescoType="d:text"  javaValueClass="java.lang.String"
				jrFldName="ID"  queryFldName="{{ID}}">
				displayName="ID документа"
			<l18>
				<item key="RU_RU" value="ID документа"/>
			</l18>
		</field>

		<!-- "lecm-contract:document": Регистрационный номер проекта договора-->
		<field queryFldName="{lecm-contract:regNumProject}"
				jrFldName="col_Doc.ProjectNum"
				displayName="Номер проекта договора"/>

		<!-- approval-list: номер версии документа, по которой проводилось согласование -->
		<field queryFldName="lecm-workflow-result:workflow-result-list-document-version"
				jrFldName="col_AproveList.Version"
				displayName="Номер версии документа"/>

		<!-- approval-list: результат согласования документа -->
		<field queryFldName="lecmApprovalResult:approvalResultListDecision"
				jrFldName="col_AproveList.ApproveResult"
				displayName="Результат Согласования"/>

		<!-- approval-list: дата начала согласования -->
		<field queryFldName="lecm-workflow-result:workflow-result-list-start-date"
				jrFldName="col_AproveList.ApproveStart"
				displayName="Дата начала согасования по документу" javaValueClass="date"/>

		<!-- approval-list: дата согласования по документу -->
		<field queryFldName="lecm-workflow-result:workflow-result-list-complete-date"
				jrFldName="col_AproveList.ApproveEnd"
				displayName="Дата согласования по документу" javaValueClass="date"/>

		<!-- Для Сотрудника-Исполнителя: ФИО -->
		<field queryFldName="{ExecEmployee{lecm-orgstr:employee-short-name}}"
				jrFldName="col_ExecEmployee"
				displayName="Исполнитель" />

		<!-- Для Сотрудника-Исполнителя: Должность (!) вычисляемое -->
		<field queryFldName="{ExecEmployee.StaffPosition{sys:node-uuid}}"
				jrFldName="col_ExecEmployee.StaffPosition.Id"
				displayName="Должность Исполнителя.id" javaValueClass="String"/>
		<field queryFldName="{ExecEmployee.StaffPosition{cm:name}}"
				jrFldName="col_ExecEmployee.StaffPosition.Name"
				displayName="Должность Исполнителя.Название"/>

		<!-- Для Сотрудника-Исполнителя: Подразделение (!) вычисляемое -->
		<field queryFldName="{ExecEmployee.Unit{sys:node-uuid}}"
				jrFldName="col_ExecEmployee.Unit.Id"
				displayName="Отдел Исполнителя.id" javaValueClass="String"/>
		<field queryFldName="{Employee.Unit{cm:name}}"
				jrFldName="col_ExecEmployee.Unit.Name"
				displayName="Наименование отдела Исполнителя"/>

		<!-- ===
				отдельные согласования: lecmApprovalResult:approvalResultItem
			 ===
		  -->

		 <!-- "lecmApprovalResult:approvalResultItem": Результат согласования сотрудником -->
		<field queryFldName="{lecm-workflow-result:workflow-result-list-workflow-result-item-assoc/lecmApprovalResult:approvalResultItemDecision}"
				jrFldName="col_Item.ApproveResult"
				displayName="Результат Согласования Сотрудником"/>

		<!-- "lecmApprovalResult:approvalResultItem": замечания сотрудника -->
		<field queryFldName="lecm-workflow-result:workflow-result-list-workflow-result-item-assoc/lecmApprovalResult:approvalResultItemComment"
				jrFldName="col_Item.ApproveNotes"
				displayName="Замечания от Сотрудника"/>

		<!-- "lecmApprovalResult:approvalResultItem": Дата согласования сотрудника -->
		<field queryFldName="lecm-workflow-result:workflow-result-list-workflow-result-item-assoc/lecm-workflow-result:workflow-result-item-finish-date"
				jrFldName="col_Item.ApproveDate"
				displayName="Дата согласования Сотрудником" javaValueClass="date"/>

		<!-- Для Сотрудника-Согласующего: ФИО -->
		<field queryFldName="{{ApproveEmployee} is {lecm-workflow-result:workflow-result-list-workflow-result-item-assoc/lecm-workflow-result:workflow-result-item-employee-assoc/lecm-orgstr:employee-short-name}}"
				jrFldName="col_Item.Employee"
				displayName="Согласующий" />

		<!-- Для Сотрудника-Согласующего: Должность (!) вычисляемое -->
		<field queryFldName="{ApproveEmployee.StaffPosition{sys:node-uuid}}"
				jrFldName="col_Item.Employee.StaffPosition.Id"
				displayName="Должность Сотрудника" javaValueClass="String"/>
		<field queryFldName="{ApproveEmployee.StaffPosition{cm:name}}"
				jrFldName="col_Item.Employee.StaffPosition.Name"
				displayName="Должность название" />

		<!-- Для Сотрудника-Согласующего: Подразделение (!) вычисляемое -->
		<field queryFldName="{ApproveEmployee.Unit{sys:node-uuid}}"
				jrFldName="col_Item.Employee.Unit.Id"
				displayName="Отдел Согласующего.id" javaValueClass="String"/>
		<field queryFldName="{ApproveEmployee.Unit{cm:name}}"
				jrFldName="col_Item.Employee.Unit.Name"
				displayName="Отдел Согласующего.Наименование" />

	</fields>

</ds.config>