<?xml version="1.0" encoding="UTF-8"?>
<ds.config>
    <report.descriptor mnem="contract-stages-info">
        <l18>
            <item key="RU_RU" value="Досье договора с этапами"/>
        </l18>
        <type mnem="JASPER">
            <l18>
                <item key="RU_RU" value="Jasper"/>
            </l18>
        </type>
        <provider
            javaClass="ru.it.lecm.reports.generators.GenericDSProviderBase" mnem="DocInfoProvider">
            <l18>
                <item key="RU_RU" value="Информации по документу"/>
            </l18>
        </provider>
        <template filename="contract_stages_info.jrxml" mnem="Этапы договора">
            <l18>
                <item key="RU_RU" value="Этапы договора"/>
            </l18>
        </template>
    </report.descriptor>

    <query.descriptor>
        <offset>0</offset>
        <limit>-1</limit>
        <pgsize>-1</pgsize>
        <queryText><![CDATA[]]></queryText>
        <allVersions>true</allVersions>
        <preferedType>{lecm-contract:document}</preferedType>
        <isMultiRow>false</isMultiRow>
        <isCustom>false</isCustom>
        <flags>
            <property.nodeRef> <![CDATA[ID;id]]> </property.nodeRef>
        </flags>
    </query.descriptor>

	<subreports>
	<!-- Описание данных для связанных Задач подотчёта  -->
	<subreport name="stages" destColumnName="Col_Stages" >
		<!-- ссылка на вложенные задачи -->
		<sublist.source>
			<![CDATA[{lecm-contract-table-structure:stages-assoc/cm:contains/cm:name}]]>
		</sublist.source>
        <sublist.type><![CDATA[lecm-contract-table-structure:stage]]></sublist.type>
		<sublist.item beanclass="ru.it.lecm.contracts.reports.wrappers.StageInfoBean">
			<map>
				<item key="name"> <![CDATA[lecm-contract-table-structure:name]]> </item>
				<item key="startDate"> <![CDATA[lecm-contract-table-structure:start-date]]> </item>
				<item key="endDate"> <![CDATA[lecm-contract-table-structure:end-date]]> </item>
				<item key="status"> <![CDATA[{lecm-contract-table-structure:status-assoc/cm:name}]]> </item>
				<item key="responsibleName"> <![CDATA[{lecm-contract-table-structure:responsible-assoc/lecm-orgstr:employee-short-name}]]> </item>
			</map>
		</sublist.item>
	</subreport>
	</subreports>


    <fields>
        <!-- Инициатор договора == Автор "lecm-orgstr:employee" -->
        <field jrFldName="col_Initiator" queryFldName="{{@AUTHOR/lecm-orgstr:employee-short-name}}" displayName="Инициатор" />
        <field jrFldName="col_Initiator.Phone" queryFldName="{{@AUTHOR/lecm-orgstr:employee-phone}}" displayName="Инициатор.Телефон" />

        <!-- Статус -->
        <field jrFldName="col_Status" queryFldName="{lecm-statemachine:status}" displayName="Статус" />

        <!-- Дата изменения статуса -->
        <field jrFldName="col_StatusDate" queryFldName="{lecm-document:status-changed-date}" displayName="Дата смены статус"
               javaValueClass="java.util.Date"/>

        <!-- "Общая сумма по договору": "lecm-contract:totalAmount"
             и "Валюта договора": (assoc) "lecm-contract:currency-assoc"
                -> target: "lecm-currency:currency
          -->
        <field jrFldName="col_Sum" queryFldName="{lecm-contract:totalAmount}" displayName="Сумма договора" javaValueClass="java.lang.Float"/>
        <field jrFldName="col_SumUnits" queryFldName="{lecm-contract:currency-assoc/lecm-currency:alphabetic-code}" displayName="Валюта договора" javaValueClass="String"/>

        <!-- Данные по "Виду договора" (с типом "lecm-contract-dic:contract-type") -->
        <field jrFldName="col_DocKind" queryFldName="{lecm-contract:typeContract-assoc/cm:name}" displayName="Вид договора" />

        <field queryFldName="{lecm-contract:regNumSystem}"
               jrFldName="col_Regnum"
               displayName="Регистрационный номер договора" javaValueClass="String"/>

        <!-- Дата заключения договора -->
        <field jrFldName="col_ConclusionDate" queryFldName="{lecm-contract:dateConclusionContracts}" displayName="Дата заключения"
               javaValueClass="date"/>

        <!-- Регистрационный номер проекта договора-->
        <field queryFldName="{lecm-contract:regNumProject}"
               jrFldName="col_RegnumProject"
               displayName="Регистрационный номер проекта договора" javaValueClass="String"/>

        <!-- Регистрационный номер контрагента -->
        <field queryFldName="{lecm-contract:regNumContractor}"
               jrFldName="col_RegnumContractor"
               displayName="Регистрационный номер контрагента" javaValueClass="String"/>

        <!-- Полное наименование котрагента "lecm-contract:partner-assoc": target "lecm-contractor:contractor-type"
            и пр атрибуты котрагента
          -->
        <field jrFldName="col_Contragent.fullname"  queryFldName="{lecm-contract:partner-assoc/lecm-contractor:fullname}" displayName="Контрагент.Полное наименование"/>
        <field jrFldName="col_Contragent.name"  queryFldName="{lecm-contract:partner-assoc/lecm-contractor:shortname}" displayName="Контрагент.Короткое"/>
        <field jrFldName="col_Contragent.phone" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:phone}" displayName="Контрагент.Тел" />

        <field jrFldName="col_Contragent.YurAddress" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:legal-address}" displayName="Контрагент.Юридический адрес" />
        <field jrFldName="col_Contragent.PhisAddress" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:physical-address}" displayName="Контрагент.Фактический адрес" />

        <!-- БИК Контрагента -->
        <field jrFldName="col_Contragent.BIK" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:BIK}" displayName="Контрагент.БИК" />

        <!-- Наименование банка Контрагента -->
        <field jrFldName="col_Contragent.Bankname" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:bankname}" displayName="Контрагент.БИК" />

        <!-- Расчетный счет -->
        <field jrFldName="col_Contragent.TransactAccount" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:transactional-account}" displayName="Контрагент.Расчётный счёт" />

        <!-- Корреспондентский счет -->
        <field jrFldName="col_Contragent.CorrAccount" queryFldName="{lecm-contract:partner-assoc/lecm-contractor:correspondent-account}" displayName="Контрагент.Корреспондентский счет" />

        <!--Представители (типа "lecm-representative:representative-type")
            Фамилия Имя Отчество и Должность
          -->
        <field jrFldName="col_Executor.Family" queryFldName="{lecm-contract:representative-assoc/lecm-representative:surname}" displayName="КонтрагентаИсполнитель.Фамилия" />
        <field jrFldName="col_Executor.Name" queryFldName="{lecm-contract:representative-assoc/lecm-representative:firstname}" displayName="КонтрагентаИсполнитель.Имя" />
        <field jrFldName="col_Executor.Otchestvo" queryFldName="{lecm-contract:representative-assoc/lecm-representative:middlename}" displayName="КонтрагентаИсполнитель.Отчество" />
        <field jrFldName="col_Executor.Staff" queryFldName="{lecm-contract:representative-assoc/lecm-representative:rank}" displayName="КонтрагентаИсполнитель.Должность" />

        <!-- Дата начала действия договора -->
        <field jrFldName="col_DateStart" queryFldName="{lecm-contract:startDate}" displayName="Дата начала действия договора"
               javaValueClass="java.util.Date"/>

        <!-- Дата окончания действия договора -->
        <field jrFldName="col_DateEnd" queryFldName="{lecm-contract:endDate}" displayName="Дата окончания действия договора"
               javaValueClass="java.util.Date"/>

        <!-- Бессрочный -->
        <field jrFldName="col_ContractIsUnlimited" queryFldName="{lecm-contract:unlimited}" displayName="Договор бессрочный"
               javaValueClass="boolean"/>

        <!--  Местонахождение договора -->
        <field jrFldName="col_Contract.Placehold" queryFldName="{lecm-contract:locationContract}" displayName="Местонахождение договора" />

        <!-- Место регистрации -->
        <field jrFldName="col_Contract.RegPlace" queryFldName="{lecm-contract:locationRegistration}" displayName="Место регистрации договора" />


        <!-- Данные по "Тематика договора" (с типом "lecm-doc-dic:subjects") -->
        <field jrFldName="col_Theme.code" queryFldName="{lecm-contract:subjectContract-assoc/lecm-doc-dic:subject-code}" displayName="Тематика.Код" />
        <field jrFldName="col_Theme.tname" queryFldName="{lecm-contract:subjectContract-assoc/cm:name}" displayName="Тематика.Название" />
        <field jrFldName="col_Theme.desc" queryFldName="{lecm-contract:subjectContract-assoc/lecm-doc-dic:subject-description}" displayName="Тематика.Описание" />

        <!-- Для подотчетов-->
        <field alfrescoType="d:text" displayName="Этапы договора"
            jrFldName="Col_Stages" queryFldName="{{subreport::stages}}">
            <l18>
                <item key="RU_RU" value="Этапы договора"/>
            </l18>
        </field>
    </fields>
</ds.config>
