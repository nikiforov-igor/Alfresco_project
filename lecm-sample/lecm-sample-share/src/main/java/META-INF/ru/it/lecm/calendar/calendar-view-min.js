(function(){var F=YAHOO.util.Dom,E=YAHOO.util.Event,k=YAHOO.util.Selector,O=Alfresco.util.fromISO8601,d=Alfresco.util.toISO8601,t=Alfresco.thirdparty.dateFormat;Alfresco.CalendarView=function u(P){this.id=P;Alfresco.CalendarView.superclass.constructor.call(this,"Alfresco.CalendarView",P,["calendar","button","resize","datasource","datatable","history"]);return this};YAHOO.extend(Alfresco.CalendarView,Alfresco.component.Base,{widgets:{},modules:{},popups:{},handlers:{},data:{},calendarView:"",initEvents:function a(){E.on(this.id,"click",this.onInteractionEvent,this,true);E.on(this.id,"dblclick",this.onInteractionEvent,this,true);YAHOO.Bubbling.on("eventEdited",this.onEventEdited,this);YAHOO.Bubbling.on("eventEditedAfter",this.onAfterEventEdited,this);YAHOO.Bubbling.on("eventSaved",this.onEventSaved,this);YAHOO.Bubbling.on("eventSavedAfter",this.onAfterEventSaved,this);YAHOO.Bubbling.on("eventDeleted",this.onEventDeleted,this);YAHOO.Bubbling.on("eventDeletedAfter",this.onAfterEventDeleted,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);YAHOO.Bubbling.on("viewChanged",this.onViewChanged,this);YAHOO.Bubbling.on("dateChanged",this.onCalSelect,this);YAHOO.Bubbling.on("formValidationError",this.onFormValidationError,this);if(this.calendarView==Alfresco.CalendarView.VIEWTYPE_DAY|this.calendarView==Alfresco.CalendarView.VIEWTYPE_WEEK){YAHOO.Bubbling.on("eventResized",this.onEventResized,this)}},getEvents:function n(){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"calendar/events/"+this.options.siteId+"/user",dataObj:{from:d(this.options.startDate).split("T")[0],to:d(this.options.endDate).split("T")[0],repeating:"all"},successCallback:{fn:this.onEventsLoaded,scope:this},failureMessage:Alfresco.util.message("load.fail","Alfresco.CalendarView")})},render:function w(){if(this.calendarView===Alfresco.CalendarView.VIEWTYPE_AGENDA){this.initEvents();this.getEvents(t(this.options.startDate,"yyyy-mm-dd"))}else{this.renderEvents()}},displayMessage:function j(Q,P){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(Q,P||this.name)})},getEventObj:function L(P){if(typeof(P.rel)!=="undefined"&&P.rel!==""){return this.parseRel(P)}else{return P}},getRel:function q(P){return P.from.split("T")[0]},parseRel:function l(S){var U,T="",Q="",P=false;if(k.test(S,"div.yui-dt-liner")){S=F.getElementsByClassName("summary","a",S.parentNode.parentNode)[0]}if(S.rel!==""&&S.rel!==undefined){Q=S.rel;T=this.widgets.Data[Q].events;for(var R=0;R<T.length;R++){if(T[R].uri==="/calendar/event/"+S.href.split("/calendar/event/")[1]){P=T[R]}}}return P},toggleEarlyTableRows:function N(){var S=YAHOO.util.Dom.get("collapseTrigger");this.earlyEls=YAHOO.util.Dom.getElementsByClassName("early","tr",S.parentNode);var P=(YAHOO.env.ua.ie)?"block":"table-row";for(var Q=0;Q<this.earlyEls.length;Q++){var R=this.earlyEls[Q];YAHOO.util.Dom.setStyle(R,"display",(this.isShowingEarlyRows)?"none":P)}this.isShowingEarlyRows=!this.isShowingEarlyRows},onEventsLoaded:function y(Q){var U=YAHOO.lang.JSON.parse(Q.serverResponse.responseText).events;var W=[];var ab=[];var S=null;var aa=this.options.startDate;var Y=this.options.endDate;var P=this.options.siteId;YAHOO.Bubbling.fire("eventDataLoad",U);for(var T=0;T<U.length;T++){var X=U[T];X.title=Alfresco.util.encodeHTML(X.title);X.where=Alfresco.util.encodeHTML(X.where);if(X.site==P){W.push(X)}}U=W;S=function(){return function(ae,ag){var ad=(ae<=aa&&Y<=ag);var ac=(ae>=aa&&ae<Y);var af=(ag>=aa&&ag<Y);return(ad||ac||af)}}.apply(this);for(var T=0;T<U.length;T++){var X=U[T];var R=O(X.startAt.iso8601);var V=O(X.endAt.iso8601);if(S(R,V)){var Z={};Z.desc=X.description||"";Z.name=X.title;Z.isoutlook=X.isoutlook=="true"?"isoutlook":"";Z.contEl="div";Z.from=X.startAt.iso8601;Z.to=X.endAt.iso8601;Z.uri="/calendar/event/"+this.options.siteId+"/"+X.name+"?date="+X.startAt.iso8601;Z.hidden="";Z.allday="";Z.isMultiDay=(!Alfresco.CalendarHelper.isSameDay(R,V));Z.isAllDay=(X.allday=="true")?true:false;Z.el="div";Z.key=Z.from.split(":")[0]+":00";Z=YAHOO.lang.merge(X,Z);ab.push(Z)}}this.renderEvents(ab)},add:function A(Q,P){this.add(Q,P)},remove:function o(P){this.remove(P)},update:function x(Q,P){this.data.update(P)},filterMultiday:function H(aa){var S=YAHOO.widget.DateMath;for(var U=0,Z=aa.length;U<Z;U++){var P=aa[U];if(P.isMultiDay){var X=P.from.split("T"),Y=P.to.split("T"),V=O(X[0]),R=O(Y[0]),W=new Date(V+86400000);if(!P.isAllDay){P.displayEnd="00:00"}for(var T=0,W=S.add(V,S.DAY,1);W.getTime()<=R.getTime();W=S.add(W,S.DAY,1)){var Q=YAHOO.lang.merge(P);Q.isCloned=true;Q.clonedFromDate=P.from;if(!P.isAllDay){if(!Alfresco.CalendarHelper.isSameDay(W,R)){Q.isAllDay=true}else{Q.displayStart="00:00";delete Q.displayEnd}}Q.displayFrom=d(W);aa.push(Q)}}}return aa},removeMultipleDayEvents:function h(Q){var S=F.getElementsByClassName(Q.id+"-multiple");for(var R=0,P=S.length;R<P;R++){S[R].parentNode.removeChild(S[R])}},getClickedDate:function J(Q){var P=this.options.titleDate;if(Q.nodeName.toUpperCase()!=="TD"){Q=F.getAncestorByTagName(Q,"td")}if(Q){P=O(Q.id.replace("cal-",""))}return P},showAddDialog:function B(Q){var P;if(YAHOO.lang.isUndefined(Q)){this.currentDate=P=(Alfresco.util.getQueryStringParameter("date"))?O(Alfresco.util.getQueryStringParameter("date")):new Date()}else{this.currentDate=P=Q}if(this.eventDialog){this.eventDialog.dialog.destroy();delete this.eventDialog}var R=new Alfresco.EventInfo(this.id);this.eventDialog=R.initEditDialog({actionUrl:Alfresco.constants.PROXY_URI+"calendar/create",ajaxSubmitMethod:Alfresco.util.Ajax.POST,displayDate:P,templateRequestParams:{site:this.options.siteId},onSuccess:{fn:this.onEventSaved,scope:this},onFailure:{fn:this.onEventSaveFailed,scope:this}});this.eventDialog.show()},showDialog:function(Q,R){var P=this.getEventObj(R);this.setUpDialog(Q,R,P);if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.show(P)}E.preventDefault(Q)},deleteDialog:function(Q,R){var P=this.getEventObj(R);this.setUpDialog(Q,R,P);this.eventInfoPanel.onDeleteClick();E.preventDefault(Q)},editDialog:function(Q,R){var P=this.getEventObj(R);this.setUpDialog(Q,R,P);this.eventInfoPanel.onEditClick();E.preventDefault(Q)},setUpDialog:function(Q,R,P){var S=document.createElement("div");S.id="eventInfoPanel";document.body.appendChild(S);this.eventInfoPanel=new Alfresco.EventInfo(this.id);this.eventInfoPanel.event=P;if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.setOptions({siteId:this.options.siteId,eventUri:P.uri.substring(1,P.uri.length),displayDate:this.currentDate,event:P,permitToEditEvents:this.options.permitToCreateEvents})}},isValidDateForView:function(P){return(P.getTime()>=this.options.startDate.getTime())&&(P.getTime()<this.options.endDate.getTime())},onCancelDialog:function z(){this.eventDialog.hide()},onDateSelected:function D(S,P,R){if(this.currPopUpCalContext){for(var Q=1;Q<P[0][0].length;Q++){P[0][0][Q]=Alfresco.CalendarHelper.padZeros(P[0][0][Q])}F.get(this.currPopUpCalContext).value=P[0][0].join("-");if(this.currPopUpCalContext==="dtend"){F.get(this.currPopUpCalContext+"time").value=YAHOO.widget.DateMath.add(O(F.get("dtstart").value+"T"+F.get("dtstarttime").value),YAHOO.widget.DateMath.HOUR,1).format(t.masks.isoTime)}}},onReady:function i(){this.calendarView=this.options.view;this.startDate=(YAHOO.lang.isString(this.options.startDate))?O(this.options.startDate):this.options.startDate;this.container=F.get(this.id);this.containerRegion=F.getRegion(this.container);this.isShowingEarlyRows=true;this.titleEl=F.get("calTitle");if(!YAHOO.widget.DateMath.HOUR){YAHOO.widget.DateMath.add=function(){var P=YAHOO.widget.DateMath.add;YAHOO.widget.DateMath.HOUR="H";YAHOO.widget.DateMath.SECOND="S";YAHOO.widget.DateMath.MINUTE="Mn";return function(R,T,S){switch(T){case YAHOO.widget.DateMath.MONTH:case YAHOO.widget.DateMath.DAY:case YAHOO.widget.DateMath.YEAR:case YAHOO.widget.DateMath.WEEK:return P.apply(YAHOO.widget.DateMath,arguments);break;case YAHOO.widget.DateMath.HOUR:var U=R.getHours()+S;var Q=0;if(U<0){while(U<0){U+=24;Q-=1}}if(U>24){while(U>24){U-=24;Q+=1}}YAHOO.widget.DateMath._addDays(R,Q);R.setHours(U);break;case YAHOO.widget.DateMath.MINUTE:R.setMinutes(R.getMinutes()+S);break;case YAHOO.widget.DateMath.SECOND:R.setMinutes(R.getSeconds()+S)}return R}}()}this.render()},onInteractionEvent:function e(S,P){var R,Q;if(typeof(S.event)==="object"&&typeof(S.target)==="object"){Q=S.event;R=S.target}else{Q=S;R=E.getTarget(Q)}if(Q.type==="mouseover"){if(k.test(R,"div."+this.dragGroup)){F.addClass(R,"highlight");if(this.options.permitToCreateEvents){if(!F.hasClass(R,"disabled")){R.appendChild(this.addButton)}}}}else{if(Q.type==="mouseout"){if(k.test(R,"div."+this.dragGroup)){F.addClass(R,"highlight")}}else{if(Q.type==="click"){if(k.test(R,"a#collapseTriggerLink")){this.toggleEarlyTableRows();E.preventDefault(Q)}else{if(k.test(R,"button#addEventButton")||k.test(R.offsetParent,"button#addEventButton")||k.test(R,"a.addEvent")){this.showAddDialog();E.preventDefault(Q)}else{if(k.test(R,"a.summary")||k.test(R,"div.yui-dt-liner")){this.showDialog(Q,R)}else{if(k.test(R,"li.moreEvents a")){this.onShowMore(Q,P,R)}else{if(k.test(R,"a.showMore")){this.expandDescription(R);E.preventDefault(Q)}else{if(k.test(R,"a.showLess")){this.collapseDescription(R);E.preventDefault(Q)}else{if(k.test(R,"a.deleteAction")){this.deleteDialog(Q,R)}else{if(k.test(R,"a.editAction")){this.editDialog(Q,R)}}}}}}}}}}}},onTodayNav:function r(){var P=new Date();var Q=Alfresco.util.getQueryStringParameters();Q.date=P.getFullYear()+"-"+Alfresco.CalendarHelper.padZeros((~~(1*(P.getMonth())))+1)+"-"+Alfresco.CalendarHelper.padZeros(P.getDate());window.location=window.location.href.split("?")[0]+Alfresco.util.toQueryString(Q)},onViewChanged:function K(){var Q=Alfresco.util.getQueryStringParameters(),P=window.location.hash;dateBookmark=P.substring(P.indexOf("date=")+5).split("&")[0];Q.view=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarToolbar").enabledViews[arguments[1][1].activeView];if(dateBookmark!==""){Q.date=dateBookmark}window.location=window.location.href.split("?")[0].split("#")[0]+Alfresco.util.toQueryString(Q)},onCalSelect:function s(S,R){var Q=R[1].date;var T=Alfresco.util.getQueryStringParameters();T.date=t(Q,"yyyy-mm-dd");var P=window.location.href.split("?")[0]+Alfresco.util.toQueryString(T);window.location=P},onTagSelected:function p(S,P){var Q=arguments[1][1].tagname,R=false;if(Q==Alfresco.util.message("label.all-tags","Alfresco.TagComponent")){this.options.tag=null}else{this.options.tag=Q}this.updateTitle();this.getEvents()},onFormValidationError:function c(Q,P){P=P[1];Alfresco.util.PopupManager.displayMessage({text:P.msg})},onEventEdited:function f(P,Q){this.getEvents();YAHOO.Bubbling.fire("eventEditedAfter")},onEventSaved:function C(Q){this.getEvents();var P=YAHOO.lang.JSON.parse(Q.serverResponse.responseText);if(!P.error){YAHOO.Bubbling.fire("eventSavedAfter");this.displayMessage("message.created.success",this.name)}else{this.onEventSaveFailed()}},onEventSaveFailed:function v(){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.created.failure",this.name)})},onEventDeleted:function M(){this.getEvents();YAHOO.Bubbling.fire("eventDeletedAfter");this.msg("message.deleted.success",this.name)},onAfterEventSaved:function b(Q,P){this.refreshTags();this.displayMessage("message.created.success",this.name)},onAfterEventDeleted:function m(Q,P){this.refreshTags();this.displayMessage("message.deleted.success",this.name)},onAfterEventEdited:function m(Q,P){this.refreshTags()},refreshTags:function g(){YAHOO.lang.later(500,YAHOO.Bubbling,"fire","tagRefresh")},updateTitle:function G(){return},tagFilter:function I(U){var R=[],T=this.options.tag;if(!T){return U}else{for(var S=0,P=U.length;S<P;S++){var Q=U[S].tags;if(typeof(Q)==="string"){Q=Q.split(" ")}if(Alfresco.util.arrayContains(Q,T)){R.push(U[S])}}return R}}});Alfresco.CalendarView.VIEWTYPE_WEEK="week";Alfresco.CalendarView.VIEWTYPE_MONTH="month";Alfresco.CalendarView.VIEWTYPE_DAY="day";Alfresco.CalendarView.VIEWTYPE_AGENDA="agenda"})();Alfresco.CalendarHelper=(function Alfresco_CalendarHelper(){var a=YAHOO.util.Dom,s=YAHOO.util.Event,t=YAHOO.util.Selector,g=Alfresco.util.fromISO8601,i=Alfresco.util.toISO8601,o=Alfresco.thirdparty.dateFormat;var f=[];return{getEndDate:function b(u,x){var v=Alfresco.util.fromISO8601(u);for(var w in x){v=YAHOO.widget.DateMath.add(v,(w==="M")?YAHOO.widget.DateMath.MINUTE:w,(~~(1*x[w])))}return Alfresco.util.toISO8601(v).split("+")[0]},determineHourSegment:function n(v,z){var A=a.getRegion(z);var B=v[1];var u=Math.round((A.bottom-A.top)/2);var x=(!a.getPreviousSibling(z));var w=a.getAncestorByTagName(z,"tr").getElementsByTagName("h2")[0].innerHTML;if(x===true){w=(B-A.top<u)?w:w.replace(":00",":15")}else{w=(B-A.top<u)?w.replace(":00",":30"):w.replace(":00",":45")}return w},getDuration:function h(z,v){var y=v.getTime()-z.getTime();var w={};var x="P";var y=new Date();y.setTime(Math.abs(v.getTime()-z.getTime()));var u=y.getTime();w[YAHOO.widget.DateMath.WEEK]=Math.floor(u/(1000*60*60*24*7));u-=w[YAHOO.widget.DateMath.WEEK]*(1000*60*60*24*7);w[YAHOO.widget.DateMath.DAY]=(Math.floor(u/(1000*60*60*24)));u-=w[YAHOO.widget.DateMath.DAY]*(1000*60*60*24);w[YAHOO.widget.DateMath.HOUR]=Math.floor(u/(1000*60*60));u-=w[YAHOO.widget.DateMath.HOUR]*(1000*60*60);w[YAHOO.widget.DateMath.MINUTE]=Math.floor(u/(1000*60));u-=w[YAHOO.widget.DateMath.MINUTE]*(1000*60);w[YAHOO.widget.DateMath.SECOND]=Math.floor(u/1000);u-=w[YAHOO.widget.DateMath.SECOND]*1000;if(w[YAHOO.widget.DateMath.WEEK]>0){x+=w[YAHOO.widget.DateMath.WEEK]+YAHOO.widget.DateMath.WEEK}if(w[YAHOO.widget.DateMath.DAY]>0){x+=w[YAHOO.widget.DateMath.DAY]+YAHOO.widget.DateMath.DAY}x+="T";if(w[YAHOO.widget.DateMath.HOUR]>0){x+=w[YAHOO.widget.DateMath.HOUR]+YAHOO.widget.DateMath.HOUR}if(w[YAHOO.widget.DateMath.MINUTE]>0){x+=w[YAHOO.widget.DateMath.MINUTE]+"M"}if(w[YAHOO.widget.DateMath.SECOND]>0){x+=w[YAHOO.widget.DateMath.SECOND]+YAHOO.widget.DateMath.SECOND}return x},padZeros:function r(u){return(u<10)?"0"+u:u},getDateFromField:function d(v){var u=v.title;var w=(u!=="")?g(u):new Date();return w},writeDateToField:function p(u,v){var w=o(u,Alfresco.util.message("date-format.fullDate"));v.value=w;v.title=i(u)},addTemplate:function j(u,v){f[u]=v},getTemplate:function m(u){return f[u]},renderTemplate:function c(u,x){var w=document.createElement("div");if(f[u]&&w){var w=YAHOO.lang.isString(w)?a.get(w):w;var v=f[u];var y=document.createElement("div");if(x){v=YAHOO.lang.substitute(v,x)}y.innerHTML=v;w.appendChild(y.firstChild);return w.lastChild}},isValidDate:function k(v,u){return v.getTime()<u.getTime()},isSameDay:function q(v,u){if(typeof(v)==="string"){v=g(v)}if(typeof(u)==="string"){u=g(u)}return(v.getDate()===u.getDate()&&v.getMonth()===u.getMonth()&&v.getFullYear()===u.getFullYear())},isBefore:function l(v,u){if(typeof(v)==="string"){v=g(v)}if(typeof(u)==="string"){u=g(u)}return(v<u)},isAllDay:function e(v){var w=this.isSameDay(v.from,v.to);var u=(v.end==v.start&&"00:00")?true:false;return(!w&&u)}}})();Alfresco.CalendarHelper.addTemplate("vevent",'<{el} class="vevent {allday} {hidden} {isoutlook} theme-bg-color-1 theme-border-2"> <{contEl}><p class="dates"><span class="dtstart" title="{from}">{start}</span> - <span class="dtend" title="{to}">{end}</span></p><p class="description">{desc}</p><a class="summary theme-color-1" href="{uri}">{name}</a><span class="location">{where}</span><span class="duration" title="{duration}">{duration}</span><span class="category">{tags}</span></{contEl}></{el}>');Alfresco.CalendarHelper.addTemplate("agendaDay","<h2>{date}</h2>");Alfresco.CalendarHelper.addTemplate("agendaDayItem",'<li class="vevent"><span>{start} - {end}</span><a href="{uri}" class="summary">{name}</a></li>');Alfresco.CalendarHelper.addTemplate("createEventButton",'<button id="addEventButton"><img src="{addEventUrl}" alt="{addEvent}" /></button>');Alfresco.CalendarHelper.addTemplate("taggedTitle",'<span class="tagged">{taggedWith} <span class="theme-color-2">\'{tag}\'</span></span>');