<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/regnumReservationExecution">
    <process id="regnumReservationExecution" name="Резервирование регистрационного номера">
        <extensionElements>
            <activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
                <activiti:field name="script">
                    <activiti:string><![CDATA[
						reservationWorkflow2.setReservationActive(bpm_package, true);
					]]></activiti:string>
                </activiti:field>
            </activiti:executionListener>
            <activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
                <activiti:field name="script">
                    <activiti:string><![CDATA[
						reservationWorkflow2.setReservationActive(bpm_package, false);
					]]></activiti:string>
                </activiti:field>
            </activiti:executionListener>
        </extensionElements>
        <startEvent id="startevent1" name="Start" activiti:formKey="lecmRegnumRes:startTask"></startEvent>

        <receiveTask id="receivetask1" name="Receive Task"></receiveTask>

        <serviceTask id="emptyScripttask1" name="Empty Script Task 1" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
            <extensionElements>
                <activiti:field name="script">
                    <activiti:string><![CDATA[
                    	var emptyServiceTask = "Service task";
                    ]]></activiti:string>
                </activiti:field>
            </extensionElements>
        </serviceTask>

        <serviceTask id="searchRegistrarsScripttask" name="Search registrars" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
            <extensionElements>
                <activiti:field name="script">
                    <activiti:string><![CDATA[
						var registrars = reservationWorkflow2.getRegistrars(bpm_package, "DA_REGISTRARS");
						var reservateInitiator = reservationWorkflow2.getCurrentEmployee();
						execution.setVariableLocal("registrarsList", registrars);
						execution.setVariableLocal("reservateInitiator", reservateInitiator);

                        var document = bpm_package.children[0];
                        var logText = "#initiator отправил документ #mainobject на резервирование регистрационных данных";
                        businessJournal.log(document.nodeRef.toString(), "RESERVATION", logText, []);
					]]></activiti:string>
                </activiti:field>
            </extensionElements>
        </serviceTask>

        <exclusiveGateway id="exclusiveGw" name="Check registars amount" />

        <userTask id="regnumReservationTask" name="Резервирование" activiti:assignee="${assignee.properties.userName}" activiti:formKey="lecmRegnumRes:reserveTask">
            <extensionElements>
                <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
                    <activiti:field name="script">
                        <activiti:string><![CDATA[
							reservationWorkflow2.assignTask(assignee, task);
						]]></activiti:string>
                    </activiti:field>
                </activiti:taskListener>
                <activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
                    <activiti:field name="script">
                        <activiti:string><![CDATA[
							reservationWorkflow2.reassignTask(assignee, task);
							var document, employee;
							document = bpm_package.children[0];
							employee = orgstructure.getEmployeeByLogin(assignee.properties['cm:userName']);
							lecmPermission.grantDynamicRole(document, employee, 'LECM_REGISTRAR_DYN', 'LECM_BASIC_PG_Employee');
						]]></activiti:string>
                    </activiti:field>
                </activiti:taskListener>
                <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
                    <activiti:field name="script">
                        <activiti:string><![CDATA[
							reservationWorkflow2.completeTask(assignee, task);
							reservationWorkflow2.notifyReservationFinished(bpm_package, task);
							var document, employee;
							document = bpm_package.children[0];
							employee = orgstructure.getEmployeeByLogin(assignee.properties['cm:userName']);
  							lecmPermission.revokeDynamicRole(document, employee, 'LECM_REGISTRAR_DYN');
  							documentMembers.addMemberWithoutCheckPermission(document, employee, 'LECM_BASIC_PG_Reader', true);
						]]></activiti:string>
                    </activiti:field>
                </activiti:taskListener>
            </extensionElements>
            <multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${registrarsList}" activiti:elementVariable="assignee">
                <completionCondition>${"REJECTED" == taskDecision || "RESERVED" == taskDecision}</completionCondition>
            </multiInstanceLoopCharacteristics>
        </userTask>

        <serviceTask id="emptyRegistrarsList" name="Processing empty registrars list" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
            <extensionElements>
                <activiti:field name="script">
                    <activiti:string><![CDATA[
						reservationWorkflow2.setEmptyRegnum(bpm_package);
						var reservateInitiator = execution.getVariableLocal("reservateInitiator");
						notifications.sendNotification({
							recipients: [reservateInitiator],
							templateCode: 'RESERVATION_EMPTY_REGISTRARS',
							templateConfig: {
								mainObject: bpm_package.children[0]
							}
						});
					]]></activiti:string>
                </activiti:field>
            </extensionElements>
        </serviceTask>

        <sequenceFlow id="flow1" sourceRef="startevent1" targetRef="emptyScripttask1"></sequenceFlow>
        <sequenceFlow id="flow2" sourceRef="emptyScripttask1" targetRef="receivetask1"></sequenceFlow>
        <sequenceFlow id="flow3" sourceRef="receivetask1" targetRef="searchRegistrarsScripttask"></sequenceFlow>
        <sequenceFlow id="flow4" sourceRef="searchRegistrarsScripttask" targetRef="exclusiveGw"></sequenceFlow>
        <sequenceFlow id="flow5" sourceRef="exclusiveGw" targetRef="regnumReservationTask">
            <conditionExpression xsi:type="tFormalExpression">${registrarsList.size() > 0}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow6" sourceRef="exclusiveGw" targetRef="emptyRegistrarsList">
            <conditionExpression xsi:type="tFormalExpression">${registrarsList.size() == 0}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow7" sourceRef="regnumReservationTask" targetRef="endevent1"> </sequenceFlow>
        <sequenceFlow id="flow8" sourceRef="emptyRegistrarsList" targetRef="endevent1"> </sequenceFlow>
        <endEvent id="endevent1" name="End"></endEvent>
    </process>
</definitions>