<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
			 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			 xmlns:activiti="http://activiti.org/bpmn"
			 xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
			 xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
			 xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
			 typeLanguage="http://www.w3.org/2001/XMLSchema"
			 expressionLanguage="http://www.w3.org/1999/XPath"
			 targetNamespace="http://www.it.ru/logicECM/workflow/review">

	<process id="lecmReview" name="Ознакомление" isExecutable="true">
		<extensionElements>
			<activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string><![CDATA[
						review.deleteAssigneesListWorkingCopy(execution);
					]]></activiti:string>
				</activiti:field>
			</activiti:executionListener>
		</extensionElements>
		<startEvent id="start-review" name="Start review" activiti:formKey="lecmReview:review"></startEvent>
		<serviceTask id="empty-service-task" name="Service task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
                    	var emptyServiceTask = "Service task";
                    ]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="from-start-to-empty-service-task" sourceRef="start-review" targetRef="empty-service-task"></sequenceFlow>
		<receiveTask id="receivetask" name="Receive Task"></receiveTask>
		<sequenceFlow id="from-empty-service-task-to-receivetask" sourceRef="empty-service-task" targetRef="receivetask"></sequenceFlow>
		<serviceTask id="create-result-list" name="Create result list" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var assignees = execution.getVariable("lecm-workflow_assigneesListAssoc");
						var assigneesList = review.createAssigneesList(assignees, execution);
						execution.setVariableLocal("assigneesList", assigneesList);
						var resultListRef = review.createResultList(bpm_package, documentAttachmentCategoryName, assigneesList);
						execution.setVariable("resultListRef", resultListRef);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="from-create-result-list-to-parallel-review-tsk" sourceRef="create-result-list" targetRef="parallel-review-task"></sequenceFlow>
		<userTask id="parallel-review-task" name="Ознакомиться с документом"
				  activiti:assignee='${assignee.properties["{http://www.it.ru/logicECM/model/workflow/1.0}userName"]}'
				  activiti:formKey="lecmReview:reviewTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							review.actualizeTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							var currentAssignee = '' + task.getAssignee();
							var previousAssignee = '' + task.getVariableLocal('previousAssignee');
							if (previousAssignee != currentAssignee) {
								task.setVariableLocal('previousAssignee', currentAssignee);
								if (previousAssignee && previousAssignee != 'null') {
									review.reassignTask(assignee, task);
								} else {
									var dueDate = bpm_workflowDueDate;
									task.setDueDate(dueDate);
									review.assignTask(assignee, task);
								}
							}
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string><![CDATA[
							review.completeTask(assignee, task);
						]]></activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
			<multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${assigneesList}" activiti:elementVariable="assignee"></multiInstanceLoopCharacteristics>
		</userTask>
		<boundaryEvent id="parallel-timer" name="Parallel Timer" attachedToRef="parallel-review-task" cancelActivity="false">
			<timerEventDefinition>
				<timeCycle>0 0 0/4 * * ?</timeCycle>
			</timerEventDefinition>
		</boundaryEvent>
		<serviceTask id="sheduled-notification" name="Notify task" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var workflowId = "activiti$" + execution.getProcessInstanceId();
						review.notifyDeadlineTasks(workflowId, bpm_package, execution);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<serviceTask id="log-final-decision" name="Log final decision" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var resultListRef = execution.getVariable("resultListRef");
						review.logWorkflowFinished(resultListRef);
						review.notifyWorkflowFinished(bpm_package)
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
		<sequenceFlow id="from-parallel-timer-to-notify" sourceRef="parallel-timer" targetRef="sheduled-notification"></sequenceFlow>
		<sequenceFlow id="from-parallel-to-log-final-decision" sourceRef="parallel-review-task" targetRef="log-final-decision"></sequenceFlow>
		<sequenceFlow id="from-log-final-decision-to-workflowEnd" sourceRef="log-final-decision" targetRef="workflowEnd"></sequenceFlow>
		<endEvent id="workflowEnd" name="End"></endEvent>
		<exclusiveGateway id="review-control" name="Review Control"></exclusiveGateway>
		<sequenceFlow id="from-receive-task-to-review-control" sourceRef="receivetask" targetRef="review-control"></sequenceFlow>
		<sequenceFlow id="from-review-control-to-create-result-list" sourceRef="review-control" targetRef="create-result-list">
			<conditionExpression xsi:type="tFormalExpression">${lecmReview_noReviewControl == false}</conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="from-review-control-to-send-bare-notifications-task" sourceRef="review-control" targetRef="send-bare-notifications-task">
			<conditionExpression xsi:type="tFormalExpression">${lecmReview_noReviewControl == true}</conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="from-send-bare-notifications-task-to-workflowEnd" sourceRef="send-bare-notifications-task" targetRef="workflowEnd"></sequenceFlow>

		<serviceTask id="send-bare-notifications-task" name="Send bare notifications" activiti:class="org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate">
			<extensionElements>
				<activiti:field name="script">
					<activiti:string><![CDATA[
						var assignees = execution.getVariable("lecm-workflow_assigneesListAssoc");
						var assigneesList = review.createAssigneesList(assignees, execution);
						review.sendBareNotifications(assigneesList, bpm_workflowDueDate, bpm_package);
					]]></activiti:string>
				</activiti:field>
			</extensionElements>
		</serviceTask>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_lecmReview">
		<bpmndi:BPMNPlane bpmnElement="lecmReview" id="BPMNPlane_lecmReview">
			<bpmndi:BPMNShape bpmnElement="sheduled-notification" id="BPMNShape_sheduled-notification">
				<omgdc:Bounds height="60.0" width="100.0" x="595.0" y="127.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="parallel-review-task" id="BPMNShape_parallel-review-task">
				<omgdc:Bounds height="60.0" width="100.0" x="590.0" y="34.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="workflowEnd" id="BPMNShape_workflowEnd">
				<omgdc:Bounds height="35.0" width="35.0" x="875.0" y="47.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="create-result-list" id="BPMNShape_create-result-list">
				<omgdc:Bounds height="60.0" width="100.0" x="450.0" y="34.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="parallel-timer" id="BPMNShape_parallel-timer">
				<omgdc:Bounds height="30.0" width="30.0" x="630.0" y="74.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="log-final-decision" id="BPMNShape_log-final-decision">
				<omgdc:Bounds height="60.0" width="100.0" x="740.0" y="34.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="start-review" id="BPMNShape_start-review">
				<omgdc:Bounds height="35.0" width="35.0" x="0.0" y="46.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="receivetask" id="BPMNShape_receivetask">
				<omgdc:Bounds height="60.0" width="100.0" x="230.0" y="34.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="empty-service-task" id="BPMNShape_empty-service-task">
				<omgdc:Bounds height="60.0" width="100.0" x="80.0" y="34.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="review-control" id="BPMNShape_review-control">
				<omgdc:Bounds height="40.0" width="40.0" x="370.0" y="43.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="send-bare-notifications-task" id="BPMNShape_send-bare-notifications-task">
				<omgdc:Bounds height="55.0" width="105.0" x="592.0" y="219.0"></omgdc:Bounds>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="from-start-to-empty-service-task" id="BPMNEdge_from-start-to-empty-service-task">
				<omgdi:waypoint x="35.0" y="63.0"></omgdi:waypoint>
				<omgdi:waypoint x="80.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-create-result-list-to-parallel-review-tsk" id="BPMNEdge_from-create-result-list-to-parallel-review-tsk">
				<omgdi:waypoint x="550.0" y="64.0"></omgdi:waypoint>
				<omgdi:waypoint x="590.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-parallel-to-log-final-decision" id="BPMNEdge_from-parallel-to-log-final-decision">
				<omgdi:waypoint x="690.0" y="64.0"></omgdi:waypoint>
				<omgdi:waypoint x="740.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-empty-service-task-to-receivetask" id="BPMNEdge_from-empty-service-task-to-receivetask">
				<omgdi:waypoint x="180.0" y="64.0"></omgdi:waypoint>
				<omgdi:waypoint x="230.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-parallel-timer-to-notify" id="BPMNEdge_from-parallel-timer-to-notify">
				<omgdi:waypoint x="645.0" y="104.0"></omgdi:waypoint>
				<omgdi:waypoint x="645.0" y="127.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-log-final-decision-to-workflowEnd" id="BPMNEdge_from-log-final-decision-to-workflowEnd">
				<omgdi:waypoint x="840.0" y="64.0"></omgdi:waypoint>
				<omgdi:waypoint x="875.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-receive-task-to-review-control" id="BPMNEdge_from-receive-task-to-review-control">
				<omgdi:waypoint x="330.0" y="64.0"></omgdi:waypoint>
				<omgdi:waypoint x="370.0" y="63.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-review-control-to-create-result-list" id="BPMNEdge_from-review-control-to-create-result-list">
				<omgdi:waypoint x="410.0" y="63.0"></omgdi:waypoint>
				<omgdi:waypoint x="450.0" y="64.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-review-control-to-send-bare-notifications-task" id="BPMNEdge_from-review-control-to-send-bare-notifications-task">
				<omgdi:waypoint x="390.0" y="83.0"></omgdi:waypoint>
				<omgdi:waypoint x="390.0" y="247.0"></omgdi:waypoint>
				<omgdi:waypoint x="592.0" y="246.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="from-send-bare-notifications-task-to-workflowEnd" id="BPMNEdge_from-send-bare-notifications-task-to-workflowEnd">
				<omgdi:waypoint x="697.0" y="246.0"></omgdi:waypoint>
				<omgdi:waypoint x="892.0" y="247.0"></omgdi:waypoint>
				<omgdi:waypoint x="892.0" y="82.0"></omgdi:waypoint>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>
